{"version":3,"names":["cov_ogsd5x3bm","actualCoverage","defineUserAbilities","s","injectCaslAbility","request","reply","f","user","b","code","send","status","message","ability","requireCaslAbility","action","subject","cannot","requireAnyCaslAbility","actions","hasAnyAbility","some","can","requireAllCaslAbilities","hasAllAbilities","every"],"sources":["casl.middleware.js"],"sourcesContent":["import { defineUserAbilities } from \"../config/casl.js\";\n\n/**\n * Middleware to inject CASL abilities into the request object\n * This middleware should be used after authentication middleware\n */\nexport const injectCaslAbility = async (request, reply) => {\n  // Check if user is authenticated\n  if (!request.user) {\n    return reply.code(401).send({\n      status: 401,\n      message: \"Access denied. Authentication required.\",\n    });\n  }\n\n  // Create and attach user abilities\n  request.ability = defineUserAbilities(request.user);\n};\n\n/**\n * Middleware to check if user can perform a specific action on a subject\n * @param {string} action - The action to check (e.g., 'read', 'create', 'update', 'delete')\n * @param {string} subject - The subject to check (e.g., 'Patient', 'User')\n */\nexport const requireCaslAbility = (action, subject) => {\n  return async (request, reply) => {\n    // Check if user is authenticated\n    if (!request.user) {\n      return reply.code(401).send({\n        status: 401,\n        message: \"Access denied. Authentication required.\",\n      });\n    }\n\n    // Ensure abilities are available\n    if (!request.ability) {\n      request.ability = defineUserAbilities(request.user);\n    }\n\n    // Check if user has the required ability\n    if (request.ability.cannot(action, subject)) {\n      return reply.code(403).send({\n        status: 403,\n        message: \"Access denied. Insufficient permissions.\",\n      });\n    }\n  };\n};\n\n/**\n * Middleware to check if user can perform any of the specified actions on a subject\n * @param {Array} actions - Array of actions to check\n * @param {string} subject - The subject to check\n */\nexport const requireAnyCaslAbility = (actions, subject) => {\n  return async (request, reply) => {\n    // Check if user is authenticated\n    if (!request.user) {\n      return reply.code(401).send({\n        status: 401,\n        message: \"Access denied. Authentication required.\",\n      });\n    }\n\n    // Ensure abilities are available\n    if (!request.ability) {\n      request.ability = defineUserAbilities(request.user);\n    }\n\n    // Check if user has any of the required abilities\n    const hasAnyAbility = actions.some((action) =>\n      request.ability.can(action, subject)\n    );\n\n    if (!hasAnyAbility) {\n      return reply.code(403).send({\n        status: 403,\n        message: \"Access denied. Insufficient permissions.\",\n      });\n    }\n  };\n};\n\n/**\n * Middleware to check if user can perform all of the specified actions on a subject\n * @param {Array} actions - Array of actions to check\n * @param {string} subject - The subject to check\n */\nexport const requireAllCaslAbilities = (actions, subject) => {\n  return async (request, reply) => {\n    // Check if user is authenticated\n    if (!request.user) {\n      return reply.code(401).send({\n        status: 401,\n        message: \"Access denied. Authentication required.\",\n      });\n    }\n\n    // Ensure abilities are available\n    if (!request.ability) {\n      request.ability = defineUserAbilities(request.user);\n    }\n\n    // Check if user has all of the required abilities\n    const hasAllAbilities = actions.every((action) =>\n      request.ability.can(action, subject)\n    );\n\n    if (!hasAllAbilities) {\n      return reply.code(403).send({\n        status: 403,\n        message: \"Access denied. Insufficient permissions.\",\n      });\n    }\n  };\n};\n\nexport default {\n  injectCaslAbility,\n  requireCaslAbility,\n  requireAnyCaslAbility,\n  requireAllCaslAbilities,\n};\n"],"mappings":"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","ignoreList":[]}