{"version":3,"names":["cov_2dn8f82l17","actualCoverage","logger","MailService","welcomeEmailHtml","welcomeEmailText","passwordResetEmailHtml","passwordResetEmailText","notificationEmailHtml","notificationEmailText","s","sendEmailJob","data","f","to","subject","body","html","text","template","templateData","info","emailHtml","emailText","b","warn","result","send","messageId","success","error","message","sendPasswordResetEmailJob","email","name","resetToken","expiresInMinutes","appUrl","process","env","APP_URL","resetUrl","sendWelcomeEmailJob","loginUrl","supportEmail","SUPPORT_EMAIL","sendNotificationEmailJob","title","type","action","details","recipientName"],"sources":["SendEmailJob.js"],"sourcesContent":["import { logger } from '../utils/logger.js';\nimport MailService from '../services/MailService.js';\nimport { welcomeEmailHtml, welcomeEmailText } from '../templates/email/welcome.template.js';\nimport { passwordResetEmailHtml, passwordResetEmailText } from '../templates/email/password-reset.template.js';\nimport { notificationEmailHtml, notificationEmailText } from '../templates/email/notification.template.js';\n\n/**\n * Generic email job handler\n * Sends emails using the configured mail transporter\n */\nexport const sendEmailJob = async (data) => {\n    const { to, subject, body, html, text, template, templateData } = data;\n\n    logger.info('Processing email job:', { to, subject });\n\n    try {\n        let emailHtml = html;\n        let emailText = text || body;\n\n        // If a template is specified, generate HTML/text from template\n        if (template) {\n            switch (template) {\n                case 'welcome':\n                    emailHtml = welcomeEmailHtml(templateData);\n                    emailText = welcomeEmailText(templateData);\n                    break;\n                case 'password-reset':\n                    emailHtml = passwordResetEmailHtml(templateData);\n                    emailText = passwordResetEmailText(templateData);\n                    break;\n                case 'notification':\n                    emailHtml = notificationEmailHtml(templateData);\n                    emailText = notificationEmailText(templateData);\n                    break;\n                default:\n                    logger.warn(`Unknown template: ${template}, using raw content`);\n            }\n        }\n\n        const result = await MailService.send({\n            to,\n            subject,\n            text: emailText,\n            html: emailHtml\n        });\n\n        logger.info('Email sent successfully:', { to, subject, messageId: result.messageId });\n        return { success: true, to, subject, messageId: result.messageId };\n    } catch (error) {\n        logger.error('Failed to send email:', { to, subject, error: error.message });\n        throw error;\n    }\n};\n\n/**\n * Password reset email job handler\n * Sends a password reset email with a secure reset link\n */\nexport const sendPasswordResetEmailJob = async (data) => {\n    const { email, name, resetToken, expiresInMinutes = 60 } = data;\n\n    logger.info('Sending password reset email to:', email);\n\n    try {\n        const appUrl = process.env.APP_URL || 'http://localhost:3000';\n        const resetUrl = `${appUrl}/auth/reset-password?token=${resetToken}`;\n\n        const templateData = {\n            name: name || 'User',\n            email,\n            resetUrl,\n            expiresInMinutes\n        };\n\n        const result = await MailService.send({\n            to: email,\n            subject: 'Reset Your Password - Chartwarden',\n            text: passwordResetEmailText(templateData),\n            html: passwordResetEmailHtml(templateData)\n        });\n\n        logger.info('Password reset email sent:', { email, messageId: result.messageId });\n        return { success: true, email, messageId: result.messageId };\n    } catch (error) {\n        logger.error('Failed to send password reset email:', { email, error: error.message });\n        throw error;\n    }\n};\n\n/**\n * Welcome email job handler\n * Sends a welcome email to new users after registration\n */\nexport const sendWelcomeEmailJob = async (data) => {\n    const { email, name } = data;\n\n    logger.info('Sending welcome email to:', name, email);\n\n    try {\n        const templateData = {\n            name: name || 'User',\n            email,\n            loginUrl: process.env.APP_URL || 'http://localhost:3000',\n            supportEmail: process.env.SUPPORT_EMAIL || 'support@chartwarden.com'\n        };\n\n        const result = await MailService.send({\n            to: email,\n            subject: 'Welcome to Chartwarden',\n            text: welcomeEmailText(templateData),\n            html: welcomeEmailHtml(templateData)\n        });\n\n        logger.info('Welcome email sent:', { email, name, messageId: result.messageId });\n        return { success: true, email, name, messageId: result.messageId };\n    } catch (error) {\n        logger.error('Failed to send welcome email:', { email, name, error: error.message });\n        throw error;\n    }\n};\n\n/**\n * General notification email job handler\n * Sends notification emails for various system events\n */\nexport const sendNotificationEmailJob = async (data) => {\n    const { to, title, message, type = 'info', action, details, recipientName } = data;\n\n    logger.info('Sending notification email:', { to, title });\n\n    try {\n        const templateData = {\n            title,\n            message,\n            type,\n            action,\n            details,\n            recipientName\n        };\n\n        const result = await MailService.send({\n            to,\n            subject: title,\n            text: notificationEmailText(templateData),\n            html: notificationEmailHtml(templateData)\n        });\n\n        logger.info('Notification email sent:', { to, title, messageId: result.messageId });\n        return { success: true, to, title, messageId: result.messageId };\n    } catch (error) {\n        logger.error('Failed to send notification email:', { to, title, error: error.message });\n        throw error;\n    }\n};\n"],"mappings":"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","ignoreList":[]}