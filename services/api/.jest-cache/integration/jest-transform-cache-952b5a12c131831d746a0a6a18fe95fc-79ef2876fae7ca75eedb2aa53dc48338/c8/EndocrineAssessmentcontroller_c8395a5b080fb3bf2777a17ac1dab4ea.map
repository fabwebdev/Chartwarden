{"version":3,"names":["cov_17mwowlqb7","actualCoverage","db","endocrine_assessment","endocrine","eq","logger","EndocrineAssessmentController","index","request","reply","f","s","endocrineAssessments","select","id","patient_id","endocrine_ids","createdAt","updatedAt","from","code","error","message","endocrineList","name","store","body","b","existingAssessments","where","limit","existingAssessment","endocrineIdsString","Array","isArray","join","result","now","Date","update","set","returning","insert","values","data","show","params","endocrineAssessment","parseInt"],"sources":["EndocrineAssessment.controller.js"],"sourcesContent":["import { db } from \"../../config/db.drizzle.js\";\nimport { endocrine_assessment } from \"../../db/schemas/endocrineAssessment.schema.js\";\nimport { endocrine } from \"../../db/schemas/endocrine.schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nimport { logger } from '../../utils/logger.js';\nclass EndocrineAssessmentController {\n    // Get all endocrine assessments\n    async index(request, reply) {\n        try {\n            const endocrineAssessments = await db.select({\n                id: endocrine_assessment.id,\n                patient_id: endocrine_assessment.patient_id,\n                endocrine_ids: endocrine_assessment.endocrine_ids,\n                createdAt: endocrine_assessment.createdAt,\n                updatedAt: endocrine_assessment.updatedAt,\n            }).from(endocrine_assessment);\n            reply.code(200);\n            return endocrineAssessments;\n        } catch (error) {\n            logger.error(\"Error fetching endocrine assessments:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Get all endocrine options\n    async endocrineList(request, reply) {\n        try {\n            const endocrineList = await db.select({\n                id: endocrine.id,\n                name: endocrine.name,\n                createdAt: endocrine.createdAt,\n                updatedAt: endocrine.updatedAt,\n            }).from(endocrine);\n            reply.code(200);\n            return endocrineList;\n        } catch (error) {\n            logger.error(\"Error fetching endocrine list:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Store or update endocrine assessment\n    async store(request, reply) {\n        try {\n            const { patient_id, endocrine_ids } = request.body;\n\n            // Validate required fields\n            if (!patient_id) {\n                reply.code(400);\n            return {\n                    message: \"Patient ID is required\",\n                };\n            }\n\n            if (!endocrine_ids) {\n                reply.code(400);\n            return {\n                    message: \"Endocrine IDs are required\",\n                };\n            }\n\n            // Check if endocrine assessment already exists for this patient\n            const existingAssessments = await db.select({ id: endocrine_assessment.id }).from(endocrine_assessment).where(eq(endocrine_assessment.patient_id, patient_id)).limit(1);\n            const existingAssessment = existingAssessments[0];\n\n            // Convert endocrine_ids array to comma-separated string\n            const endocrineIdsString = Array.isArray(endocrine_ids)\n                ? endocrine_ids.join(\",\")\n                : endocrine_ids;\n\n            let result;\n            const now = new Date();\n            \n            if (existingAssessment) {\n                // Update existing endocrine assessment\n                result = await db.update(endocrine_assessment)\n                    .set({ \n                        endocrine_ids: endocrineIdsString,\n                        updatedAt: now\n                    })\n                    .where(eq(endocrine_assessment.patient_id, patient_id))\n                    .returning();\n                result = result[0];\n            } else {\n                // Create new endocrine assessment\n                result = await db.insert(endocrine_assessment).values({\n                    patient_id: patient_id,\n                    endocrine_ids: endocrineIdsString,\n                    createdAt: now,\n                    updatedAt: now,\n                }).returning();\n                result = result[0];\n            }\n\n            reply.code(201);\n            return {\n                message: \"Endocrine assessment created or updated successfully\",\n                data: result,\n            };\n        } catch (error) {\n            logger.error(\"Error storing endocrine assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Show endocrine assessment for a specific patient\n    // Returns empty data if no assessment exists (to allow frontend to render form)\n    async show(request, reply) {\n        try {\n            const { id } = request.params;\n\n            const endocrineAssessments = await db.select({\n                id: endocrine_assessment.id,\n                patient_id: endocrine_assessment.patient_id,\n                endocrine_ids: endocrine_assessment.endocrine_ids,\n                createdAt: endocrine_assessment.createdAt,\n                updatedAt: endocrine_assessment.updatedAt,\n            }).from(endocrine_assessment).where(eq(endocrine_assessment.patient_id, id)).limit(1);\n            const endocrineAssessment = endocrineAssessments[0];\n\n            if (!endocrineAssessment) {\n                // Return 200 with empty data instead of 404, so frontend can render form\n                reply.code(200);\n                return {\n                    id: null,\n                    patient_id: parseInt(id),\n                    endocrine_ids: \"\",\n                    createdAt: null,\n                    updatedAt: null,\n                };\n            }\n\n            reply.code(200);\n            return endocrineAssessment;\n        } catch (error) {\n            logger.error(\"Error fetching endocrine assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n}\n\nexport default new EndocrineAssessmentController();"],"mappings":"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","ignoreList":[]}