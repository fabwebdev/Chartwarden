{"version":3,"names":["cov_2lm29shz8t","actualCoverage","pgTable","bigint","varchar","text","timestamp","index","pgEnum","users","sessions","auditLogStatusEnum","s","audit_logs","id","mode","primaryKey","generatedByDefaultAsIdentity","user_id","references","f","onDelete","onUpdate","session_id","request_id","length","action","notNull","resource_type","resource_id","old_value","new_value","status","default","ip_address","user_agent","metadata","created_at","defaultNow","table","userIdx","on","sessionIdx","requestIdx","actionIdx","resourceTypeIdx","resourceIdx","statusIdx","createdAtIdx","userTimeIdx","resourceHistoryIdx","actionResourceIdx","timeActionIdx","statusTimeIdx","sessionTimeIdx"],"sources":["auditLog.schema.js"],"sourcesContent":["import { pgTable, bigint, varchar, text, timestamp, index, pgEnum } from 'drizzle-orm/pg-core';\nimport { users } from './user.schema.js';\nimport { sessions } from './session.schema.js';\n\n/**\n * Audit Log Status Enum\n * Tracks the outcome of audited operations for HIPAA compliance\n */\nexport const auditLogStatusEnum = pgEnum('audit_log_status', ['success', 'failure', 'pending']);\n\n/**\n * Immutable Audit Log Schema\n *\n * HIPAA Compliance Requirements:\n * - All access to PHI must be logged\n * - Logs must be tamper-evident (immutable - no updates allowed)\n * - Logs must be retained for minimum 6 years\n * - Must track who, what, when, where, and outcome\n *\n * 21 CFR Part 11 Compliance:\n * - Electronic records must have audit trails\n * - Must capture user ID, timestamp, and action\n * - Must be linked to electronic signatures where applicable\n */\nexport const audit_logs = pgTable('audit_logs', {\n  // Primary key - auto-incrementing for sequential ordering\n  id: bigint('id', { mode: 'number' }).primaryKey().generatedByDefaultAsIdentity(),\n\n  // User identification - who performed the action\n  user_id: text('user_id').references(() => users.id, { onDelete: 'set null', onUpdate: 'cascade' }),\n\n  // Session tracking - links to user session for traceability\n  session_id: text('session_id').references(() => sessions.id, { onDelete: 'set null', onUpdate: 'cascade' }),\n\n  // Request correlation - unique identifier for distributed tracing\n  request_id: varchar('request_id', { length: 36 }),\n\n  // Action type - what operation was performed (CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, etc.)\n  action: varchar('action', { length: 255 }).notNull(),\n\n  // Resource identification - what was accessed/modified\n  resource_type: varchar('resource_type', { length: 255 }).notNull(), // renamed from table_name for clarity\n  resource_id: text('resource_id'), // changed to text to support various ID formats (UUIDs, nanoids, etc.)\n\n  // Change tracking - before and after states (JSON stringified)\n  old_value: text('old_value'), // Previous state of the resource\n  new_value: text('new_value'), // New state of the resource\n\n  // Operation status - outcome of the action\n  status: auditLogStatusEnum('status').notNull().default('success'),\n\n  // Network context - where the request originated\n  ip_address: varchar('ip_address', { length: 45 }), // IPv6 max length is 45 chars\n  user_agent: text('user_agent'), // Changed to text - user agents can be long\n\n  // Additional context (JSON) - flexible field for extra metadata\n  metadata: text('metadata'),\n\n  // Immutable timestamp - when the action occurred\n  // NOTE: No updated_at column - audit logs are immutable and should never be modified\n  created_at: timestamp('created_at').defaultNow().notNull(),\n}, (table) => ({\n  // Performance indexes for audit_logs table (HIPAA-compliant audit queries)\n\n  // Single column indexes for frequently queried columns\n  userIdx: index('idx_audit_logs_user_id').on(table.user_id),\n  sessionIdx: index('idx_audit_logs_session_id').on(table.session_id),\n  requestIdx: index('idx_audit_logs_request_id').on(table.request_id),\n  actionIdx: index('idx_audit_logs_action').on(table.action),\n  resourceTypeIdx: index('idx_audit_logs_resource_type').on(table.resource_type),\n  resourceIdx: index('idx_audit_logs_resource_id').on(table.resource_id),\n  statusIdx: index('idx_audit_logs_status').on(table.status),\n  createdAtIdx: index('idx_audit_logs_created_at').on(table.created_at),\n\n  // Composite indexes for common audit query patterns\n\n  // User activity queries - \"show all actions by user X in time range\"\n  userTimeIdx: index('idx_audit_logs_user_time')\n    .on(table.user_id, table.created_at),\n\n  // Resource history queries - \"show all changes to patient #123\"\n  resourceHistoryIdx: index('idx_audit_logs_resource_history')\n    .on(table.resource_type, table.resource_id, table.created_at),\n\n  // Action analysis queries - \"show all DELETE actions on patients table\"\n  actionResourceIdx: index('idx_audit_logs_action_resource')\n    .on(table.action, table.resource_type),\n\n  // Time-based audit queries - \"show all actions in last 24 hours\"\n  timeActionIdx: index('idx_audit_logs_time_action')\n    .on(table.created_at, table.action),\n\n  // Status-based queries - \"show all failed operations\"\n  statusTimeIdx: index('idx_audit_logs_status_time')\n    .on(table.status, table.created_at),\n\n  // Session-based queries - \"show all actions in session X\"\n  sessionTimeIdx: index('idx_audit_logs_session_time')\n    .on(table.session_id, table.created_at),\n}));"],"mappings":"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","ignoreList":[]}