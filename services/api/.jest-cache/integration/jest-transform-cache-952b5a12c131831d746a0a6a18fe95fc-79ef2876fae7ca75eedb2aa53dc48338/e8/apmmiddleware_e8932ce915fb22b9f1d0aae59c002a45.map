{"version":3,"names":["cov_1ekgxie8pw","actualCoverage","apmService","s","apmPreHandler","request","reply","f","apmStartTime","process","hrtime","bigint","apmResponseHandler","b","endTime","durationNs","Number","durationMs","url","startsWith","recordRequest","apmErrorHandler","error","apmHooks","onRequest","onResponse","onError"],"sources":["apm.middleware.js"],"sourcesContent":["/**\n * APM Middleware\n *\n * Provides automatic performance monitoring for:\n * - API request/response times with percentile tracking\n * - Request throughput and error rates\n * - Payload size monitoring\n *\n * Designed for minimal overhead (< 5% performance impact)\n *\n * HIPAA Compliance: Only tracks performance metrics,\n * never logs actual health data or PHI.\n */\n\nimport apmService from '../services/APM.service.js';\n\n/**\n * Pre-handler hook to capture request start time\n * This should be registered early in the hook chain\n */\nexport const apmPreHandler = async (request, reply) => {\n  // Use high-resolution timer for accurate measurements\n  request.apmStartTime = process.hrtime.bigint();\n};\n\n/**\n * Response hook to record request metrics\n * This should be registered as an onResponse hook\n */\nexport const apmResponseHandler = async (request, reply) => {\n  // Skip if start time wasn't captured\n  if (!request.apmStartTime) {\n    return;\n  }\n\n  // Calculate duration in milliseconds\n  const endTime = process.hrtime.bigint();\n  const durationNs = Number(endTime - request.apmStartTime);\n  const durationMs = durationNs / 1000000;\n\n  // Skip health check endpoints to avoid noise\n  if (request.url.startsWith('/api/health') ||\n      request.url.startsWith('/health') ||\n      request.url === '/') {\n    return;\n  }\n\n  // Record the request in APM service\n  apmService.recordRequest(request, reply, durationMs);\n};\n\n/**\n * Error handler hook to track errors\n */\nexport const apmErrorHandler = async (error, request, reply) => {\n  // Record error timing if available\n  if (request.apmStartTime) {\n    const endTime = process.hrtime.bigint();\n    const durationNs = Number(endTime - request.apmStartTime);\n    const durationMs = durationNs / 1000000;\n\n    // Record as a failed request (reply.statusCode will be the error code)\n    apmService.recordRequest(request, reply, durationMs);\n  }\n};\n\n/**\n * Create APM hooks object for Fastify registration\n * Usage: fastify.addHook('onRequest', apmHooks.onRequest)\n */\nexport const apmHooks = {\n  onRequest: apmPreHandler,\n  onResponse: apmResponseHandler,\n  onError: apmErrorHandler,\n};\n\nexport default apmHooks;\n"],"mappings":"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","ignoreList":[]}