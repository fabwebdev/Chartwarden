{"version":3,"names":["cov_1dgnvvcnvt","actualCoverage","dotenv","eq","and","auth","db","users","roles","user_has_roles","logger","s","config","sanitize","value","f","b","trimmed","trim","length","createAdminUser","email","password","name","firstName","lastName","normalizedEmail","normalizedPassword","Error","displayName","filter","Boolean","join","existingUsers","select","from","where","limit","signupResponse","api","signUpEmail","body","headers","cookies","authError","error","message","includes","userId","user","id","update","set","role","emailVerified","updatedAt","Date","adminRole","roleId","existingAssignment","user_id","role_id","insert","values","import","meta","url","process","argv","cliEmail","cliPassword","cliName","then","result","info","exit","catch"],"sources":["createAdminUser.js"],"sourcesContent":["import dotenv from \"dotenv\";\nimport { eq, and } from \"drizzle-orm\";\n\nimport auth from \"../config/betterAuth.js\";\nimport { db } from \"../config/db.drizzle.js\";\nimport { users, roles, user_has_roles } from \"../db/schemas/index.js\";\n\nimport { logger } from './logger.js';\ndotenv.config();\n\nfunction sanitize(value) {\n  if (!value || typeof value !== \"string\") return null;\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : null;\n}\n\nexport default async function createAdminUser(\n  email,\n  password,\n  name,\n  firstName,\n  lastName\n) {\n  const normalizedEmail = sanitize(email);\n  const normalizedPassword = password?.trim();\n\n  if (!normalizedEmail) {\n    throw new Error(\"Email is required\");\n  }\n\n  if (!normalizedPassword) {\n    throw new Error(\"Password is required\");\n  }\n\n  // Validate password length before calling Better Auth\n  // Better Auth requires minimum 12 characters (HIPAA requirement)\n  if (normalizedPassword.length < 12) {\n    throw new Error(\n      `Password must be at least 12 characters long (HIPAA requirement). Current length: ${normalizedPassword.length}`\n    );\n  }\n\n  const displayName =\n    sanitize(name) ||\n    [sanitize(firstName), sanitize(lastName)].filter(Boolean).join(\" \") ||\n    \"Admin User\";\n\n  const existingUsers = await db\n    .select()\n    .from(users)\n    .where(eq(users.email, normalizedEmail))\n    .limit(1);\n\n  if (existingUsers.length > 0) {\n    throw new Error(\"User with this email already exists. Use a unique email.\");\n  }\n\n  let signupResponse;\n  try {\n    signupResponse = await auth.api.signUpEmail({\n      body: {\n        email: normalizedEmail,\n        password: normalizedPassword,\n        name: displayName,\n      },\n      headers: {},\n      cookies: {},\n    });\n  } catch (authError) {\n    // Handle Better Auth validation errors\n    logger.error(\"Better Auth signup error:\", authError);\n    \n    // Check for password validation errors\n    if (authError.message?.includes(\"too short\") || authError.message?.includes(\"Password is too short\")) {\n      throw new Error(\n        \"Password must be at least 12 characters long (HIPAA requirement)\"\n      );\n    }\n    \n    // Re-throw other errors with context\n    throw new Error(\n      `Failed to create user via Better Auth: ${authError.message || \"Unknown error\"}`\n    );\n  }\n\n  const userId = signupResponse?.user?.id;\n\n  if (!userId) {\n    throw new Error(\"Failed to create user via Better Auth: No user ID returned\");\n  }\n\n  await db\n    .update(users)\n    .set({\n      name: displayName,\n      firstName: sanitize(firstName),\n      lastName: sanitize(lastName),\n      // Don't overwrite password - Better Auth already hashed it correctly during signUpEmail\n      role: \"admin\",\n      emailVerified: true,\n      updatedAt: new Date(),\n    })\n    .where(eq(users.id, userId));\n\n  const adminRole = await db\n    .select()\n    .from(roles)\n    .where(eq(roles.name, \"admin\"))\n    .limit(1);\n\n  if (adminRole.length === 0) {\n    throw new Error(\"Admin role not found in the database\");\n  }\n\n  const roleId = adminRole[0].id;\n\n  const existingAssignment = await db\n    .select()\n    .from(user_has_roles)\n    .where(\n      and(\n        eq(user_has_roles.user_id, userId),\n        eq(user_has_roles.role_id, roleId)\n      )\n    )\n    .limit(1);\n\n  if (existingAssignment.length === 0) {\n    await db.insert(user_has_roles).values({\n      user_id: userId,\n      role_id: roleId,\n    });\n  }\n\n  return {\n    id: userId,\n    email: normalizedEmail,\n    name: displayName,\n    role: \"admin\",\n  };\n}\n\nif (import.meta.url === `file://${process.argv[1]}`) {\n  const [, , cliEmail, cliPassword, cliName] = process.argv;\n\n  createAdminUser(cliEmail, cliPassword, cliName)\n    .then((result) => {\n      logger.info(\"Admin user created:\", result)\n      process.exit(0);\n    })\n    .catch((error) => {\n      logger.error(\"Failed to create admin user:\", error)\n      process.exit(1);\n    });\n}\n"],"mappings":"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","ignoreList":[]}