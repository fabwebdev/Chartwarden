{"version":3,"names":["cov_1s62bxqtph","actualCoverage","db","spiritual_preference","eq","logger","SpiritualPreferenceController","index","request","reply","f","s","spiritualPreferences","select","id","patient_id","patient_spiritual","not_religious","comments","createdAt","updatedAt","from","code","error","message","store","body","b","existingPreferences","where","limit","existingPreference","now","Date","spiritualPreferenceData","undefined","result","update","set","returning","insert","values","data","show","params","spiritualPreferenceRecord","parseInt"],"sources":["SpiritualPreference.controller.js"],"sourcesContent":["import { db } from \"../../config/db.drizzle.js\";\nimport { spiritual_preference } from \"../../db/schemas/spiritualPreference.schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nimport { logger } from '../../utils/logger.js';\nclass SpiritualPreferenceController {\n    // Get all spiritual preferences\n    async index(request, reply) {\n        try {\n            const spiritualPreferences = await db.select({\n                id: spiritual_preference.id,\n                patient_id: spiritual_preference.patient_id,\n                patient_spiritual: spiritual_preference.patient_spiritual,\n                not_religious: spiritual_preference.not_religious,\n                comments: spiritual_preference.comments,\n                createdAt: spiritual_preference.createdAt,\n                updatedAt: spiritual_preference.updatedAt\n            }).from(spiritual_preference);\n            reply.code(200);\n            return spiritualPreferences;\n        } catch (error) {\n            logger.error(\"Error fetching spiritual preferences:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Store or update spiritual preference\n    async store(request, reply) {\n        try {\n            const { patient_id, patient_spiritual, not_religious, comments } =\n                request.body;\n\n            // Validate required fields\n            if (!patient_id) {\n                reply.code(400);\n            return {\n                    message: \"Patient ID is required\",\n                };\n            }\n\n            // Check if spiritual preference already exists for this patient\n            const existingPreferences = await db.select({\n                id: spiritual_preference.id\n            }).from(spiritual_preference).where(eq(spiritual_preference.patient_id, patient_id)).limit(1);\n            const existingPreference = existingPreferences[0];\n\n            // Prepare data for update or create\n            const now = new Date();\n            const spiritualPreferenceData = {\n                patient_id: patient_id,\n                patient_spiritual: patient_spiritual || null,\n                not_religious:\n                    not_religious !== undefined ? not_religious : null,\n                comments: comments || null,\n            };\n\n            let result;\n            if (existingPreference) {\n                // Update existing spiritual preference\n                spiritualPreferenceData.updatedAt = now;\n                result = await db.update(spiritual_preference).set(spiritualPreferenceData).where(eq(spiritual_preference.patient_id, patient_id)).returning();\n                result = result[0];\n            } else {\n                // Create new spiritual preference\n                spiritualPreferenceData.createdAt = now;\n                spiritualPreferenceData.updatedAt = now;\n                result = await db.insert(spiritual_preference).values(spiritualPreferenceData).returning();\n                result = result[0];\n            }\n\n            reply.code(201);\n            return {\n                message: \"Spiritual Preference créé ou mis à jour avec succès.\",\n                data: result,\n            };\n        } catch (error) {\n            logger.error(\"Error saving spiritual preference:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Show spiritual preference for a specific patient\n    // Returns empty data if no preference exists (to allow frontend to render form)\n    async show(request, reply) {\n        try {\n            const { id } = request.params;\n\n            const spiritualPreferences = await db.select({\n                id: spiritual_preference.id,\n                patient_id: spiritual_preference.patient_id,\n                patient_spiritual: spiritual_preference.patient_spiritual,\n                not_religious: spiritual_preference.not_religious,\n                comments: spiritual_preference.comments,\n                createdAt: spiritual_preference.createdAt,\n                updatedAt: spiritual_preference.updatedAt\n            }).from(spiritual_preference).where(eq(spiritual_preference.patient_id, id)).limit(1);\n            const spiritualPreferenceRecord = spiritualPreferences[0];\n\n            if (!spiritualPreferenceRecord) {\n                // Return 200 with empty data instead of 404, so frontend can render form\n                reply.code(200);\n                return {\n                    id: null,\n                    patient_id: parseInt(id),\n                    patient_spiritual: null,\n                    not_religious: null,\n                    comments: null,\n                    createdAt: null,\n                    updatedAt: null,\n                };\n            }\n\n            reply.code(200);\n            return spiritualPreferenceRecord;\n        } catch (error) {\n            logger.error(\"Error fetching spiritual preference:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n}\n\nexport default new SpiritualPreferenceController();"],"mappings":"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","ignoreList":[]}