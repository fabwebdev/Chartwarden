{"version":3,"names":["cov_ooz6sdt0a","actualCoverage","db","hematological_assessment","hematological","eq","logger","HematologicalAssessmentController","index","request","reply","f","s","hematologicalAssessments","select","id","patient_id","hematological_ids","createdAt","updatedAt","from","code","error","message","hematologicalList","name","store","body","b","existingAssessments","where","limit","existingAssessment","hematologicalIdsString","Array","isArray","join","result","now","Date","update","set","returning","insert","values","data","show","params","hematologicalAssessment","parseInt"],"sources":["HematologicalAssessment.controller.js"],"sourcesContent":["import { db } from \"../../config/db.drizzle.js\";\nimport { hematological_assessment } from \"../../db/schemas/hematologicalAssessment.schema.js\";\nimport { hematological } from \"../../db/schemas/hematological.schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nimport { logger } from '../../utils/logger.js';\nclass HematologicalAssessmentController {\n    // Get all hematological assessments\n    async index(request, reply) {\n        try {\n            const hematologicalAssessments = await db.select({\n                id: hematological_assessment.id,\n                patient_id: hematological_assessment.patient_id,\n                hematological_ids: hematological_assessment.hematological_ids,\n                createdAt: hematological_assessment.createdAt,\n                updatedAt: hematological_assessment.updatedAt,\n            }).from(hematological_assessment);\n            reply.code(200);\n            return hematologicalAssessments;\n        } catch (error) {\n            logger.error(\"Error fetching hematological assessments:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Get all hematological options\n    async hematologicalList(request, reply) {\n        try {\n            const hematologicalList = await db.select({\n                id: hematological.id,\n                name: hematological.name,\n                createdAt: hematological.createdAt,\n                updatedAt: hematological.updatedAt,\n            }).from(hematological);\n            reply.code(200);\n            return hematologicalList;\n        } catch (error) {\n            logger.error(\"Error fetching hematological list:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Store or update hematological assessment\n    async store(request, reply) {\n        try {\n            const { patient_id, hematological_ids } = request.body;\n\n            // Validate required fields\n            if (!patient_id) {\n                reply.code(400);\n            return {\n                    message: \"Patient ID is required\",\n                };\n            }\n\n            if (!hematological_ids) {\n                reply.code(400);\n            return {\n                    message: \"Hematological IDs are required\",\n                };\n            }\n\n            // Check if hematological assessment already exists for this patient\n            const existingAssessments = await db.select({ id: hematological_assessment.id }).from(hematological_assessment).where(eq(hematological_assessment.patient_id, patient_id)).limit(1);\n            const existingAssessment = existingAssessments[0];\n\n            // Convert hematological_ids array to comma-separated string\n            const hematologicalIdsString = Array.isArray(hematological_ids)\n                ? hematological_ids.join(\",\")\n                : hematological_ids;\n\n            let result;\n            const now = new Date();\n            if (existingAssessment) {\n                // Update existing hematological assessment\n                result = await db.update(hematological_assessment)\n                    .set({ \n                        hematological_ids: hematologicalIdsString,\n                        updatedAt: now\n                    })\n                    .where(eq(hematological_assessment.patient_id, patient_id))\n                    .returning();\n                result = result[0];\n            } else {\n                // Create new hematological assessment\n                result = await db.insert(hematological_assessment).values({\n                    patient_id: patient_id,\n                    hematological_ids: hematologicalIdsString,\n                    createdAt: now,\n                    updatedAt: now,\n                }).returning();\n                result = result[0];\n            }\n\n            reply.code(201);\n            return {\n                message: \"Hematological assessment created or updated successfully\",\n                data: result,\n            };\n        } catch (error) {\n            logger.error(\"Error storing hematological assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Show hematological assessment for a specific patient\n    // Returns empty data if no assessment exists (to allow frontend to render form)\n    async show(request, reply) {\n        try {\n            const { id } = request.params;\n\n            const hematologicalAssessments = await db.select({\n                id: hematological_assessment.id,\n                patient_id: hematological_assessment.patient_id,\n                hematological_ids: hematological_assessment.hematological_ids,\n                createdAt: hematological_assessment.createdAt,\n                updatedAt: hematological_assessment.updatedAt,\n            }).from(hematological_assessment).where(eq(hematological_assessment.patient_id, id)).limit(1);\n            const hematologicalAssessment = hematologicalAssessments[0];\n\n            if (!hematologicalAssessment) {\n                // Return 200 with empty data instead of 404, so frontend can render form\n                reply.code(200);\n                return {\n                    id: null,\n                    patient_id: parseInt(id),\n                    hematological_ids: \"\",\n                    createdAt: null,\n                    updatedAt: null,\n                };\n            }\n\n            reply.code(200);\n            return hematologicalAssessment;\n        } catch (error) {\n            logger.error(\"Error fetching hematological assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n}\n\nexport default new HematologicalAssessmentController();"],"mappings":"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","ignoreList":[]}