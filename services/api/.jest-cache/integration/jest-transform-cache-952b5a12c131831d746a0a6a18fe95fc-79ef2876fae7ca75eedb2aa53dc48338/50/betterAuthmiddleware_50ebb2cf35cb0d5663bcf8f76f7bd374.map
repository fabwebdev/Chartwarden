{"version":3,"names":["cov_2fvf0hqmmr","actualCoverage","auth","fromNodeHeaders","ROLES","db","users","user_has_roles","roles","eq","debug","info","warn","error","s","authenticate","request","reply","f","sessionToken","cookies","hasCookie","cookieCount","Object","keys","b","length","session","api","getSession","headers","err","message","code","detail","hint","includes","send","status","process","env","NODE_ENV","undefined","sessions","dbSession","select","from","where","token","limit","foundInDB","dbError","fullUser","user","dbUser","id","email","firstName","lastName","userFetchError","betterAuthSession","userRoles","user_id","roleRecords","role_id","role","name","PATIENT","roleError","method","path","url","details","stack","verifyToken","optionalAuth"],"sources":["betterAuth.middleware.js"],"sourcesContent":["import auth from \"../config/betterAuth.js\";\nimport { fromNodeHeaders } from \"better-auth/node\";\nimport { ROLES } from \"../config/rbac.js\";\nimport { db } from \"../config/db.drizzle.js\";\nimport { users, user_has_roles, roles } from \"../db/schemas/index.js\";\nimport { eq } from \"drizzle-orm\";\n\nimport { debug, info, warn, error } from '../utils/logger.js';\n/**\n * Middleware to protect routes with Better Auth session validation\n * Replaces the old JWT authentication middleware\n */\nexport const authenticate = async (request, reply) => {\n  try {\n    // Debug: Log cookies received\n    const sessionToken = request.cookies?.[\"better-auth.session_token\"];\n    debug(\"Authentication attempt\", {\n      hasCookie: !!sessionToken,\n      cookieCount: Object.keys(request.cookies || {}).length,\n    });\n\n    // Get session from Better Auth\n    let session;\n    try {\n      session = await auth.api.getSession({\n        headers: fromNodeHeaders(request.headers),\n        cookies: request.cookies,\n      });\n    } catch (err) {\n      error(\"Better Auth getSession error\", {\n        message: err.message,\n        code: err.code,\n        detail: err.detail,\n        hint: err.hint,\n      });\n\n      // If it's a table not found error, provide helpful message\n      if (err.message?.includes(\"does not exist\") || err.code === \"42P01\") {\n        warn(\"Database table error detected. Check if sessions table exists in public schema.\");\n      }\n\n      return reply.code(500).send({\n        status: 500,\n        message: \"Server error during session validation.\",\n        error:\n          process.env.NODE_ENV === \"development\" ? err.message : undefined,\n      });\n    }\n\n    if (!session) {\n      // Debug: Check if session exists in database\n      if (sessionToken) {\n        try {\n          const { db } = await import(\"../config/db.drizzle.js\");\n          const { sessions } = await import(\"../db/schemas/index.js\");\n          const { eq } = await import(\"drizzle-orm\");\n\n          const dbSession = await db\n            .select()\n            .from(sessions)\n            .where(eq(sessions.token, sessionToken))\n            .limit(1);\n\n          warn(\"Better Auth cannot read session, but DB has record\", {\n            foundInDB: dbSession.length > 0,\n          });\n        } catch (dbError) {\n          error(\"Error checking database session\", dbError);\n        }\n      }\n\n      return reply.code(401).send({\n        status: 401,\n        message: \"Access denied. No valid session found.\",\n      });\n    }\n\n    debug(\"Session found for authenticated user\");\n\n    // Fetch full user record from database to get firstName and lastName\n    let fullUser = session.user;\n    try {\n      const dbUser = await db\n        .select()\n        .from(users)\n        .where(eq(users.id, session.user.id))\n        .limit(1);\n\n      if (dbUser.length > 0) {\n        // Merge Better Auth user data with database user data (including firstName and lastName)\n        // Use database email as-is (it should have original case if stored correctly)\n        // Better Auth stores lowercase, but we'll use what's in database\n        fullUser = {\n          ...session.user,\n          email: dbUser[0].email, // Use email from database (may have original case)\n          firstName: dbUser[0].firstName || null,\n          lastName: dbUser[0].lastName || null,\n        };\n      }\n    } catch (userFetchError) {\n      error(\"Error fetching user details from database\", userFetchError);\n      // Continue with session.user if database fetch fails\n    }\n\n    // Add user info to request object\n    request.user = fullUser;\n    request.betterAuthSession = session; // Use a different property name to avoid conflicts\n\n    // Load user's role from database\n    try {\n      // Get user roles from user_has_roles table\n      const userRoles = await db\n        .select()\n        .from(user_has_roles)\n        .where(eq(user_has_roles.user_id, session.user.id))\n        .limit(1);\n\n      if (userRoles.length > 0) {\n        // Get the role name from roles table\n        const roleRecords = await db\n          .select()\n          .from(roles)\n          .where(eq(roles.id, userRoles[0].role_id))\n          .limit(1);\n\n        if (roleRecords.length > 0) {\n          request.user.role = roleRecords[0].name; // Set actual role from database\n        } else {\n          request.user.role = ROLES.PATIENT; // Default if role not found\n        }\n      } else {\n        request.user.role = ROLES.PATIENT; // Default if no role assigned\n      }\n    } catch (roleError) {\n      error(\"Error loading user role\", roleError);\n      request.user.role = ROLES.PATIENT; // Default on error\n    }\n  } catch (err) {\n    error(\"Authentication error\", {\n      err,\n      method: request.method,\n      path: request.url,\n    });\n    return reply.code(500).send({\n      status: 500,\n      message: \"Server error during authentication.\",\n      error: err.message,\n      details: process.env.NODE_ENV === \"development\" ? err.stack : undefined,\n    });\n  }\n};\n\n// For compatibility with Laravel's verifyToken\nexport const verifyToken = authenticate;\n\n// Middleware to get optional session (for routes that can be accessed by both authenticated and unauthenticated users)\nexport const optionalAuth = async (request, reply) => {\n  try {\n    // Get session from Better Auth (if exists)\n    const session = await auth.api.getSession({\n      headers: fromNodeHeaders(request.headers),\n      cookies: request.cookies,\n    });\n\n    // Add user info to request object if session exists\n    if (session) {\n      request.user = session.user;\n      request.betterAuthSession = session; // Use a different property name to avoid conflicts\n\n      // Load user's role from database\n      try {\n        // Get user roles from user_has_roles table\n        const userRoles = await db\n          .select()\n          .from(user_has_roles)\n          .where(eq(user_has_roles.user_id, session.user.id))\n          .limit(1);\n\n        if (userRoles.length > 0) {\n          // Get the role name from roles table\n          const roleRecords = await db\n            .select()\n            .from(roles)\n            .where(eq(roles.id, userRoles[0].role_id))\n            .limit(1);\n\n          if (roleRecords.length > 0) {\n            request.user.role = roleRecords[0].name; // Set actual role from database\n          } else {\n            request.user.role = ROLES.PATIENT; // Default if role not found\n          }\n        } else {\n          request.user.role = ROLES.PATIENT; // Default if no role assigned\n        }\n      } catch (roleError) {\n        error(\"Error loading user role\", roleError);\n        request.user.role = ROLES.PATIENT; // Default on error\n      }\n    }\n  } catch (err) {\n    error(\"Optional authentication error\", err);\n    // Still continue even if there's an error, as this is optional auth\n  }\n};\n\nexport default authenticate;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}