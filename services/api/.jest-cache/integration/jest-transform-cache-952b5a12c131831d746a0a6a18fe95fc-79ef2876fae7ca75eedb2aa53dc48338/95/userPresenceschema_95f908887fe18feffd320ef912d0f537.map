{"version":3,"names":["cov_2gw27eqidw","actualCoverage","pgTable","text","varchar","timestamp","boolean","index","pgEnum","nanoid","users","presenceStatusEnum","s","user_presence","id","primaryKey","$defaultFn","f","user_id","notNull","unique","references","onDelete","status","default","status_message","length","socket_id","is_connected","last_seen_at","defaultNow","last_active_at","typing_in_room_id","user_agent","ip_address","created_at","updated_at","table","userIdIdx","on","statusIdx","isConnectedIdx","activeOnlineIdx","typingIdx","lastSeenIdx","presence_history","old_status","new_status","session_started_at","session_ended_at","createdAtIdx","userTimeIdx"],"sources":["userPresence.schema.js"],"sourcesContent":["import {\n  pgTable,\n  text,\n  varchar,\n  timestamp,\n  boolean,\n  index,\n  pgEnum\n} from 'drizzle-orm/pg-core';\nimport { nanoid } from 'nanoid';\nimport { users } from './user.schema.js';\n\n/**\n * User Presence Status Enum\n * Defines the online/offline status for real-time chat presence tracking\n */\nexport const presenceStatusEnum = pgEnum('presence_status', [\n  'online',      // User is actively connected\n  'away',        // User is idle/inactive for extended period\n  'busy',        // User is online but marked as busy/do not disturb\n  'offline'      // User is disconnected\n]);\n\n/**\n * User Presence Schema\n *\n * Tracks real-time online/offline status for team chat functionality.\n * Used for displaying user availability in chat rooms and presence indicators.\n *\n * HIPAA Compliance Considerations:\n * - Presence data should be retained for audit purposes (who was online when)\n * - Status changes should be logged for accountability\n * - Connection tracking helps with session management and security\n */\nexport const user_presence = pgTable('user_presence', {\n  // Primary key\n  id: text('id')\n    .primaryKey()\n    .$defaultFn(() => nanoid()),\n\n  // User association\n  user_id: text('user_id')\n    .notNull()\n    .unique()\n    .references(() => users.id, { onDelete: 'cascade' }),\n\n  // Presence status\n  status: presenceStatusEnum('status').notNull().default('offline'),\n\n  // Custom status message (optional)\n  status_message: varchar('status_message', { length: 255 }), // \"In a meeting\", \"On break\", etc.\n\n  // Connection tracking\n  socket_id: varchar('socket_id', { length: 255 }), // Current socket connection ID\n  is_connected: boolean('is_connected').default(false).notNull(),\n\n  // Activity tracking\n  last_seen_at: timestamp('last_seen_at').defaultNow().notNull(), // Last activity timestamp\n  last_active_at: timestamp('last_active_at').defaultNow().notNull(), // Last interaction timestamp\n\n  // Typing indicators (room-specific)\n  typing_in_room_id: text('typing_in_room_id'), // Reference to chat room where user is typing\n\n  // Session metadata\n  user_agent: text('user_agent'), // Browser/device info for security\n  ip_address: varchar('ip_address', { length: 45 }), // IPv4 or IPv6 for audit\n\n  // Timestamps\n  created_at: timestamp('created_at').defaultNow().notNull(),\n  updated_at: timestamp('updated_at').defaultNow().notNull(),\n}, (table) => ({\n  // Index for finding online users\n  userIdIdx: index('idx_user_presence_user_id').on(table.user_id),\n\n  // Index for filtering by status\n  statusIdx: index('idx_user_presence_status').on(table.status),\n\n  // Index for finding connected users\n  isConnectedIdx: index('idx_user_presence_is_connected').on(table.is_connected),\n\n  // Composite index for active online users\n  activeOnlineIdx: index('idx_user_presence_active_online')\n    .on(table.is_connected, table.status, table.last_active_at),\n\n  // Index for typing indicators\n  typingIdx: index('idx_user_presence_typing').on(table.typing_in_room_id),\n\n  // Index for last seen queries\n  lastSeenIdx: index('idx_user_presence_last_seen').on(table.last_seen_at),\n}));\n\n/**\n * Presence History Schema\n *\n * Audit trail for presence status changes.\n * Maintains HIPAA-compliant history of when users were online/offline.\n */\nexport const presence_history = pgTable('presence_history', {\n  // Primary key\n  id: text('id')\n    .primaryKey()\n    .$defaultFn(() => nanoid()),\n\n  // User association\n  user_id: text('user_id')\n    .notNull()\n    .references(() => users.id, { onDelete: 'cascade' }),\n\n  // Status change tracking\n  old_status: presenceStatusEnum('old_status').notNull(),\n  new_status: presenceStatusEnum('new_status').notNull(),\n\n  // Session information\n  socket_id: varchar('socket_id', { length: 255 }),\n  user_agent: text('user_agent'),\n  ip_address: varchar('ip_address', { length: 45 }),\n\n  // Session duration (for analytics)\n  session_started_at: timestamp('session_started_at'),\n  session_ended_at: timestamp('session_ended_at'),\n\n  // Timestamp\n  created_at: timestamp('created_at').defaultNow().notNull(),\n}, (table) => ({\n  // Index for user history queries\n  userIdIdx: index('idx_presence_history_user_id').on(table.user_id),\n\n  // Index for time-based queries\n  createdAtIdx: index('idx_presence_history_created_at').on(table.created_at),\n\n  // Composite index for user timeline\n  userTimeIdx: index('idx_presence_history_user_time')\n    .on(table.user_id, table.created_at),\n}));\n"],"mappings":"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","ignoreList":[]}