{"version":3,"names":["cov_1dotubw5du","actualCoverage","db","signature","eq","logger","SignatureController","index","request","reply","f","s","signatures","select","id","patient_id","signature_name","createdAt","updatedAt","from","code","error","message","store","body","b","patientIdNum","parseInt","isNaN","existingSignatures","where","limit","existingSignature","result","now","Date","update","set","returning","insert","values","data","show","params","patientId","signatureRecord","delete","status"],"sources":["Signature.controller.js"],"sourcesContent":["import { db } from \"../../config/db.drizzle.js\";\nimport { signature } from \"../../db/schemas/signature.schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nimport { logger } from '../../utils/logger.js';\nclass SignatureController {\n    // Get all signatures\n    async index(request, reply) {\n        try {\n            const signatures = await db.select({\n                id: signature.id,\n                patient_id: signature.patient_id,\n                signature_name: signature.signature_name,\n                createdAt: signature.createdAt,\n                updatedAt: signature.updatedAt\n            }).from(signature);\n            reply.code(200);\n            return signatures;\n        } catch (error) {\n            logger.error(\"Error fetching signatures:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n    // Store or update signature\n    async store(request, reply) {\n        try {\n            const { patient_id, signature_name } = request.body;\n\n            // Validate required fields\n            if (!patient_id) {\n                reply.code(400);\n                return {\n                    message: \"Patient ID is required\",\n                };\n            }\n\n            // signature_name is optional (can be null to clear signature)\n\n            // Convert patient_id to number\n            const patientIdNum = typeof patient_id === 'string' ? parseInt(patient_id) : patient_id;\n            if (isNaN(patientIdNum)) {\n                reply.code(400);\n                return {\n                    message: \"Invalid patient ID\",\n                };\n            }\n\n            // Check if signature already exists for this patient\n            const existingSignatures = await db.select({\n                id: signature.id\n            }).from(signature).where(eq(signature.patient_id, patientIdNum)).limit(1);\n            const existingSignature = existingSignatures[0];\n\n            let result;\n            const now = new Date();\n            \n            if (existingSignature) {\n                // Update existing signature\n                result = await db.update(signature).set({\n                    signature_name: signature_name,\n                    updatedAt: now,\n                }).where(eq(signature.patient_id, patientIdNum)).returning();\n                result = result[0];\n            } else {\n                // Create new signature\n                result = await db.insert(signature).values({\n                    patient_id: patientIdNum,\n                    signature_name: signature_name,\n                    createdAt: now,\n                    updatedAt: now,\n                }).returning();\n                result = result[0];\n            }\n\n            reply.code(201);\n            return {\n                message: \"Signature créée ou mise à jour avec succès.\",\n                data: result,\n            };\n        } catch (error) {\n            logger.error(\"Error saving signature:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Show signature for a specific patient\n    // Returns empty data if no signature exists (to allow frontend to render form)\n    async show(request, reply) {\n        try {\n            const { id } = request.params;\n            const patientId = parseInt(id);\n\n            if (isNaN(patientId)) {\n                reply.code(400);\n                return {\n                    error: \"Invalid patient ID\",\n                };\n            }\n\n            const signatures = await db.select({\n                id: signature.id,\n                patient_id: signature.patient_id,\n                signature_name: signature.signature_name,\n                createdAt: signature.createdAt,\n                updatedAt: signature.updatedAt\n            }).from(signature).where(eq(signature.patient_id, patientId)).limit(1);\n            const signatureRecord = signatures[0];\n\n            if (!signatureRecord) {\n                // Return 200 with empty data instead of 404, so frontend can render form\n                reply.code(200);\n                return {\n                    id: null,\n                    patient_id: patientId,\n                    signature_name: null,\n                    createdAt: null,\n                    updatedAt: null,\n                };\n            }\n\n            reply.code(200);\n            return signatureRecord;\n        } catch (error) {\n            logger.error(\"Error fetching signature:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Delete a specific signature\n    async delete(request, reply) {\n        try {\n            const { id } = request.params;\n\n            // First find the signature\n            const signatures = await db.select({\n                id: signature.id\n            }).from(signature).where(eq(signature.id, id)).limit(1);\n            const signatureRecord = signatures[0];\n\n            if (!signatureRecord) {\n                reply.code(404);\n            return {\n                    message: \"La signature n'existe pas\",\n                    status: 404,\n                };\n            }\n\n            // Delete the signature\n            await db.delete(signature).where(eq(signature.id, id));\n\n            reply.code(200);\n            return {\n                message: \"Signature supprimée avec succès.\",\n                status: 200,\n            };\n        } catch (error) {\n            logger.error(\"Error deleting signature:\", error)\n            reply.code(500);\n            return {\n                message: \"Erreur lors de la suppression de la signature.\",\n                status: 500,\n                error: error.message,\n            };\n        }\n    }\n}\n\nexport default new SignatureController();"],"mappings":"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","ignoreList":[]}