{"version":3,"names":["cov_10z5yugjtl","actualCoverage","pgTable","text","varchar","timestamp","boolean","index","pgEnum","nanoid","users","roomTypeEnum","s","chat_rooms","id","primaryKey","$defaultFn","f","name","length","type","notNull","default","description","patient_id","is_archived","is_active","created_by","references","onDelete","created_at","defaultNow","updated_at","archived_at","table","typeIdx","on","createdByIdx","isActiveIdx","patientIdx","createdAtIdx","chat_messages","room_id","sender_id","content","is_edited","edited_at","is_deleted","deleted_at","reply_to_id","roomIdx","senderIdx","roomTimeIdx","roomActiveIdx","chat_participants","user_id","role","is_muted","last_read_at","last_read_message_id","joined_at","left_at","roomUserIdx","userActiveIdx"],"sources":["chat.schema.js"],"sourcesContent":["import {\n  pgTable,\n  text,\n  varchar,\n  timestamp,\n  boolean,\n  index,\n  pgEnum\n} from 'drizzle-orm/pg-core';\nimport { nanoid } from 'nanoid';\nimport { users } from './user.schema.js';\n\n/**\n * Chat Room Type Enum\n * Defines different types of chat rooms for healthcare team collaboration\n */\nexport const roomTypeEnum = pgEnum('room_type', [\n  'direct',      // One-on-one conversation between two users\n  'group',       // Group chat for team collaboration\n  'department',  // Department-wide communication\n  'patient_care' // Patient-specific care team discussion (HIPAA-sensitive)\n]);\n\n/**\n * Chat Rooms Schema\n *\n * HIPAA Compliance Considerations:\n * - Patient-related rooms must be clearly identified for audit purposes\n * - Room access must be controlled via participants table\n * - All room activity should be auditable\n */\nexport const chat_rooms = pgTable('chat_rooms', {\n  // Primary key\n  id: text('id')\n    .primaryKey()\n    .$defaultFn(() => nanoid()),\n\n  // Room identification\n  name: varchar('name', { length: 255 }), // Optional room name (null for direct chats)\n  type: roomTypeEnum('type').notNull().default('group'),\n\n  // Room metadata\n  description: text('description'), // Room purpose/description\n\n  // Patient association (for patient_care rooms)\n  patient_id: text('patient_id'), // Reference to patient if applicable\n\n  // Room settings\n  is_archived: boolean('is_archived').default(false).notNull(),\n  is_active: boolean('is_active').default(true).notNull(),\n\n  // Creator tracking\n  created_by: text('created_by')\n    .notNull()\n    .references(() => users.id, { onDelete: 'cascade' }),\n\n  // Timestamps\n  created_at: timestamp('created_at').defaultNow().notNull(),\n  updated_at: timestamp('updated_at').defaultNow().notNull(),\n  archived_at: timestamp('archived_at'),\n}, (table) => ({\n  // Indexes for performance\n  typeIdx: index('idx_chat_rooms_type').on(table.type),\n  createdByIdx: index('idx_chat_rooms_created_by').on(table.created_by),\n  isActiveIdx: index('idx_chat_rooms_is_active').on(table.is_active),\n  patientIdx: index('idx_chat_rooms_patient_id').on(table.patient_id),\n  createdAtIdx: index('idx_chat_rooms_created_at').on(table.created_at),\n}));\n\n/**\n * Chat Messages Schema\n *\n * HIPAA Compliance Requirements:\n * - All messages must be retained for audit purposes\n * - Messages in patient_care rooms contain PHI and require special handling\n * - Deletion is soft delete only (deleted_at timestamp)\n * - Message history must be tamper-evident\n */\nexport const chat_messages = pgTable('chat_messages', {\n  // Primary key\n  id: text('id')\n    .primaryKey()\n    .$defaultFn(() => nanoid()),\n\n  // Room association\n  room_id: text('room_id')\n    .notNull()\n    .references(() => chat_rooms.id, { onDelete: 'cascade' }),\n\n  // Sender information\n  sender_id: text('sender_id')\n    .notNull()\n    .references(() => users.id, { onDelete: 'cascade' }),\n\n  // Message content\n  content: text('content').notNull(), // Message text (sanitized for XSS)\n\n  // Message metadata\n  is_edited: boolean('is_edited').default(false).notNull(),\n  edited_at: timestamp('edited_at'),\n\n  // Soft delete (HIPAA compliance - never hard delete)\n  is_deleted: boolean('is_deleted').default(false).notNull(),\n  deleted_at: timestamp('deleted_at'),\n\n  // Reply/thread support (optional for future enhancement)\n  reply_to_id: text('reply_to_id').references(() => chat_messages.id, { onDelete: 'set null' }),\n\n  // Timestamps (immutable created_at for audit trail)\n  created_at: timestamp('created_at').defaultNow().notNull(),\n  updated_at: timestamp('updated_at').defaultNow().notNull(),\n}, (table) => ({\n  // Indexes for message queries\n  roomIdx: index('idx_chat_messages_room_id').on(table.room_id),\n  senderIdx: index('idx_chat_messages_sender_id').on(table.sender_id),\n  createdAtIdx: index('idx_chat_messages_created_at').on(table.created_at),\n\n  // Composite index for room message history queries\n  roomTimeIdx: index('idx_chat_messages_room_time')\n    .on(table.room_id, table.created_at),\n\n  // Index for filtering deleted messages\n  roomActiveIdx: index('idx_chat_messages_room_active')\n    .on(table.room_id, table.is_deleted, table.created_at),\n}));\n\n/**\n * Chat Room Participants Schema\n *\n * Junction table managing user membership in chat rooms\n *\n * HIPAA Compliance:\n * - Controls access to PHI in patient_care rooms\n * - Tracks when users joined/left for audit purposes\n * - Must be synchronized with ABAC policies\n */\nexport const chat_participants = pgTable('chat_participants', {\n  // Composite primary key (room_id + user_id)\n  id: text('id')\n    .primaryKey()\n    .$defaultFn(() => nanoid()),\n\n  // Room association\n  room_id: text('room_id')\n    .notNull()\n    .references(() => chat_rooms.id, { onDelete: 'cascade' }),\n\n  // User association\n  user_id: text('user_id')\n    .notNull()\n    .references(() => users.id, { onDelete: 'cascade' }),\n\n  // Participant role (for future permissions)\n  role: varchar('role', { length: 50 }).default('member').notNull(), // member, admin, moderator\n\n  // Notification preferences\n  is_muted: boolean('is_muted').default(false).notNull(),\n\n  // Read tracking\n  last_read_at: timestamp('last_read_at'),\n  last_read_message_id: text('last_read_message_id'),\n\n  // Membership status\n  is_active: boolean('is_active').default(true).notNull(),\n\n  // Timestamps\n  joined_at: timestamp('joined_at').defaultNow().notNull(),\n  left_at: timestamp('left_at'),\n\n  created_at: timestamp('created_at').defaultNow().notNull(),\n  updated_at: timestamp('updated_at').defaultNow().notNull(),\n}, (table) => ({\n  // Unique constraint for room + user combination\n  roomUserIdx: index('idx_chat_participants_room_user')\n    .on(table.room_id, table.user_id),\n\n  // Index for user's active rooms\n  userActiveIdx: index('idx_chat_participants_user_active')\n    .on(table.user_id, table.is_active),\n\n  // Index for room's active participants\n  roomActiveIdx: index('idx_chat_participants_room_active')\n    .on(table.room_id, table.is_active),\n}));\n"],"mappings":"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","ignoreList":[]}