{"version":3,"names":["cov_2h17fokuyc","actualCoverage","db","nutrition_assessment","nutrition_problems_type","nutrition_template","eq","logger","NutritionController","nutritionProblemsTypes","request","reply","f","s","select","id","name","description","createdAt","updatedAt","from","code","error","message","nutritionAssessmentShow","params","nutritionAssessments","patient_id","nutrition_problems_type_ids","nutrition_template_ids","where","limit","nutritionAssessment","b","nutritionAssessmentAutoSave","body","existingAssessments","existingAssessment","nutritionProblemsTypeIdsString","Array","isArray","join","nutritionTemplateIdsString","result","now","Date","update","set","returning","insert","values","data"],"sources":["Nutrition.controller.js"],"sourcesContent":["import { db } from \"../../config/db.drizzle.js\";\nimport { nutrition_assessment } from \"../../db/schemas/nutritionAssessment.schema.js\";\nimport { nutrition_problems_type } from \"../../db/schemas/nutritionProblemsType.schema.js\";\nimport { nutrition_template } from \"../../db/schemas/nutritionTemplate.schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nimport { logger } from '../../utils/logger.js';\nclass NutritionController {\n    // Get all nutrition problems types\n    async nutritionProblemsTypes(request, reply) {\n        try {\n            const nutritionProblemsTypes = await db.select({\n                id: nutrition_problems_type.id,\n                name: nutrition_problems_type.name,\n                description: nutrition_problems_type.description,\n                createdAt: nutrition_problems_type.createdAt,\n                updatedAt: nutrition_problems_type.updatedAt,\n            }).from(nutrition_problems_type);\n            reply.code(200);\n            return nutritionProblemsTypes;\n        } catch (error) {\n            logger.error(\"Error fetching nutrition problems types:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Show nutrition assessment for a specific patient\n    async nutritionAssessmentShow(request, reply) {\n        try {\n            const { id } = request.params;\n\n            const nutritionAssessments = await db.select({\n                id: nutrition_assessment.id,\n                patient_id: nutrition_assessment.patient_id,\n                nutrition_problems_type_ids: nutrition_assessment.nutrition_problems_type_ids,\n                nutrition_template_ids: nutrition_assessment.nutrition_template_ids,\n                createdAt: nutrition_assessment.createdAt,\n                updatedAt: nutrition_assessment.updatedAt,\n            }).from(nutrition_assessment).where(eq(nutrition_assessment.patient_id, id)).limit(1);\n            const nutritionAssessment = nutritionAssessments[0];\n\n            if (!nutritionAssessment) {\n                reply.code(404);\n            return {\n                    error: \"No nutrition assessment found for this patient\",\n                };\n            }\n\n            reply.code(200);\n            return {\n                nutrition_assessment: nutritionAssessment,\n            };\n        } catch (error) {\n            logger.error(\"Error fetching nutrition assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Auto save nutrition assessment for a patient\n    async nutritionAssessmentAutoSave(request, reply) {\n        try {\n            const { id } = request.params;\n            const {\n                patient_id,\n                nutrition_problems_type_ids,\n                nutrition_template_ids,\n            } = request.body;\n\n            // Validate required fields\n            if (!patient_id) {\n                reply.code(400);\n            return {\n                    message: \"Patient ID is required\",\n                };\n            }\n\n            if (!nutrition_problems_type_ids) {\n                reply.code(400);\n            return {\n                    message: \"Nutrition problems type IDs are required\",\n                };\n            }\n\n            if (!nutrition_template_ids) {\n                reply.code(400);\n            return {\n                    message: \"Nutrition template IDs are required\",\n                };\n            }\n\n            // Check if nutrition assessment already exists for this patient\n            const existingAssessments = await db.select({ id: nutrition_assessment.id }).from(nutrition_assessment).where(eq(nutrition_assessment.patient_id, id)).limit(1);\n            const existingAssessment = existingAssessments[0];\n\n            // Convert arrays to comma-separated strings if they are arrays\n            const nutritionProblemsTypeIdsString = Array.isArray(\n                nutrition_problems_type_ids\n            )\n                ? nutrition_problems_type_ids.join(\",\")\n                : nutrition_problems_type_ids;\n\n            const nutritionTemplateIdsString = Array.isArray(\n                nutrition_template_ids\n            )\n                ? nutrition_template_ids.join(\",\")\n                : nutrition_template_ids;\n\n            let result;\n            const now = new Date();\n            \n            if (existingAssessment) {\n                // Update existing nutrition assessment\n                result = await db.update(nutrition_assessment)\n                    .set({\n                        patient_id: patient_id,\n                        nutrition_problems_type_ids: nutritionProblemsTypeIdsString,\n                        nutrition_template_ids: nutritionTemplateIdsString,\n                        updatedAt: now,\n                    })\n                    .where(eq(nutrition_assessment.patient_id, id))\n                    .returning();\n                result = result[0];\n            } else {\n                // Create new nutrition assessment\n                result = await db.insert(nutrition_assessment)\n                    .values({\n                        patient_id: patient_id,\n                        nutrition_problems_type_ids: nutritionProblemsTypeIdsString,\n                        nutrition_template_ids: nutritionTemplateIdsString,\n                        createdAt: now,\n                        updatedAt: now,\n                    })\n                    .returning();\n                result = result[0];\n            }\n\n            reply.code(200);\n            return {\n                message: \"Données sauvegardées avec succès\",\n                data: result,\n            };\n        } catch (error) {\n            logger.error(\"Error saving nutrition assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n}\n\nexport default new NutritionController();"],"mappings":"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","ignoreList":[]}