{"version":3,"names":["cov_1fakmnwv44","actualCoverage","queueConfig","logger","QueueService","constructor","f","s","connection","default","config","connections","jobs","failedJobs","registeredJobs","Map","registerJob","jobName","handler","b","trim","Error","has","set","unregisterJob","delete","getRegisteredJobNames","Array","from","keys","push","queue","data","join","jobId","generateJobId","jobData","id","attempts","createdAt","Date","get","error","handleFailedJob","process","i","length","splice","failedJob","failedAt","exception","message","trace","stack","now","Math","random","toString","substr","pending","failed","getJobs","getFailedJobs"],"sources":["QueueService.js"],"sourcesContent":["import queueConfig from '../config/queue.config.js';\n\nimport { logger } from '../utils/logger.js';\nclass QueueService {\n    constructor() {\n        this.connection = queueConfig.default;\n        this.config = queueConfig.connections[this.connection];\n        this.jobs = [];\n        this.failedJobs = [];\n\n        // Job registry to prevent code injection (replaces eval())\n        this.registeredJobs = new Map();\n    }\n\n    /**\n     * Register a job handler\n     * @param {string} jobName - Unique job name\n     * @param {Function} handler - Job handler function\n     * @throws {Error} If job name already registered\n     */\n    registerJob(jobName, handler) {\n        if (typeof jobName !== 'string' || jobName.trim() === '') {\n            throw new Error('Job name must be a non-empty string');\n        }\n\n        if (typeof handler !== 'function') {\n            throw new Error('Job handler must be a function');\n        }\n\n        if (this.registeredJobs.has(jobName)) {\n            throw new Error(`Job \"${jobName}\" is already registered`);\n        }\n\n        this.registeredJobs.set(jobName, handler);\n    }\n\n    /**\n     * Unregister a job handler\n     * @param {string} jobName - Job name to unregister\n     */\n    unregisterJob(jobName) {\n        this.registeredJobs.delete(jobName);\n    }\n\n    /**\n     * Get all registered job names\n     * @returns {string[]} Array of registered job names\n     */\n    getRegisteredJobNames() {\n        return Array.from(this.registeredJobs.keys());\n    }\n\n    /**\n     * Push a job onto the queue\n     * @param {string} queue - The queue name\n     * @param {string} jobName - The registered job name to execute\n     * @param {Object} data - The job data\n     * @returns {string} Job ID\n     */\n    async push(queue, jobName, data = {}) {\n        // Validate job is registered\n        if (typeof jobName !== 'string') {\n            throw new Error('Job name must be a string (not a function). Use registerJob() first.');\n        }\n\n        if (!this.registeredJobs.has(jobName)) {\n            throw new Error(`Job \"${jobName}\" is not registered. Available jobs: ${this.getRegisteredJobNames().join(', ')}`);\n        }\n\n        const jobId = this.generateJobId();\n\n        const jobData = {\n            id: jobId,\n            queue: queue,\n            jobName: jobName,  // Store job name instead of function code\n            data: data,\n            attempts: 0,\n            createdAt: new Date()\n        };\n\n        // For sync driver, execute immediately\n        if (this.connection === 'sync') {\n            try {\n                const handler = this.registeredJobs.get(jobName);\n                await handler(data);\n                return jobId;\n            } catch (error) {\n                this.handleFailedJob(jobData, error);\n                throw error;\n            }\n        }\n\n        // For other drivers, store the job\n        this.jobs.push(jobData);\n        return jobId;\n    }\n\n    /**\n     * Process jobs in the queue\n     */\n    async process() {\n        // For sync driver, there's nothing to process\n        if (this.connection === 'sync') {\n            return;\n        }\n\n        // Process jobs\n        for (let i = 0; i < this.jobs.length; i++) {\n            const jobData = this.jobs[i];\n\n            try {\n                // Get the registered job handler (NO EVAL - SECURE!)\n                const handler = this.registeredJobs.get(jobData.jobName);\n\n                if (!handler) {\n                    throw new Error(`Job \"${jobData.jobName}\" is not registered`);\n                }\n\n                await handler(jobData.data);\n\n                // Remove successful job\n                this.jobs.splice(i, 1);\n                i--;\n            } catch (error) {\n                this.handleFailedJob(jobData, error);\n\n                // Remove failed job\n                this.jobs.splice(i, 1);\n                i--;\n            }\n        }\n    }\n    \n    /**\n     * Handle a failed job\n     * @param {Object} jobData - The job data\n     * @param {Error} error - The error that occurred\n     */\n    handleFailedJob(jobData, error) {\n        const failedJob = {\n            ...jobData,\n            failedAt: new Date(),\n            exception: error.message,\n            trace: error.stack\n        };\n        \n        this.failedJobs.push(failedJob);\n        logger.error(`Job ${jobData.id} failed:`, error)\n    }\n    \n    /**\n     * Generate a unique job ID\n     * @returns {string} Job ID\n     */\n    generateJobId() {\n        return 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n    }\n    \n    /**\n     * Get the number of pending jobs\n     * @returns {number} Number of pending jobs\n     */\n    pending() {\n        return this.jobs.length;\n    }\n    \n    /**\n     * Get the number of failed jobs\n     * @returns {number} Number of failed jobs\n     */\n    failed() {\n        return this.failedJobs.length;\n    }\n    \n    /**\n     * Get all jobs\n     * @returns {Array} All jobs\n     */\n    getJobs() {\n        return this.jobs;\n    }\n    \n    /**\n     * Get all failed jobs\n     * @returns {Array} All failed jobs\n     */\n    getFailedJobs() {\n        return this.failedJobs;\n    }\n}\n\nexport default new QueueService();"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}