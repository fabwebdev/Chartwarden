{"version":3,"names":["cov_29q0rny4rj","actualCoverage","JobScheduler","PERMISSIONS","requireAnyPermission","logger","jobsRoutes","fastify","options","f","s","get","preHandler","MANAGE_SETTINGS","request","reply","success","data","scheduler_enabled","process","env","ENABLE_SCHEDULER","available_jobs","timezone","b","TZ","post","jobName","params","validJobs","includes","code","send","error","message","join","info","user_id","user","id","job","result","runJob","executed_at","Date","toISOString"],"sources":["jobs.routes.js"],"sourcesContent":["import JobScheduler from '../jobs/scheduler.js';\nimport { PERMISSIONS } from '../config/rbac.js';\nimport { requireAnyPermission } from '../middleware/rbac.middleware.js';\n\nimport { logger } from '../utils/logger.js';\n\n/**\n * Jobs Routes\n * Admin routes for managing and triggering background jobs\n * Only available in development environment or to admin users\n */\nexport default async function jobsRoutes(fastify, options) {\n  // Get scheduler status\n  fastify.get('/jobs/status', {\n    preHandler: [requireAnyPermission(PERMISSIONS.MANAGE_SETTINGS)]\n  }, async (request, reply) => {\n    return {\n      success: true,\n      data: {\n        scheduler_enabled: process.env.ENABLE_SCHEDULER === 'true',\n        available_jobs: [\n          'cap-recalculation',\n          'certification-alerts',\n          'overdue-certifications',\n          'audit-retention',\n          'audit-compliance-check'\n        ],\n        timezone: process.env.TZ || 'America/New_York'\n      }\n    };\n  });\n\n  // Manually trigger a specific job\n  fastify.post('/jobs/:jobName/run', {\n    preHandler: [requireAnyPermission(PERMISSIONS.MANAGE_SETTINGS)]\n  }, async (request, reply) => {\n    const { jobName } = request.params;\n\n    // Validate job name\n    const validJobs = [\n      'cap-recalculation',\n      'certification-alerts',\n      'overdue-certifications',\n      'audit-retention',\n      'audit-compliance-check'\n    ];\n\n    if (!validJobs.includes(jobName)) {\n      return reply.code(400).send({\n        success: false,\n        error: {\n          code: 'INVALID_JOB',\n          message: `Invalid job name. Valid jobs: ${validJobs.join(', ')}`\n        }\n      });\n    }\n\n    try {\n      logger.info(`Manual job trigger requested: ${jobName}`, {\n        user_id: request.user?.id,\n        job: jobName\n      });\n\n      const result = await JobScheduler.runJob(jobName);\n\n      logger.info(`Manual job completed: ${jobName}`, {\n        user_id: request.user?.id,\n        job: jobName,\n        result\n      });\n\n      return {\n        success: true,\n        data: {\n          job: jobName,\n          executed_at: new Date().toISOString(),\n          result\n        }\n      };\n    } catch (error) {\n      logger.error(`Manual job failed: ${jobName}`, {\n        user_id: request.user?.id,\n        job: jobName,\n        error: error.message\n      });\n\n      return reply.code(500).send({\n        success: false,\n        error: {\n          code: 'JOB_EXECUTION_FAILED',\n          message: error.message\n        }\n      });\n    }\n  });\n}\n"],"mappings":"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","ignoreList":[]}