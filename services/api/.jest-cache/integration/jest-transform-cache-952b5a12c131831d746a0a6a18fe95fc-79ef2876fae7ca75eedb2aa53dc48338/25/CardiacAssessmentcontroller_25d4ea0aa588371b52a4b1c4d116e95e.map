{"version":3,"names":["cov_1sxxz9dpe7","actualCoverage","db","cardiac_assessment","cardiac","eq","logAudit","logger","CardiacAssessmentController","index","request","reply","f","s","cardiacAssessments","select","id","patient_id","cardiac_ids","createdAt","updatedAt","from","code","error","message","cardiacList","name","store","body","b","existingAssessments","where","limit","existingAssessment","cardiacIdsString","Array","isArray","join","result","action","now","Date","update","set","returning","insert","values","data","show","params","cardiacAssessment","parseInt"],"sources":["CardiacAssessment.controller.js"],"sourcesContent":["import { db } from \"../../config/db.drizzle.js\";\nimport { cardiac_assessment } from \"../../db/schemas/cardiacAssessment.schema.js\";\nimport { cardiac } from \"../../db/schemas/cardiac.schema.js\";\nimport { eq } from \"drizzle-orm\";\nimport { logAudit } from \"../../middleware/audit.middleware.js\";\n\nimport { logger } from '../../utils/logger.js';\nclass CardiacAssessmentController {\n    // Get all cardiac assessments\n    async index(request, reply) {\n        try {\n            const cardiacAssessments = await db.select({\n                id: cardiac_assessment.id,\n                patient_id: cardiac_assessment.patient_id,\n                cardiac_ids: cardiac_assessment.cardiac_ids,\n                createdAt: cardiac_assessment.createdAt,\n                updatedAt: cardiac_assessment.updatedAt,\n            }).from(cardiac_assessment);\n            reply.code(200);\n            return cardiacAssessments;\n        } catch (error) {\n            logger.error(\"Error fetching cardiac assessments:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Get all cardiac options\n    async cardiacList(request, reply) {\n        try {\n            const cardiacList = await db.select({\n                id: cardiac.id,\n                name: cardiac.name,\n                createdAt: cardiac.createdAt,\n                updatedAt: cardiac.updatedAt,\n            }).from(cardiac);\n            reply.code(200);\n            return cardiacList;\n        } catch (error) {\n            logger.error(\"Error fetching cardiac list:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Store or update cardiac assessment\n    async store(request, reply) {\n        try {\n            const { patient_id, cardiac_ids } = request.body;\n\n            // Validate required fields\n            if (!patient_id) {\n                reply.code(400);\n                return {\n                    message: \"Patient ID is required\",\n                };\n            }\n\n            if (!cardiac_ids) {\n                reply.code(400);\n                return {\n                    message: \"Cardiac IDs are required\",\n                };\n            }\n\n            // Check if cardiac assessment already exists for this patient\n            const existingAssessments = await db.select({ id: cardiac_assessment.id }).from(cardiac_assessment).where(eq(cardiac_assessment.patient_id, patient_id)).limit(1);\n            const existingAssessment = existingAssessments[0];\n\n            // Convert cardiac_ids array to comma-separated string\n            const cardiacIdsString = Array.isArray(cardiac_ids)\n                ? cardiac_ids.join(\",\")\n                : cardiac_ids;\n\n            let result;\n            let action;\n            const now = new Date();\n            if (existingAssessment) {\n                // Update existing cardiac assessment\n                result = await db.update(cardiac_assessment)\n                    .set({ cardiac_ids: cardiacIdsString, updatedAt: now })\n                    .where(eq(cardiac_assessment.patient_id, patient_id))\n                    .returning();\n                result = result[0];\n                action = \"UPDATE\";\n            } else {\n                // Create new cardiac assessment\n                result = await db.insert(cardiac_assessment).values({\n                    patient_id: patient_id,\n                    cardiac_ids: cardiacIdsString,\n                    createdAt: now,\n                    updatedAt: now,\n                }).returning();\n                result = result[0];\n                action = \"CREATE\";\n            }\n\n            await logAudit(request, action, \"cardiac_assessment\", result.id);\n\n            reply.code(201);\n            return {\n                message: \"Cardiac assessment created or updated successfully\",\n                data: result,\n            };\n        } catch (error) {\n            logger.error(\"Error storing cardiac assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n\n    // Show cardiac assessment for a specific patient\n    // Returns empty data if no assessment exists (to allow frontend to render form)\n    async show(request, reply) {\n        try {\n            const { id } = request.params;\n\n            const cardiacAssessments = await db.select({\n                id: cardiac_assessment.id,\n                patient_id: cardiac_assessment.patient_id,\n                cardiac_ids: cardiac_assessment.cardiac_ids,\n                createdAt: cardiac_assessment.createdAt,\n                updatedAt: cardiac_assessment.updatedAt,\n            }).from(cardiac_assessment).where(eq(cardiac_assessment.patient_id, id)).limit(1);\n            const cardiacAssessment = cardiacAssessments[0];\n\n            if (!cardiacAssessment) {\n                // Return 200 with empty data instead of 404, so frontend can render form\n                reply.code(200);\n                return {\n                    id: null,\n                    patient_id: parseInt(id),\n                    cardiac_ids: \"\",\n                    createdAt: null,\n                    updatedAt: null,\n                };\n            }\n\n            await logAudit(request, \"READ\", \"cardiac_assessment\", cardiacAssessment.id);\n\n            reply.code(200);\n            return cardiacAssessment;\n        } catch (error) {\n            logger.error(\"Error fetching cardiac assessment:\", error)\n            reply.code(500);\n            return {\n                message: \"Internal server error\",\n                error: error.message,\n            };\n        }\n    }\n}\n\nexport default new CardiacAssessmentController();"],"mappings":"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","ignoreList":[]}