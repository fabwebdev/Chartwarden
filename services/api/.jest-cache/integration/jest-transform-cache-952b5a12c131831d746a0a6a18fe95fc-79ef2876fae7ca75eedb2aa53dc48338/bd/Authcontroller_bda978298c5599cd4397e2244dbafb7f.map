{"version":3,"names":["cov_2j3ysjgo1l","actualCoverage","db","users","eq","auth","fromNodeHeaders","logger","s","getUser","request","reply","f","session","api","getSession","headers","cookies","b","code","status","message","userRecords","select","id","name","email","emailVerified","image","role","createdAt","updatedAt","from","where","user","limit","userResponse","password","data","error","registerValidation","body","errors","field","loginValidation"],"sources":["Auth.controller.js"],"sourcesContent":["import { db } from '../config/db.drizzle.js';\nimport { users } from '../db/schemas/user.schema.js';\nimport { eq } from 'drizzle-orm';\n// Note: express-validator replaced with Fastify schema validation\nimport auth from '../config/betterAuth.js';\nimport { fromNodeHeaders } from 'better-auth/node';\n\nimport { logger } from '../utils/logger.js';\n// Get user details (using Better Auth session)\nexport const getUser = async (request, reply) => {\n  try {\n    // Get session from Better Auth\n    const session = await auth.api.getSession({\n      headers: fromNodeHeaders(request.headers),\n      cookies: request.cookies\n    });\n    \n    if (!session) {\n      reply.code(401);\n            return {\n        status: 401,\n        message: 'Access denied. No valid session found.'\n      };\n    }\n    \n    // Fetch full user details from database using Drizzle\n    const userRecords = await db.select({\n      id: users.id,\n      name: users.name,\n      email: users.email,\n      emailVerified: users.emailVerified,\n      image: users.image,\n      role: users.role,\n      createdAt: users.createdAt,\n      updatedAt: users.updatedAt\n    }).from(users).where(eq(users.id, session.user.id)).limit(1);\n    const user = userRecords[0];\n    \n    if (!user) {\n      reply.code(404);\n            return {\n        status: 404,\n        message: 'User not found'\n      };\n    }\n    \n    // Remove password from response\n    const userResponse = { ...user };\n    delete userResponse.password;\n    \n    return {\n      status: 200,\n      data: {\n        user: userResponse\n      }\n    };\n  } catch (error) {\n    logger.error('Get user error:', error)\n    reply.code(500);\n    return {\n      status: 500,\n      message: 'Server error while fetching user details'\n    };\n  }\n};\n\n// Validation rules for registration\n// Note: In Fastify, validation should be done using schema in route definitions\nexport const registerValidation = async (request, reply) => {\n  // Basic validation - should be done in route schema\n  if (!request.body.name || !request.body.email || !request.body.password) {\n    reply.code(400);\n    return {\n      status: 400,\n      message: 'Validation failed',\n      errors: [\n        ...(!request.body.name ? [{ field: 'name', message: 'Name is required' }] : []),\n        ...(!request.body.email ? [{ field: 'email', message: 'Valid email is required' }] : []),\n        ...(!request.body.password ? [{ field: 'password', message: 'Password must be at least 6 characters long' }] : []),\n      ],\n    };\n  }\n};\n\n// Validation rules for login\n// Note: In Fastify, validation should be done using schema in route definitions\nexport const loginValidation = async (request, reply) => {\n  // Basic validation - should be done in route schema\n  if (!request.body.email || !request.body.password) {\n    reply.code(400);\n    return {\n      status: 400,\n      message: 'Validation failed',\n      errors: [\n        ...(!request.body.email ? [{ field: 'email', message: 'Valid email is required' }] : []),\n        ...(!request.body.password ? [{ field: 'password', message: 'Password is required' }] : []),\n      ],\n    };\n  }\n};"],"mappings":"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","ignoreList":[]}