{"version":3,"names":["cov_1407bcwfyt","actualCoverage","s","cookieFixMiddleware","request","reply","f","originalSetCookie","setCookie","bind","name","value","options","b","fixedOptions","sameSite","secure","originalHeader","header","toLowerCase","cookies","Array","isArray","modifiedCookies","map","cookie","fixCookieSameSite","includes","modified","replace"],"sources":["cookie-fix.middleware.js"],"sourcesContent":["/**\n * Middleware to fix cookie SameSite attribute for cross-origin requests\n * Better Auth may not respect the cookie configuration, so we intercept\n * Set-Cookie headers and modify them to use SameSite=None\n */\nconst cookieFixMiddleware = async (request, reply) => {\n  // Store original setCookie function\n  const originalSetCookie = reply.setCookie.bind(reply);\n  \n  // Override setCookie to fix SameSite attribute\n  reply.setCookie = function(name, value, options = {}) {\n    // Force SameSite=None and Secure for cross-origin\n    const fixedOptions = {\n      ...options,\n      sameSite: 'none',\n      secure: true,\n    };\n    \n    // Call original setCookie function with fixed options\n    return originalSetCookie(name, value, fixedOptions);\n  };\n  \n  // Also intercept header setting for Set-Cookie\n  const originalHeader = reply.header.bind(reply);\n  reply.header = function(name, value) {\n    if (name.toLowerCase() === 'set-cookie') {\n      // Handle array of cookie strings\n      const cookies = Array.isArray(value) ? value : [value];\n      \n      // Modify each cookie to use SameSite=None\n      const modifiedCookies = cookies.map(cookie => {\n        return fixCookieSameSite(cookie);\n      });\n      \n      // Call original header with modified cookies\n      return originalHeader(name, modifiedCookies);\n    }\n    \n    // For all other headers, call original header\n    return originalHeader(name, value);\n  };\n};\n\n/**\n * Fix cookie SameSite attribute to None for cross-origin support\n */\nfunction fixCookieSameSite(cookie) {\n  // If cookie already has SameSite=None, leave it\n  if (cookie.includes('SameSite=None') || cookie.includes('SameSite=none')) {\n    // Ensure Secure is present\n    if (!cookie.includes('Secure')) {\n      cookie += '; Secure';\n    }\n    return cookie;\n  }\n  \n  // Replace SameSite=Lax or SameSite=Strict with SameSite=None\n  let modified = cookie\n    .replace(/SameSite=Lax/gi, 'SameSite=None')\n    .replace(/SameSite=Strict/gi, 'SameSite=None')\n    .replace(/SameSite=lax/gi, 'SameSite=None')\n    .replace(/SameSite=strict/gi, 'SameSite=None');\n  \n  // If no SameSite attribute exists, add it\n  if (!modified.includes('SameSite')) {\n    // Insert SameSite=None before Secure or at the end\n    if (modified.includes('; Secure')) {\n      modified = modified.replace('; Secure', '; SameSite=None; Secure');\n    } else if (modified.includes('Secure')) {\n      modified = modified.replace('Secure', 'SameSite=None; Secure');\n    } else {\n      // Add at the end\n      modified += '; SameSite=None';\n      // Ensure Secure is also present for SameSite=None\n      modified += '; Secure';\n    }\n  }\n  \n  // Ensure Secure is present when SameSite=None\n  if (modified.includes('SameSite=None') && !modified.includes('Secure')) {\n    modified += '; Secure';\n  }\n  \n  return modified;\n}\n\nexport default cookieFixMiddleware;\n\n"],"mappings":"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","ignoreList":[]}