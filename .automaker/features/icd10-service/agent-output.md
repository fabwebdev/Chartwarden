
ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore existing codebase structure for services and patterns",
      "status": "in_progress",
      "activeForm": "Exploring existing codebase structure"
    },
    {
      "content": "Design ICD-10 service architecture with caching strategy",
      "status": "pending",
      "activeForm": "Designing ICD-10 service architecture"
    },
    {
      "content": "Implement ICD-10 service with autocomplete and caching",
      "status": "pending",
      "activeForm": "Implementing ICD-10 service"
    },
    {
      "content": "Create ICD-10 routes and controller",
      "status": "pending",
      "activeForm": "Creating ICD-10 routes and controller"
    },
    {
      "content": "Add ICD-10 data source (seed data or database schema)",
      "status": "pending",
      "activeForm": "Adding ICD-10 data source"
    },
    {
      "content": "Create Playwright verification test",
      "status": "pending",
      "activeForm": "Creating Playwright verification test"
    },
    {
      "content": "Run verification and fix any issues",
      "status": "pending",
      "activeForm": "Running verification tests"
    },
    {
      "content": "Clean up verification test file",
      "status": "pending",
      "activeForm": "Cleaning up verification test"
    }
  ]
}

Let me explore the existing codebase structure to understand the patterns used for services, controllers, and routes.

ðŸ”§ Tool: Glob
Input: {
  "pattern": "services/api/src/services/*.js"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "services/api/src/controllers/*.js"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "services/api/src/routes/*.js"
}

I see there's already an `ICD10.service.js` file. Let me read it along with the existing CacheService and a sample controller/route to understand the patterns.

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/services/ICD10.service.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/services/CacheService.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/services/RedisService.js"
}

Let me also look at a sample controller and routes to understand the patterns used.

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/DenialCodes.controller.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/routes/denialCodes.routes.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/routes/api.routes.js"
}

Now let me check the database schemas to understand the patterns and see if there's already an ICD-10 table or if we need to create one.

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/index.js"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "services/api/src/db/schemas/*icd*.js"
}

Now I have a good understanding of the codebase. Let me update my todo list and begin implementation.

ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore existing codebase structure for services and patterns",
      "status": "completed",
      "activeForm": "Exploring existing codebase structure"
    },
    {
      "content": "Create ICD-10 database schema",
      "status": "in_progress",
      "activeForm": "Creating ICD-10 database schema"
    },
    {
      "content": "Implement enhanced ICD-10 service with caching",
      "status": "pending",
      "activeForm": "Implementing enhanced ICD-10 service"
    },
    {
      "content": "Create ICD-10 controller with autocomplete endpoints",
      "status": "pending",
      "activeForm": "Creating ICD-10 controller"
    },
    {
      "content": "Create ICD-10 routes",
      "status": "pending",
      "activeForm": "Creating ICD-10 routes"
    },
    {
      "content": "Register routes in api.routes.js",
      "status": "pending",
      "activeForm": "Registering ICD-10 routes"
    },
    {
      "content": "Seed ICD-10 data (10,000+ codes)",
      "status": "pending",
      "activeForm": "Seeding ICD-10 data"
    },
    {
      "content": "Create Playwright verification test",
      "status": "pending",
      "activeForm": "Creating Playwright verification test"
    },
    {
      "content": "Run verification and fix any issues",
      "status": "pending",
      "activeForm": "Running verification tests"
    },
    {
      "content": "Clean up verification test file",
      "status": "pending",
      "activeForm": "Cleaning up verification test"
    }
  ]
}

Let me create the ICD-10 database schema first.

ðŸ”§ Tool: Write
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/icd10Codes.schema.js",
  "content": "import { pgTable, uuid, varchar, text, boolean, timestamp, integer, index } from 'drizzle-orm/pg-core';\nimport { relations } from 'drizzle-orm';\n\n/**\n * ICD-10 Diagnosis Codes Schema\n *\n * Stores the complete ICD-10-CM diagnosis code library for:\n * - Fast autocomplete lookups by code or description\n * - Exact code validation\n * - Category and chapter browsing\n * - Medical necessity documentation\n *\n * ICD-10-CM codes follow the pattern: Letter + 2 digits + optional decimal + 1-4 characters\n * Examples: A00, A00.0, A00.01, E11.9, Z99.89\n */\nexport const icd10_codes = pgTable('icd10_codes', {\n  id: uuid('id').defaultRandom().primaryKey(),\n\n  // Code identifier (e.g., \"E11.9\")\n  code: varchar('code', { length: 10 }).notNull().unique(),\n\n  // Short description for autocomplete display (e.g., \"Type 2 diabetes mellitus without complications\")\n  shortDescription: varchar('short_description', { length: 255 }).notNull(),\n\n  // Full/long description for detailed views\n  longDescription: text('long_description'),\n\n  // Category code (first 3 characters, e.g., \"E11\")\n  categoryCode: varchar('category_code', { length: 7 }).notNull(),\n\n  // Category description (e.g., \"Type 2 diabetes mellitus\")\n  categoryDescription: varchar('category_description', { length: 255 }),\n\n  // Chapter information (e.g., \"Chapter 4: Endocrine, nutritional and metabolic diseases\")\n  chapter: varchar('chapter', { length: 10 }),\n  chapterDescription: varchar('chapter_description', { length: 255 }),\n\n  // Block/Range (e.g., \"E08-E13\" for Diabetes mellitus)\n  blockCode: varchar('block_code', { length: 15 }),\n  blockDescription: varchar('block_description', { length: 255 }),\n\n  // Code specificity (3-7 characters indicating specificity level)\n  codeLength: integer('code_length').notNull().default(3),\n\n  // Is this a billable/valid code or a category header?\n  isBillable: boolean('is_billable').notNull().default(false),\n\n  // Is this code currently active/valid?\n  isActive: boolean('is_active').notNull().default(true),\n\n  // Common/frequently used flag for prioritization\n  isCommon: boolean('is_common').notNull().default(false),\n\n  // Hospice-relevant flag for prioritization in hospice EHR\n  isHospiceRelevant: boolean('is_hospice_relevant').notNull().default(false),\n\n  // Usage count for popularity-based sorting\n  usageCount: integer('usage_count').notNull().default(0),\n\n  // ICD-10 version/year (e.g., \"2024\")\n  version: varchar('version', { length: 10 }),\n\n  // Effective dates for the code\n  effectiveDate: timestamp('effective_date'),\n  expirationDate: timestamp('expiration_date'),\n\n  // Audit timestamps\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull()\n}, (table) => ({\n  // Index for autocomplete searches by code\n  codeIdx: index('icd10_code_idx').on(table.code),\n\n  // Index for category lookups\n  categoryIdx: index('icd10_category_idx').on(table.categoryCode),\n\n  // Index for chapter browsing\n  chapterIdx: index('icd10_chapter_idx').on(table.chapter),\n\n  // Index for filtering active billable codes (most common query)\n  activeBillableIdx: index('icd10_active_billable_idx').on(table.isActive, table.isBillable),\n\n  // Index for hospice-relevant codes\n  hospiceRelevantIdx: index('icd10_hospice_relevant_idx').on(table.isHospiceRelevant),\n\n  // Index for common codes\n  commonIdx: index('icd10_common_idx').on(table.isCommon),\n\n  // Composite index for popularity-based sorting\n  usageIdx: index('icd10_usage_idx').on(table.usageCount)\n}));\n\n// Export for schema references\nexport default icd10_codes;\n"
}

Now let me add the export to the schemas index.

ðŸ”§ Tool: Edit
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/index.js",
  "old_string": "export * from './wongBakerFacesScale.schema.js';",
  "new_string": "export * from './wongBakerFacesScale.schema.js';\nexport * from './icd10Codes.schema.js';"
}

ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore existing codebase structure for services and patterns",
      "status": "completed",
      "activeForm": "Exploring existing codebase structure"
    },
    {
      "content": "Create ICD-10 database schema",
      "status": "completed",
      "activeForm": "Creating ICD-10 database schema"
    },
    {
      "content": "Implement enhanced ICD-10 service with caching",
      "status": "in_progress",
      "activeForm": "Implementing enhanced ICD-10 service"
    },
    {
      "content": "Create ICD-10 controller with autocomplete endpoints",
      "status": "pending",
      "activeForm": "Creating ICD-10 controller"
    },
    {
      "content": "Create ICD-10 routes",
      "status": "pending",
      "activeForm": "Creating ICD-10 routes"
    },
    {
      "content": "Register routes in api.routes.js",
      "status": "pending",
      "activeForm": "Registering ICD-10 routes"
    },
    {
      "content": "Seed ICD-10 data (10,000+ codes)",
      "status": "pending",
      "activeForm": "Seeding ICD-10 data"
    },
    {
      "content": "Create Playwright verification test",
      "status": "pending",
      "activeForm": "Creating Playwright verification test"
    },
    {
      "content": "Run verification and fix any issues",
      "status": "pending",
      "activeForm": "Running verification tests"
    },
    {
      "content": "Clean up verification test file",
      "status": "pending",
      "activeForm": "Cleaning up verification test"
    }
  ]
}

Now let me create the enhanced ICD-10 service with caching and autocomplete.

ðŸ”§ Tool: Write
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/services/ICD10.service.js",
  "content": "/**\n * ICD-10 Code Service\n *\n * Provides ICD-10 diagnosis code lookup with caching and autocomplete functionality.\n * Designed for fast response times (<200ms) and high cache hit rates (>70%).\n *\n * Features:\n * - Autocomplete by code or description with sub-200ms response\n * - Multi-tier caching (in-memory + Redis fallback)\n * - Case-insensitive search\n * - Exact code lookups\n * - Category and chapter navigation\n * - Usage tracking for popularity-based sorting\n * - Hospice-relevant code prioritization\n *\n * Cache Strategy:\n * - Primary: In-memory LRU cache for frequently accessed codes (fastest)\n * - Secondary: Redis cache for shared state across instances\n * - TTL: 24 hours for ICD-10 codes (static medical reference data)\n */\n\nimport { db } from '../config/db.drizzle.js';\nimport { icd10_codes } from '../db/schemas/index.js';\nimport { eq, and, or, ilike, sql, desc, asc, gte, lte, isNull } from 'drizzle-orm';\nimport { logger } from '../utils/logger.js';\nimport cacheService from './CacheService.js';\n\n// In-memory LRU cache for ultra-fast lookups\nconst memoryCache = new Map();\nconst MEMORY_CACHE_MAX_SIZE = 1000;\nconst MEMORY_CACHE_TTL_MS = 60 * 60 * 1000; // 1 hour\n\n// Redis cache TTL for ICD-10 codes (24 hours - medical reference data is stable)\nconst REDIS_CACHE_TTL_SECONDS = 24 * 60 * 60;\n\n// Cache key prefixes\nconst CACHE_PREFIX = 'icd10';\n\n/**\n * LRU memory cache entry\n */\nclass CacheEntry {\n  constructor(value, ttlMs = MEMORY_CACHE_TTL_MS) {\n    this.value = value;\n    this.expiresAt = Date.now() + ttlMs;\n    this.accessedAt = Date.now();\n  }\n\n  isExpired() {\n    return Date.now() > this.expiresAt;\n  }\n\n  touch() {\n    this.accessedAt = Date.now();\n  }\n}\n\n/**\n * ICD-10 Service Class\n */\nclass ICD10Service {\n  constructor() {\n    this.stats = {\n      memoryCacheHits: 0,\n      redisCacheHits: 0,\n      cacheMisses: 0,\n      totalQueries: 0\n    };\n  }\n\n  // ============================================\n  // CACHE MANAGEMENT\n  // ============================================\n\n  /**\n   * Generate cache key\n   * @private\n   */\n  _getCacheKey(type, identifier) {\n    return `${CACHE_PREFIX}:${type}:${identifier}`;\n  }\n\n  /**\n   * Get from memory cache\n   * @private\n   */\n  _getFromMemoryCache(key) {\n    const entry = memoryCache.get(key);\n    if (entry && !entry.isExpired()) {\n      entry.touch();\n      this.stats.memoryCacheHits++;\n      return entry.value;\n    }\n    if (entry) {\n      memoryCache.delete(key);\n    }\n    return null;\n  }\n\n  /**\n   * Set in memory cache with LRU eviction\n   * @private\n   */\n  _setInMemoryCache(key, value, ttlMs = MEMORY_CACHE_TTL_MS) {\n    // LRU eviction if at capacity\n    if (memoryCache.size >= MEMORY_CACHE_MAX_SIZE) {\n      let oldestKey = null;\n      let oldestTime = Infinity;\n      for (const [k, entry] of memoryCache.entries()) {\n        if (entry.accessedAt < oldestTime) {\n          oldestTime = entry.accessedAt;\n          oldestKey = k;\n        }\n      }\n      if (oldestKey) {\n        memoryCache.delete(oldestKey);\n      }\n    }\n    memoryCache.set(key, new CacheEntry(value, ttlMs));\n  }\n\n  /**\n   * Multi-tier cache get\n   * @private\n   */\n  async _getCached(key) {\n    this.stats.totalQueries++;\n\n    // Try memory cache first (fastest)\n    const memResult = this._getFromMemoryCache(key);\n    if (memResult !== null) {\n      return memResult;\n    }\n\n    // Try Redis cache\n    try {\n      const redisResult = await cacheService.get(key);\n      if (redisResult !== null && redisResult !== undefined) {\n        this.stats.redisCacheHits++;\n        // Promote to memory cache\n        this._setInMemoryCache(key, redisResult);\n        return redisResult;\n      }\n    } catch (error) {\n      logger.warn('ICD10 Redis cache get failed', { key, error: error.message });\n    }\n\n    this.stats.cacheMisses++;\n    return null;\n  }\n\n  /**\n   * Multi-tier cache set\n   * @private\n   */\n  async _setCached(key, value, ttlSeconds = REDIS_CACHE_TTL_SECONDS) {\n    // Set in memory cache\n    this._setInMemoryCache(key, value, ttlSeconds * 1000);\n\n    // Set in Redis cache\n    try {\n      await cacheService.set(key, value, ttlSeconds);\n    } catch (error) {\n      logger.warn('ICD10 Redis cache set failed', { key, error: error.message });\n    }\n  }\n\n  /**\n   * Clear all ICD-10 caches\n   */\n  async clearCache() {\n    // Clear memory cache\n    for (const key of memoryCache.keys()) {\n      if (key.startsWith(CACHE_PREFIX)) {\n        memoryCache.delete(key);\n      }\n    }\n\n    // Clear Redis cache (pattern delete)\n    try {\n      // Note: This assumes cacheService has a way to delete by pattern\n      // If not available, individual keys would need to be tracked\n      logger.info('ICD10 cache cleared');\n    } catch (error) {\n      logger.warn('ICD10 Redis cache clear failed', { error: error.message });\n    }\n  }\n\n  /**\n   * Get cache statistics\n   */\n  getCacheStats() {\n    const total = this.stats.totalQueries;\n    const hits = this.stats.memoryCacheHits + this.stats.redisCacheHits;\n    return {\n      ...this.stats,\n      totalHits: hits,\n      hitRate: total > 0 ? ((hits / total) * 100).toFixed(2) + '%' : '0%',\n      memoryCacheSize: memoryCache.size,\n      memoryCacheMaxSize: MEMORY_CACHE_MAX_SIZE\n    };\n  }\n\n  // ============================================\n  // VALIDATION & NORMALIZATION\n  // ============================================\n\n  /**\n   * Validate ICD-10 code format\n   * ICD-10 codes follow the pattern: Letter + 2 digits + optional decimal + 1-4 characters\n   * Examples: A00, A00.0, A00.01, E11.9, Z99.89\n   *\n   * @param {string} code - ICD-10 code to validate\n   * @returns {boolean} - True if code matches ICD-10 format\n   */\n  validateFormat(code) {\n    if (!code || typeof code !== 'string') {\n      return false;\n    }\n\n    // ICD-10-CM format: Letter + 2 digits + optional (. + 1-4 alphanumeric characters)\n    // Examples: A00, A00.0, A00.01, E11.65, Z99.89, S06.0X1A\n    const icd10Pattern = /^[A-TV-Z]\\d{2}(\\.[A-Z0-9]{1,4})?$/i;\n    return icd10Pattern.test(code.trim());\n  }\n\n  /**\n   * Normalize ICD-10 code to uppercase\n   *\n   * @param {string} code - ICD-10 code\n   * @returns {string} - Normalized code\n   */\n  normalize(code) {\n    if (!code || typeof code !== 'string') {\n      return '';\n    }\n    return code.trim().toUpperCase();\n  }\n\n  /**\n   * Get category code (first 3 characters)\n   * @param {string} code - Full ICD-10 code\n   * @returns {string} - Category code\n   */\n  getCategoryCode(code) {\n    const normalized = this.normalize(code);\n    return normalized.substring(0, 3);\n  }\n\n  /**\n   * Validate and sanitize an array of ICD-10 codes\n   *\n   * @param {Array<string>} codes - Array of ICD-10 codes\n   * @returns {Object} - { valid: Array, invalid: Array }\n   */\n  validateCodes(codes) {\n    if (!Array.isArray(codes)) {\n      return { valid: [], invalid: [] };\n    }\n\n    const valid = [];\n    const invalid = [];\n\n    for (const code of codes) {\n      if (this.validateFormat(code)) {\n        valid.push(this.normalize(code));\n      } else {\n        invalid.push(code);\n      }\n    }\n\n    return { valid, invalid };\n  }\n\n  // ============================================\n  // LOOKUP OPERATIONS\n  // ============================================\n\n  /**\n   * Get ICD-10 code by exact code\n   * @param {string} code - ICD-10 code\n   * @returns {Promise<Object|null>} - Code details or null\n   */\n  async getByCode(code) {\n    if (!this.validateFormat(code)) {\n      return null;\n    }\n\n    const normalizedCode = this.normalize(code);\n    const cacheKey = this._getCacheKey('code', normalizedCode);\n\n    // Check cache\n    const cached = await this._getCached(cacheKey);\n    if (cached !== null) {\n      return cached;\n    }\n\n    // Query database\n    try {\n      const [result] = await db.select()\n        .from(icd10_codes)\n        .where(eq(icd10_codes.code, normalizedCode))\n        .limit(1);\n\n      if (result) {\n        // Cache result\n        await this._setCached(cacheKey, result);\n\n        // Increment usage count asynchronously (fire and forget)\n        this._incrementUsageCount(normalizedCode).catch(() => {});\n      }\n\n      return result || null;\n    } catch (error) {\n      logger.error('ICD10 getByCode error', { code: normalizedCode, error: error.message });\n      return null;\n    }\n  }\n\n  /**\n   * Increment usage count for a code (for popularity-based sorting)\n   * @private\n   */\n  async _incrementUsageCount(code) {\n    try {\n      await db.update(icd10_codes)\n        .set({\n          usageCount: sql`${icd10_codes.usageCount} + 1`,\n          updatedAt: new Date()\n        })\n        .where(eq(icd10_codes.code, code));\n    } catch (error) {\n      // Silently fail - usage count is not critical\n    }\n  }\n\n  /**\n   * Autocomplete search for ICD-10 codes\n   * Searches by code prefix or description text\n   * Optimized for sub-200ms response time\n   *\n   * @param {string} query - Search query (code or description text)\n   * @param {Object} options - Search options\n   * @param {number} options.limit - Max results (default: 20)\n   * @param {boolean} options.billableOnly - Only return billable codes (default: true)\n   * @param {boolean} options.hospiceRelevant - Prioritize hospice-relevant codes (default: false)\n   * @param {boolean} options.includeInactive - Include inactive codes (default: false)\n   * @returns {Promise<Array>} - Array of matching codes\n   */\n  async autocomplete(query, options = {}) {\n    const {\n      limit = 20,\n      billableOnly = true,\n      hospiceRelevant = false,\n      includeInactive = false\n    } = options;\n\n    if (!query || typeof query !== 'string' || query.trim().length < 2) {\n      return [];\n    }\n\n    const searchTerm = query.trim();\n    const cacheKey = this._getCacheKey('ac', `${searchTerm}:${limit}:${billableOnly}:${hospiceRelevant}`);\n\n    // Check cache\n    const cached = await this._getCached(cacheKey);\n    if (cached !== null) {\n      return cached;\n    }\n\n    try {\n      // Build conditions\n      const conditions = [];\n\n      // Active codes only (unless includeInactive)\n      if (!includeInactive) {\n        conditions.push(eq(icd10_codes.isActive, true));\n      }\n\n      // Billable codes only\n      if (billableOnly) {\n        conditions.push(eq(icd10_codes.isBillable, true));\n      }\n\n      // Check if search term looks like a code (starts with letter + digits)\n      const isCodeSearch = /^[A-Z]\\d/i.test(searchTerm);\n\n      if (isCodeSearch) {\n        // Code prefix search\n        conditions.push(ilike(icd10_codes.code, `${searchTerm}%`));\n      } else {\n        // Description search (case-insensitive)\n        conditions.push(\n          or(\n            ilike(icd10_codes.shortDescription, `%${searchTerm}%`),\n            ilike(icd10_codes.longDescription, `%${searchTerm}%`),\n            ilike(icd10_codes.categoryDescription, `%${searchTerm}%`)\n          )\n        );\n      }\n\n      // Build order by clause\n      // Priority: hospice-relevant > common > usage count > alphabetical\n      const orderBy = [];\n      if (hospiceRelevant) {\n        orderBy.push(desc(icd10_codes.isHospiceRelevant));\n      }\n      orderBy.push(desc(icd10_codes.isCommon));\n      orderBy.push(desc(icd10_codes.usageCount));\n      orderBy.push(asc(icd10_codes.code));\n\n      // Execute query\n      const results = await db.select({\n        id: icd10_codes.id,\n        code: icd10_codes.code,\n        shortDescription: icd10_codes.shortDescription,\n        longDescription: icd10_codes.longDescription,\n        categoryCode: icd10_codes.categoryCode,\n        categoryDescription: icd10_codes.categoryDescription,\n        chapter: icd10_codes.chapter,\n        chapterDescription: icd10_codes.chapterDescription,\n        isBillable: icd10_codes.isBillable,\n        isCommon: icd10_codes.isCommon,\n        isHospiceRelevant: icd10_codes.isHospiceRelevant\n      })\n        .from(icd10_codes)\n        .where(and(...conditions))\n        .orderBy(...orderBy)\n        .limit(Number(limit));\n\n      // Cache results (shorter TTL for search results)\n      await this._setCached(cacheKey, results, 60 * 60); // 1 hour\n\n      return results;\n    } catch (error) {\n      logger.error('ICD10 autocomplete error', { query: searchTerm, error: error.message });\n      return [];\n    }\n  }\n\n  /**\n   * Search ICD-10 codes with full-text search capabilities\n   *\n   * @param {string} query - Search query\n   * @param {Object} options - Search options\n   * @returns {Promise<Object>} - { results: Array, total: number }\n   */\n  async search(query, options = {}) {\n    const {\n      limit = 50,\n      offset = 0,\n      billableOnly = false,\n      chapter = null,\n      category = null,\n      includeInactive = false\n    } = options;\n\n    if (!query || typeof query !== 'string') {\n      return { results: [], total: 0 };\n    }\n\n    const searchTerm = query.trim();\n\n    try {\n      const conditions = [];\n\n      // Active codes only\n      if (!includeInactive) {\n        conditions.push(eq(icd10_codes.isActive, true));\n      }\n\n      // Billable codes only\n      if (billableOnly) {\n        conditions.push(eq(icd10_codes.isBillable, true));\n      }\n\n      // Chapter filter\n      if (chapter) {\n        conditions.push(eq(icd10_codes.chapter, chapter));\n      }\n\n      // Category filter\n      if (category) {\n        conditions.push(ilike(icd10_codes.categoryCode, `${category}%`));\n      }\n\n      // Search condition\n      conditions.push(\n        or(\n          ilike(icd10_codes.code, `%${searchTerm}%`),\n          ilike(icd10_codes.shortDescription, `%${searchTerm}%`),\n          ilike(icd10_codes.longDescription, `%${searchTerm}%`)\n        )\n      );\n\n      // Get results\n      const whereClause = and(...conditions);\n\n      const results = await db.select()\n        .from(icd10_codes)\n        .where(whereClause)\n        .orderBy(desc(icd10_codes.usageCount), asc(icd10_codes.code))\n        .limit(Number(limit))\n        .offset(Number(offset));\n\n      // Get total count\n      const [countResult] = await db.select({\n        count: sql`COUNT(*)::int`\n      })\n        .from(icd10_codes)\n        .where(whereClause);\n\n      return {\n        results,\n        total: countResult?.count || 0\n      };\n    } catch (error) {\n      logger.error('ICD10 search error', { query: searchTerm, error: error.message });\n      return { results: [], total: 0 };\n    }\n  }\n\n  // ============================================\n  // CATEGORY & CHAPTER OPERATIONS\n  // ============================================\n\n  /**\n   * Get ICD-10 code category information\n   * @param {string} code - ICD-10 code\n   * @returns {Object|null} - Category information\n   */\n  getCategory(code) {\n    if (!this.validateFormat(code)) {\n      return null;\n    }\n\n    const firstLetter = code.charAt(0).toUpperCase();\n\n    // ICD-10-CM chapter mapping\n    const chapters = {\n      'A': { chapter: '1', range: 'A00-B99', description: 'Certain infectious and parasitic diseases' },\n      'B': { chapter: '1', range: 'A00-B99', description: 'Certain infectious and parasitic diseases' },\n      'C': { chapter: '2', range: 'C00-D49', description: 'Neoplasms' },\n      'D': { chapter: '3', range: 'D50-D89', description: 'Diseases of the blood and blood-forming organs and certain disorders involving the immune mechanism' },\n      'E': { chapter: '4', range: 'E00-E89', description: 'Endocrine, nutritional and metabolic diseases' },\n      'F': { chapter: '5', range: 'F01-F99', description: 'Mental, Behavioral and Neurodevelopmental disorders' },\n      'G': { chapter: '6', range: 'G00-G99', description: 'Diseases of the nervous system' },\n      'H': { chapter: '7-8', range: 'H00-H95', description: 'Diseases of the eye and adnexa / ear and mastoid process' },\n      'I': { chapter: '9', range: 'I00-I99', description: 'Diseases of the circulatory system' },\n      'J': { chapter: '10', range: 'J00-J99', description: 'Diseases of the respiratory system' },\n      'K': { chapter: '11', range: 'K00-K95', description: 'Diseases of the digestive system' },\n      'L': { chapter: '12', range: 'L00-L99', description: 'Diseases of the skin and subcutaneous tissue' },\n      'M': { chapter: '13', range: 'M00-M99', description: 'Diseases of the musculoskeletal system and connective tissue' },\n      'N': { chapter: '14', range: 'N00-N99', description: 'Diseases of the genitourinary system' },\n      'O': { chapter: '15', range: 'O00-O9A', description: 'Pregnancy, childbirth and the puerperium' },\n      'P': { chapter: '16', range: 'P00-P96', description: 'Certain conditions originating in the perinatal period' },\n      'Q': { chapter: '17', range: 'Q00-Q99', description: 'Congenital malformations, deformations and chromosomal abnormalities' },\n      'R': { chapter: '18', range: 'R00-R99', description: 'Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified' },\n      'S': { chapter: '19', range: 'S00-T88', description: 'Injury, poisoning and certain other consequences of external causes' },\n      'T': { chapter: '19', range: 'S00-T88', description: 'Injury, poisoning and certain other consequences of external causes' },\n      'V': { chapter: '20', range: 'V00-Y99', description: 'External causes of morbidity' },\n      'W': { chapter: '20', range: 'V00-Y99', description: 'External causes of morbidity' },\n      'X': { chapter: '20', range: 'V00-Y99', description: 'External causes of morbidity' },\n      'Y': { chapter: '20', range: 'V00-Y99', description: 'External causes of morbidity' },\n      'Z': { chapter: '21', range: 'Z00-Z99', description: 'Factors influencing health status and contact with health services' }\n    };\n\n    return chapters[firstLetter] || { chapter: 'Unknown', range: 'Unknown', description: 'Unknown category' };\n  }\n\n  /**\n   * List all ICD-10 chapters\n   * @returns {Array} - Array of chapter information\n   */\n  listChapters() {\n    return [\n      { chapter: '1', range: 'A00-B99', description: 'Certain infectious and parasitic diseases' },\n      { chapter: '2', range: 'C00-D49', description: 'Neoplasms' },\n      { chapter: '3', range: 'D50-D89', description: 'Diseases of the blood and blood-forming organs' },\n      { chapter: '4', range: 'E00-E89', description: 'Endocrine, nutritional and metabolic diseases' },\n      { chapter: '5', range: 'F01-F99', description: 'Mental, Behavioral and Neurodevelopmental disorders' },\n      { chapter: '6', range: 'G00-G99', description: 'Diseases of the nervous system' },\n      { chapter: '7', range: 'H00-H59', description: 'Diseases of the eye and adnexa' },\n      { chapter: '8', range: 'H60-H95', description: 'Diseases of the ear and mastoid process' },\n      { chapter: '9', range: 'I00-I99', description: 'Diseases of the circulatory system' },\n      { chapter: '10', range: 'J00-J99', description: 'Diseases of the respiratory system' },\n      { chapter: '11', range: 'K00-K95', description: 'Diseases of the digestive system' },\n      { chapter: '12', range: 'L00-L99', description: 'Diseases of the skin and subcutaneous tissue' },\n      { chapter: '13', range: 'M00-M99', description: 'Diseases of the musculoskeletal system' },\n      { chapter: '14', range: 'N00-N99', description: 'Diseases of the genitourinary system' },\n      { chapter: '15', range: 'O00-O9A', description: 'Pregnancy, childbirth and the puerperium' },\n      { chapter: '16', range: 'P00-P96', description: 'Certain conditions originating in the perinatal period' },\n      { chapter: '17', range: 'Q00-Q99', description: 'Congenital malformations and chromosomal abnormalities' },\n      { chapter: '18', range: 'R00-R99', description: 'Symptoms, signs and abnormal findings' },\n      { chapter: '19', range: 'S00-T88', description: 'Injury, poisoning and external causes' },\n      { chapter: '20', range: 'V00-Y99', description: 'External causes of morbidity' },\n      { chapter: '21', range: 'Z00-Z99', description: 'Factors influencing health status' }\n    ];\n  }\n\n  /**\n   * Get codes in a chapter\n   * @param {string} chapter - Chapter number (e.g., \"4\")\n   * @param {Object} options - Options\n   * @returns {Promise<Array>} - Codes in the chapter\n   */\n  async getCodesByChapter(chapter, options = {}) {\n    const { limit = 100, offset = 0, billableOnly = true } = options;\n\n    const cacheKey = this._getCacheKey('chapter', `${chapter}:${limit}:${offset}:${billableOnly}`);\n    const cached = await this._getCached(cacheKey);\n    if (cached !== null) {\n      return cached;\n    }\n\n    try {\n      const conditions = [\n        eq(icd10_codes.chapter, chapter),\n        eq(icd10_codes.isActive, true)\n      ];\n\n      if (billableOnly) {\n        conditions.push(eq(icd10_codes.isBillable, true));\n      }\n\n      const results = await db.select()\n        .from(icd10_codes)\n        .where(and(...conditions))\n        .orderBy(asc(icd10_codes.code))\n        .limit(Number(limit))\n        .offset(Number(offset));\n\n      await this._setCached(cacheKey, results, 60 * 60); // 1 hour\n      return results;\n    } catch (error) {\n      logger.error('ICD10 getCodesByChapter error', { chapter, error: error.message });\n      return [];\n    }\n  }\n\n  // ============================================\n  // HOSPICE-SPECIFIC OPERATIONS\n  // ============================================\n\n  /**\n   * Get commonly used hospice diagnosis codes\n   * @param {number} limit - Max results\n   * @returns {Promise<Array>} - Common hospice codes\n   */\n  async getHospiceCodes(limit = 50) {\n    const cacheKey = this._getCacheKey('hospice', `common:${limit}`);\n    const cached = await this._getCached(cacheKey);\n    if (cached !== null) {\n      return cached;\n    }\n\n    try {\n      const results = await db.select()\n        .from(icd10_codes)\n        .where(and(\n          eq(icd10_codes.isActive, true),\n          eq(icd10_codes.isBillable, true),\n          eq(icd10_codes.isHospiceRelevant, true)\n        ))\n        .orderBy(desc(icd10_codes.usageCount), asc(icd10_codes.code))\n        .limit(Number(limit));\n\n      await this._setCached(cacheKey, results, 60 * 60 * 4); // 4 hours\n      return results;\n    } catch (error) {\n      logger.error('ICD10 getHospiceCodes error', { error: error.message });\n      return [];\n    }\n  }\n\n  /**\n   * Mark codes as hospice-relevant\n   * @param {Array<string>} codes - Array of ICD-10 codes\n   * @returns {Promise<number>} - Number of codes updated\n   */\n  async markHospiceRelevant(codes) {\n    if (!Array.isArray(codes) || codes.length === 0) {\n      return 0;\n    }\n\n    const normalizedCodes = codes.map(c => this.normalize(c)).filter(c => this.validateFormat(c));\n\n    try {\n      let updatedCount = 0;\n      for (const code of normalizedCodes) {\n        const result = await db.update(icd10_codes)\n          .set({\n            isHospiceRelevant: true,\n            updatedAt: new Date()\n          })\n          .where(eq(icd10_codes.code, code));\n\n        if (result.rowCount > 0) {\n          updatedCount++;\n        }\n      }\n\n      // Clear hospice cache\n      await this.clearCache();\n\n      return updatedCount;\n    } catch (error) {\n      logger.error('ICD10 markHospiceRelevant error', { error: error.message });\n      return 0;\n    }\n  }\n\n  // ============================================\n  // SEEDING OPERATIONS\n  // ============================================\n\n  /**\n   * Seed ICD-10 codes from provided data\n   * @param {Array} codes - Array of code objects\n   * @returns {Promise<Object>} - { inserted: number, updated: number, errors: number }\n   */\n  async seedCodes(codes) {\n    if (!Array.isArray(codes) || codes.length === 0) {\n      return { inserted: 0, updated: 0, errors: 0 };\n    }\n\n    const stats = { inserted: 0, updated: 0, errors: 0 };\n\n    for (const codeData of codes) {\n      try {\n        // Check if code exists\n        const [existing] = await db.select({ id: icd10_codes.id })\n          .from(icd10_codes)\n          .where(eq(icd10_codes.code, codeData.code))\n          .limit(1);\n\n        if (existing) {\n          // Update existing\n          await db.update(icd10_codes)\n            .set({\n              ...codeData,\n              updatedAt: new Date()\n            })\n            .where(eq(icd10_codes.code, codeData.code));\n          stats.updated++;\n        } else {\n          // Insert new\n          await db.insert(icd10_codes).values({\n            ...codeData,\n            createdAt: new Date(),\n            updatedAt: new Date()\n          });\n          stats.inserted++;\n        }\n      } catch (error) {\n        logger.error('ICD10 seed error for code', { code: codeData.code, error: error.message });\n        stats.errors++;\n      }\n    }\n\n    // Clear cache after seeding\n    await this.clearCache();\n\n    return stats;\n  }\n\n  /**\n   * Get total count of ICD-10 codes\n   * @returns {Promise<number>}\n   */\n  async getTotalCount() {\n    const cacheKey = this._getCacheKey('stats', 'total');\n    const cached = await this._getCached(cacheKey);\n    if (cached !== null) {\n      return cached;\n    }\n\n    try {\n      const [result] = await db.select({\n        count: sql`COUNT(*)::int`\n      }).from(icd10_codes);\n\n      const count = result?.count || 0;\n      await this._setCached(cacheKey, count, 60 * 60 * 24); // 24 hours\n      return count;\n    } catch (error) {\n      logger.error('ICD10 getTotalCount error', { error: error.message });\n      return 0;\n    }\n  }\n}\n\n// Export singleton instance\nexport default new ICD10Service();\n"
}

ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore existing codebase structure for services and patterns",
      "status": "completed",
      "activeForm": "Exploring existing codebase structure"
    },
    {
      "content": "Create ICD-10 database schema",
      "status": "completed",
      "activeForm": "Creating ICD-10 database schema"
    },
    {
      "content": "Implement enhanced ICD-10 service with caching",
      "status": "completed",
      "activeForm": "Implementing enhanced ICD-10 service"
    },
    {
      "content": "Create ICD-10 controller with autocomplete endpoints",
      "status": "in_progress",
      "activeForm": "Creating ICD-10 controller"
    },
    {
      "content": "Create ICD-10 routes",
      "status": "pending",
      "activeForm": "Creating ICD-10 routes"
    },
    {
      "content": "Register routes in api.routes.js",
      "status": "pending",
      "activeForm": "Registering ICD-10 routes"
    },
    {
      "content": "Seed ICD-10 data (10,000+ codes)",
      "status": "pending",
      "activeForm": "Seeding ICD-10 data"
    },
    {
      "content": "Create Playwright verification test",
      "status": "pending",
      "activeForm": "Creating Playwright verification test"
    },
    {
      "content": "Run verification and fix any issues",
      "status": "pending",
      "activeForm": "Running verification tests"
    },
    {
      "content": "Clean up verification test file",
      "status": "pending",
      "activeForm": "Cleaning up verification test"
    }
  ]
}

Now let me create the ICD-10 controller.

ðŸ”§ Tool: Write
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/ICD10.controller.js",
  "content": "import ICD10Service from '../services/ICD10.service.js';\nimport { logger } from '../utils/logger.js';\n\n/**\n * ICD-10 Controller\n *\n * Provides API endpoints for ICD-10 diagnosis code lookup with:\n * - Fast autocomplete suggestions (<200ms target)\n * - Exact code lookups\n * - Full-text search\n * - Chapter and category browsing\n * - Cache statistics\n * - Hospice-relevant code filtering\n */\nclass ICD10Controller {\n  // ============================================\n  // AUTOCOMPLETE ENDPOINTS\n  // ============================================\n\n  /**\n   * Autocomplete ICD-10 codes\n   * GET /api/icd10/autocomplete\n   *\n   * Fast autocomplete for diagnosis code selection in forms.\n   * Searches by code prefix (e.g., \"E11\") or description text (e.g., \"diabetes\").\n   * Optimized for sub-200ms response time.\n   */\n  async autocomplete(req, res) {\n    const startTime = Date.now();\n\n    try {\n      const {\n        q: query,\n        limit = 20,\n        billableOnly = 'true',\n        hospiceRelevant = 'false'\n      } = req.query;\n\n      if (!query || query.length < 2) {\n        return res.json({\n          success: true,\n          results: [],\n          count: 0,\n          responseTimeMs: Date.now() - startTime,\n          message: 'Query must be at least 2 characters'\n        });\n      }\n\n      const results = await ICD10Service.autocomplete(query, {\n        limit: Math.min(Number(limit), 50),\n        billableOnly: billableOnly === 'true',\n        hospiceRelevant: hospiceRelevant === 'true'\n      });\n\n      const responseTimeMs = Date.now() - startTime;\n\n      res.json({\n        success: true,\n        results,\n        count: results.length,\n        responseTimeMs,\n        cached: responseTimeMs < 20 // Likely cache hit if < 20ms\n      });\n    } catch (error) {\n      logger.error('ICD10 autocomplete error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to search ICD-10 codes',\n        message: error.message,\n        responseTimeMs: Date.now() - startTime\n      });\n    }\n  }\n\n  // ============================================\n  // LOOKUP ENDPOINTS\n  // ============================================\n\n  /**\n   * Get ICD-10 code by exact code\n   * GET /api/icd10/codes/:code\n   */\n  async getByCode(req, res) {\n    try {\n      const { code } = req.params;\n\n      if (!ICD10Service.validateFormat(code)) {\n        return res.status(400).json({\n          success: false,\n          error: 'Invalid ICD-10 code format',\n          message: `'${code}' is not a valid ICD-10 code format. Expected format: Letter + 2 digits + optional decimal + 1-4 characters (e.g., E11.9, A00.0)`\n        });\n      }\n\n      const result = await ICD10Service.getByCode(code);\n\n      if (!result) {\n        return res.status(404).json({\n          success: false,\n          error: 'ICD-10 code not found',\n          message: `No ICD-10 code found with code: ${code.toUpperCase()}`\n        });\n      }\n\n      // Add category info\n      const categoryInfo = ICD10Service.getCategory(code);\n\n      res.json({\n        success: true,\n        code: {\n          ...result,\n          categoryInfo\n        }\n      });\n    } catch (error) {\n      logger.error('ICD10 getByCode error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to retrieve ICD-10 code',\n        message: error.message\n      });\n    }\n  }\n\n  /**\n   * Validate ICD-10 code format\n   * POST /api/icd10/validate\n   */\n  async validateCode(req, res) {\n    try {\n      const { code, codes } = req.body;\n\n      // Single code validation\n      if (code) {\n        const isValid = ICD10Service.validateFormat(code);\n        const exists = isValid ? await ICD10Service.getByCode(code) : null;\n\n        return res.json({\n          success: true,\n          code,\n          isValidFormat: isValid,\n          existsInDatabase: !!exists,\n          normalizedCode: isValid ? ICD10Service.normalize(code) : null,\n          categoryInfo: isValid ? ICD10Service.getCategory(code) : null\n        });\n      }\n\n      // Multiple codes validation\n      if (codes && Array.isArray(codes)) {\n        const results = ICD10Service.validateCodes(codes);\n\n        // Check which valid codes exist in database\n        const existenceChecks = await Promise.all(\n          results.valid.map(async (c) => ({\n            code: c,\n            exists: !!(await ICD10Service.getByCode(c))\n          }))\n        );\n\n        return res.json({\n          success: true,\n          validCodes: results.valid,\n          invalidCodes: results.invalid,\n          validCount: results.valid.length,\n          invalidCount: results.invalid.length,\n          existenceChecks\n        });\n      }\n\n      return res.status(400).json({\n        success: false,\n        error: 'Missing required parameter',\n        message: 'Provide either \"code\" or \"codes\" in request body'\n      });\n    } catch (error) {\n      logger.error('ICD10 validateCode error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to validate ICD-10 code(s)',\n        message: error.message\n      });\n    }\n  }\n\n  // ============================================\n  // SEARCH ENDPOINTS\n  // ============================================\n\n  /**\n   * Full-text search for ICD-10 codes\n   * GET /api/icd10/search\n   */\n  async search(req, res) {\n    try {\n      const {\n        q: query,\n        limit = 50,\n        offset = 0,\n        billableOnly = 'false',\n        chapter,\n        category\n      } = req.query;\n\n      if (!query) {\n        return res.status(400).json({\n          success: false,\n          error: 'Missing search query',\n          message: 'Provide \"q\" query parameter'\n        });\n      }\n\n      const result = await ICD10Service.search(query, {\n        limit: Math.min(Number(limit), 200),\n        offset: Number(offset),\n        billableOnly: billableOnly === 'true',\n        chapter,\n        category\n      });\n\n      res.json({\n        success: true,\n        results: result.results,\n        count: result.results.length,\n        total: result.total,\n        query,\n        filters: { billableOnly: billableOnly === 'true', chapter, category }\n      });\n    } catch (error) {\n      logger.error('ICD10 search error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to search ICD-10 codes',\n        message: error.message\n      });\n    }\n  }\n\n  // ============================================\n  // CHAPTER & CATEGORY ENDPOINTS\n  // ============================================\n\n  /**\n   * List all ICD-10 chapters\n   * GET /api/icd10/chapters\n   */\n  async listChapters(req, res) {\n    try {\n      const chapters = ICD10Service.listChapters();\n\n      res.json({\n        success: true,\n        chapters,\n        count: chapters.length\n      });\n    } catch (error) {\n      logger.error('ICD10 listChapters error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to list chapters',\n        message: error.message\n      });\n    }\n  }\n\n  /**\n   * Get codes in a specific chapter\n   * GET /api/icd10/chapters/:chapter/codes\n   */\n  async getCodesByChapter(req, res) {\n    try {\n      const { chapter } = req.params;\n      const { limit = 100, offset = 0, billableOnly = 'true' } = req.query;\n\n      const codes = await ICD10Service.getCodesByChapter(chapter, {\n        limit: Math.min(Number(limit), 500),\n        offset: Number(offset),\n        billableOnly: billableOnly === 'true'\n      });\n\n      res.json({\n        success: true,\n        chapter,\n        codes,\n        count: codes.length\n      });\n    } catch (error) {\n      logger.error('ICD10 getCodesByChapter error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get codes by chapter',\n        message: error.message\n      });\n    }\n  }\n\n  /**\n   * Get category information for a code\n   * GET /api/icd10/category/:code\n   */\n  async getCategory(req, res) {\n    try {\n      const { code } = req.params;\n\n      const categoryInfo = ICD10Service.getCategory(code);\n\n      if (!categoryInfo || categoryInfo.chapter === 'Unknown') {\n        return res.status(400).json({\n          success: false,\n          error: 'Invalid code or category not found',\n          message: `Could not determine category for: ${code}`\n        });\n      }\n\n      res.json({\n        success: true,\n        code,\n        normalizedCode: ICD10Service.normalize(code),\n        categoryCode: ICD10Service.getCategoryCode(code),\n        categoryInfo\n      });\n    } catch (error) {\n      logger.error('ICD10 getCategory error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get category',\n        message: error.message\n      });\n    }\n  }\n\n  // ============================================\n  // HOSPICE-SPECIFIC ENDPOINTS\n  // ============================================\n\n  /**\n   * Get hospice-relevant diagnosis codes\n   * GET /api/icd10/hospice\n   */\n  async getHospiceCodes(req, res) {\n    try {\n      const { limit = 50 } = req.query;\n\n      const codes = await ICD10Service.getHospiceCodes(Math.min(Number(limit), 200));\n\n      res.json({\n        success: true,\n        codes,\n        count: codes.length,\n        description: 'Common hospice-relevant diagnosis codes'\n      });\n    } catch (error) {\n      logger.error('ICD10 getHospiceCodes error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get hospice codes',\n        message: error.message\n      });\n    }\n  }\n\n  /**\n   * Mark codes as hospice-relevant\n   * POST /api/icd10/hospice/mark\n   */\n  async markHospiceRelevant(req, res) {\n    try {\n      const { codes } = req.body;\n\n      if (!codes || !Array.isArray(codes) || codes.length === 0) {\n        return res.status(400).json({\n          success: false,\n          error: 'Invalid request',\n          message: 'Provide \"codes\" array in request body'\n        });\n      }\n\n      const updatedCount = await ICD10Service.markHospiceRelevant(codes);\n\n      res.json({\n        success: true,\n        message: `Marked ${updatedCount} codes as hospice-relevant`,\n        updatedCount,\n        requestedCount: codes.length\n      });\n    } catch (error) {\n      logger.error('ICD10 markHospiceRelevant error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to mark hospice-relevant codes',\n        message: error.message\n      });\n    }\n  }\n\n  // ============================================\n  // STATISTICS & CACHE ENDPOINTS\n  // ============================================\n\n  /**\n   * Get ICD-10 service statistics\n   * GET /api/icd10/stats\n   */\n  async getStats(req, res) {\n    try {\n      const [totalCount, cacheStats] = await Promise.all([\n        ICD10Service.getTotalCount(),\n        Promise.resolve(ICD10Service.getCacheStats())\n      ]);\n\n      res.json({\n        success: true,\n        stats: {\n          totalCodes: totalCount,\n          cache: cacheStats\n        }\n      });\n    } catch (error) {\n      logger.error('ICD10 getStats error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to get statistics',\n        message: error.message\n      });\n    }\n  }\n\n  /**\n   * Clear ICD-10 cache\n   * POST /api/icd10/cache/clear\n   */\n  async clearCache(req, res) {\n    try {\n      await ICD10Service.clearCache();\n\n      res.json({\n        success: true,\n        message: 'ICD-10 cache cleared successfully'\n      });\n    } catch (error) {\n      logger.error('ICD10 clearCache error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to clear cache',\n        message: error.message\n      });\n    }\n  }\n\n  // ============================================\n  // SEEDING ENDPOINTS (Admin only)\n  // ============================================\n\n  /**\n   * Seed ICD-10 codes\n   * POST /api/icd10/seed\n   */\n  async seedCodes(req, res) {\n    try {\n      // Generate common hospice-relevant ICD-10 codes for seeding\n      const hospiceCodes = this._generateHospiceICD10Codes();\n\n      const result = await ICD10Service.seedCodes(hospiceCodes);\n\n      res.json({\n        success: true,\n        message: 'ICD-10 codes seeded successfully',\n        ...result,\n        totalSeeded: result.inserted + result.updated\n      });\n    } catch (error) {\n      logger.error('ICD10 seedCodes error:', error);\n      res.status(500).json({\n        success: false,\n        error: 'Failed to seed ICD-10 codes',\n        message: error.message\n      });\n    }\n  }\n\n  /**\n   * Generate hospice-relevant ICD-10 codes for seeding\n   * @private\n   */\n  _generateHospiceICD10Codes() {\n    // Comprehensive list of hospice-relevant ICD-10 codes\n    // This includes common diagnoses in hospice care\n    const codes = [\n      // Cancer codes (C00-C97)\n      { code: 'C18.9', shortDescription: 'Malignant neoplasm of colon, unspecified', longDescription: 'Malignant neoplasm of colon, unspecified site', categoryCode: 'C18', categoryDescription: 'Malignant neoplasm of colon', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C34.90', shortDescription: 'Malignant neoplasm of unspecified part of bronchus or lung', longDescription: 'Malignant neoplasm of unspecified part of unspecified bronchus or lung', categoryCode: 'C34', categoryDescription: 'Malignant neoplasm of bronchus and lung', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C50.919', shortDescription: 'Malignant neoplasm of unspecified site of unspecified female breast', longDescription: 'Malignant neoplasm of unspecified site of unspecified female breast', categoryCode: 'C50', categoryDescription: 'Malignant neoplasm of breast', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C61', shortDescription: 'Malignant neoplasm of prostate', longDescription: 'Malignant neoplasm of prostate', categoryCode: 'C61', categoryDescription: 'Malignant neoplasm of prostate', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C25.9', shortDescription: 'Malignant neoplasm of pancreas, unspecified', longDescription: 'Malignant neoplasm of pancreas, unspecified', categoryCode: 'C25', categoryDescription: 'Malignant neoplasm of pancreas', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C78.7', shortDescription: 'Secondary malignant neoplasm of liver and intrahepatic bile duct', longDescription: 'Secondary malignant neoplasm of liver and intrahepatic bile duct', categoryCode: 'C78', categoryDescription: 'Secondary malignant neoplasm of respiratory and digestive organs', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C80.1', shortDescription: 'Malignant (primary) neoplasm, unspecified', longDescription: 'Malignant (primary) neoplasm, unspecified', categoryCode: 'C80', categoryDescription: 'Malignant neoplasm without specification of site', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C71.9', shortDescription: 'Malignant neoplasm of brain, unspecified', longDescription: 'Malignant neoplasm of brain, unspecified', categoryCode: 'C71', categoryDescription: 'Malignant neoplasm of brain', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C22.0', shortDescription: 'Liver cell carcinoma', longDescription: 'Liver cell carcinoma (hepatocellular carcinoma)', categoryCode: 'C22', categoryDescription: 'Malignant neoplasm of liver and intrahepatic bile ducts', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'C16.9', shortDescription: 'Malignant neoplasm of stomach, unspecified', longDescription: 'Malignant neoplasm of stomach, unspecified', categoryCode: 'C16', categoryDescription: 'Malignant neoplasm of stomach', chapter: '2', chapterDescription: 'Neoplasms', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Heart disease codes (I00-I99)\n      { code: 'I50.9', shortDescription: 'Heart failure, unspecified', longDescription: 'Heart failure, unspecified', categoryCode: 'I50', categoryDescription: 'Heart failure', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'I50.22', shortDescription: 'Chronic systolic (congestive) heart failure', longDescription: 'Chronic systolic (congestive) heart failure', categoryCode: 'I50', categoryDescription: 'Heart failure', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'I50.32', shortDescription: 'Chronic diastolic (congestive) heart failure', longDescription: 'Chronic diastolic (congestive) heart failure', categoryCode: 'I50', categoryDescription: 'Heart failure', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'I25.10', shortDescription: 'Atherosclerotic heart disease of native coronary artery without angina pectoris', longDescription: 'Atherosclerotic heart disease of native coronary artery without angina pectoris', categoryCode: 'I25', categoryDescription: 'Chronic ischemic heart disease', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'I42.9', shortDescription: 'Cardiomyopathy, unspecified', longDescription: 'Cardiomyopathy, unspecified', categoryCode: 'I42', categoryDescription: 'Cardiomyopathy', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Dementia codes (F00-F09, G30)\n      { code: 'F03.90', shortDescription: 'Unspecified dementia without behavioral disturbance', longDescription: 'Unspecified dementia without behavioral disturbance, unspecified severity', categoryCode: 'F03', categoryDescription: 'Unspecified dementia', chapter: '5', chapterDescription: 'Mental, Behavioral and Neurodevelopmental disorders', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'G30.9', shortDescription: 'Alzheimer disease, unspecified', longDescription: 'Alzheimer disease, unspecified', categoryCode: 'G30', categoryDescription: 'Alzheimer disease', chapter: '6', chapterDescription: 'Diseases of the nervous system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'G30.0', shortDescription: 'Alzheimer disease with early onset', longDescription: 'Alzheimer disease with early onset', categoryCode: 'G30', categoryDescription: 'Alzheimer disease', chapter: '6', chapterDescription: 'Diseases of the nervous system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'G30.1', shortDescription: 'Alzheimer disease with late onset', longDescription: 'Alzheimer disease with late onset', categoryCode: 'G30', categoryDescription: 'Alzheimer disease', chapter: '6', chapterDescription: 'Diseases of the nervous system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'F01.50', shortDescription: 'Vascular dementia without behavioral disturbance', longDescription: 'Vascular dementia, unspecified severity, without behavioral disturbance', categoryCode: 'F01', categoryDescription: 'Vascular dementia', chapter: '5', chapterDescription: 'Mental, Behavioral and Neurodevelopmental disorders', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // COPD and respiratory codes (J40-J47)\n      { code: 'J44.9', shortDescription: 'Chronic obstructive pulmonary disease, unspecified', longDescription: 'Chronic obstructive pulmonary disease, unspecified', categoryCode: 'J44', categoryDescription: 'Other chronic obstructive pulmonary disease', chapter: '10', chapterDescription: 'Diseases of the respiratory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'J44.1', shortDescription: 'Chronic obstructive pulmonary disease with acute exacerbation', longDescription: 'Chronic obstructive pulmonary disease with (acute) exacerbation', categoryCode: 'J44', categoryDescription: 'Other chronic obstructive pulmonary disease', chapter: '10', chapterDescription: 'Diseases of the respiratory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'J84.10', shortDescription: 'Pulmonary fibrosis, unspecified', longDescription: 'Pulmonary fibrosis, unspecified', categoryCode: 'J84', categoryDescription: 'Other interstitial pulmonary diseases', chapter: '10', chapterDescription: 'Diseases of the respiratory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'J96.10', shortDescription: 'Chronic respiratory failure, unspecified whether with hypoxia or hypercapnia', longDescription: 'Chronic respiratory failure, unspecified whether with hypoxia or hypercapnia', categoryCode: 'J96', categoryDescription: 'Respiratory failure, not elsewhere classified', chapter: '10', chapterDescription: 'Diseases of the respiratory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Kidney disease codes (N17-N19)\n      { code: 'N18.6', shortDescription: 'End stage renal disease', longDescription: 'End stage renal disease', categoryCode: 'N18', categoryDescription: 'Chronic kidney disease (CKD)', chapter: '14', chapterDescription: 'Diseases of the genitourinary system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'N18.5', shortDescription: 'Chronic kidney disease, stage 5', longDescription: 'Chronic kidney disease, stage 5', categoryCode: 'N18', categoryDescription: 'Chronic kidney disease (CKD)', chapter: '14', chapterDescription: 'Diseases of the genitourinary system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'N18.4', shortDescription: 'Chronic kidney disease, stage 4 (severe)', longDescription: 'Chronic kidney disease, stage 4 (severe)', categoryCode: 'N18', categoryDescription: 'Chronic kidney disease (CKD)', chapter: '14', chapterDescription: 'Diseases of the genitourinary system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Liver disease codes (K70-K77)\n      { code: 'K74.60', shortDescription: 'Unspecified cirrhosis of liver', longDescription: 'Unspecified cirrhosis of liver', categoryCode: 'K74', categoryDescription: 'Fibrosis and cirrhosis of liver', chapter: '11', chapterDescription: 'Diseases of the digestive system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'K70.30', shortDescription: 'Alcoholic cirrhosis of liver without ascites', longDescription: 'Alcoholic cirrhosis of liver without ascites', categoryCode: 'K70', categoryDescription: 'Alcoholic liver disease', chapter: '11', chapterDescription: 'Diseases of the digestive system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'K72.90', shortDescription: 'Hepatic failure, unspecified without coma', longDescription: 'Hepatic failure, unspecified without coma', categoryCode: 'K72', categoryDescription: 'Hepatic failure, not elsewhere classified', chapter: '11', chapterDescription: 'Diseases of the digestive system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Neurological disease codes\n      { code: 'G20', shortDescription: 'Parkinson disease', longDescription: 'Parkinson disease', categoryCode: 'G20', categoryDescription: 'Parkinson disease', chapter: '6', chapterDescription: 'Diseases of the nervous system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'G12.21', shortDescription: 'Amyotrophic lateral sclerosis', longDescription: 'Amyotrophic lateral sclerosis', categoryCode: 'G12', categoryDescription: 'Spinal muscular atrophy and related syndromes', chapter: '6', chapterDescription: 'Diseases of the nervous system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'G35', shortDescription: 'Multiple sclerosis', longDescription: 'Multiple sclerosis', categoryCode: 'G35', categoryDescription: 'Multiple sclerosis', chapter: '6', chapterDescription: 'Diseases of the nervous system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // HIV/AIDS codes\n      { code: 'B20', shortDescription: 'Human immunodeficiency virus [HIV] disease', longDescription: 'Human immunodeficiency virus [HIV] disease', categoryCode: 'B20', categoryDescription: 'Human immunodeficiency virus [HIV] disease', chapter: '1', chapterDescription: 'Certain infectious and parasitic diseases', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Stroke codes\n      { code: 'I63.9', shortDescription: 'Cerebral infarction, unspecified', longDescription: 'Cerebral infarction, unspecified', categoryCode: 'I63', categoryDescription: 'Cerebral infarction', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'I69.30', shortDescription: 'Unspecified sequelae of cerebral infarction', longDescription: 'Unspecified sequelae of cerebral infarction', categoryCode: 'I69', categoryDescription: 'Sequelae of cerebrovascular disease', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Diabetes codes\n      { code: 'E11.9', shortDescription: 'Type 2 diabetes mellitus without complications', longDescription: 'Type 2 diabetes mellitus without complications', categoryCode: 'E11', categoryDescription: 'Type 2 diabetes mellitus', chapter: '4', chapterDescription: 'Endocrine, nutritional and metabolic diseases', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'E11.65', shortDescription: 'Type 2 diabetes mellitus with hyperglycemia', longDescription: 'Type 2 diabetes mellitus with hyperglycemia', categoryCode: 'E11', categoryDescription: 'Type 2 diabetes mellitus', chapter: '4', chapterDescription: 'Endocrine, nutritional and metabolic diseases', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'E10.9', shortDescription: 'Type 1 diabetes mellitus without complications', longDescription: 'Type 1 diabetes mellitus without complications', categoryCode: 'E10', categoryDescription: 'Type 1 diabetes mellitus', chapter: '4', chapterDescription: 'Endocrine, nutritional and metabolic diseases', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Common symptom codes often used in hospice\n      { code: 'R53.83', shortDescription: 'Other fatigue', longDescription: 'Other fatigue', categoryCode: 'R53', categoryDescription: 'Malaise and fatigue', chapter: '18', chapterDescription: 'Symptoms, signs and abnormal findings', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'R64', shortDescription: 'Cachexia', longDescription: 'Cachexia', categoryCode: 'R64', categoryDescription: 'Cachexia', chapter: '18', chapterDescription: 'Symptoms, signs and abnormal findings', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'R63.4', shortDescription: 'Abnormal weight loss', longDescription: 'Abnormal weight loss', categoryCode: 'R63', categoryDescription: 'Symptoms and signs concerning food and fluid intake', chapter: '18', chapterDescription: 'Symptoms, signs and abnormal findings', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Debility/Failure to thrive\n      { code: 'R54', shortDescription: 'Age-related physical debility', longDescription: 'Age-related physical debility (frailty, senility)', categoryCode: 'R54', categoryDescription: 'Age-related physical debility', chapter: '18', chapterDescription: 'Symptoms, signs and abnormal findings', isBillable: true, isCommon: true, isHospiceRelevant: true },\n      { code: 'R62.7', shortDescription: 'Adult failure to thrive', longDescription: 'Adult failure to thrive', categoryCode: 'R62', categoryDescription: 'Lack of expected normal physiological development', chapter: '18', chapterDescription: 'Symptoms, signs and abnormal findings', isBillable: true, isCommon: true, isHospiceRelevant: true },\n\n      // Additional common general codes\n      { code: 'J18.9', shortDescription: 'Pneumonia, unspecified organism', longDescription: 'Pneumonia, unspecified organism', categoryCode: 'J18', categoryDescription: 'Pneumonia, unspecified organism', chapter: '10', chapterDescription: 'Diseases of the respiratory system', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'N39.0', shortDescription: 'Urinary tract infection, site not specified', longDescription: 'Urinary tract infection, site not specified', categoryCode: 'N39', categoryDescription: 'Other disorders of urinary system', chapter: '14', chapterDescription: 'Diseases of the genitourinary system', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'I10', shortDescription: 'Essential (primary) hypertension', longDescription: 'Essential (primary) hypertension', categoryCode: 'I10', categoryDescription: 'Essential (primary) hypertension', chapter: '9', chapterDescription: 'Diseases of the circulatory system', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'E78.5', shortDescription: 'Hyperlipidemia, unspecified', longDescription: 'Hyperlipidemia, unspecified', categoryCode: 'E78', categoryDescription: 'Disorders of lipoprotein metabolism and other lipidemias', chapter: '4', chapterDescription: 'Endocrine, nutritional and metabolic diseases', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'M54.5', shortDescription: 'Low back pain', longDescription: 'Low back pain', categoryCode: 'M54', categoryDescription: 'Dorsalgia', chapter: '13', chapterDescription: 'Diseases of the musculoskeletal system', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'K21.0', shortDescription: 'Gastro-esophageal reflux disease with esophagitis', longDescription: 'Gastro-esophageal reflux disease with esophagitis', categoryCode: 'K21', categoryDescription: 'Gastro-esophageal reflux disease', chapter: '11', chapterDescription: 'Diseases of the digestive system', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'F32.9', shortDescription: 'Major depressive disorder, single episode, unspecified', longDescription: 'Major depressive disorder, single episode, unspecified', categoryCode: 'F32', categoryDescription: 'Major depressive disorder, single episode', chapter: '5', chapterDescription: 'Mental, Behavioral and Neurodevelopmental disorders', isBillable: true, isCommon: true, isHospiceRelevant: false },\n      { code: 'F41.1', shortDescription: 'Generalized anxiety disorder', longDescription: 'Generalized anxiety disorder', categoryCode: 'F41', categoryDescription: 'Other anxiety disorders', chapter: '5', chapterDescription: 'Mental, Behavioral and Neurodevelopmental disorders', isBillable: true, isCommon: true, isHospiceRelevant: false },\n    ];\n\n    // Set default values\n    return codes.map(code => ({\n      ...code,\n      codeLength: code.code.replace('.', '').length,\n      isActive: true,\n      usageCount: 0,\n      version: '2024'\n    }));\n  }\n}\n\nexport default new ICD10Controller();\n"
}

You've hit your limit Â· resets 4pm (America/Los_Angeles)