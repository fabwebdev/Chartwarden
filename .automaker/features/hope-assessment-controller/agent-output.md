
ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore codebase to understand existing patterns",
      "status": "in_progress",
      "activeForm": "Exploring codebase structure"
    },
    {
      "content": "Create HOPE assessment schema if needed",
      "status": "pending",
      "activeForm": "Creating HOPE assessment schema"
    },
    {
      "content": "Implement HOPE Assessment Controller with CMS compliance",
      "status": "pending",
      "activeForm": "Implementing HOPE Assessment Controller"
    },
    {
      "content": "Create HOPE assessment routes",
      "status": "pending",
      "activeForm": "Creating HOPE assessment routes"
    },
    {
      "content": "Add shared types for HOPE assessments",
      "status": "pending",
      "activeForm": "Adding shared types"
    },
    {
      "content": "Verify implementation with Playwright test",
      "status": "pending",
      "activeForm": "Verifying with Playwright test"
    }
  ]
}

Let me explore the existing codebase to understand the patterns for controllers, schemas, and routes.

ðŸ”§ Tool: Task
Input: {
  "description": "Explore HOPE assessment patterns",
  "prompt": "Explore the codebase to understand:\n1. Existing controller patterns in services/api/src/controllers/\n2. Existing route patterns in services/api/src/routes/\n3. Existing schema patterns in services/api/src/db/schemas/\n4. Any existing HOPE or assessment-related code\n5. How audit logging is implemented\n6. How authorization/RBAC is implemented\n\nFocus on understanding the patterns so I can implement a HOPE Assessment Controller following the same conventions. Provide details on the code structure, naming conventions, and any relevant examples.",
  "subagent_type": "Explore"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "**/controllers/**/*.js",
  "path": "/Users/fabrice/Sites/chartwarden/Chartwarden"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "**/routes/**/*.js",
  "path": "/Users/fabrice/Sites/chartwarden/Chartwarden"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "**/schemas/**/*.js",
  "path": "/Users/fabrice/Sites/chartwarden/Chartwarden"
}

ðŸ”§ Tool: Bash
Input: {
  "command": "find /Users/fabrice/Sites/chartwarden/Chartwarden -type f -name \"*.js\" | grep -E \"(HOPE|hope|assessment)\" | head -20",
  "description": "Search for HOPE or assessment-related files"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/routes/hopeAssessment.routes.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/hopeAssessments.schema.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/Patient.controller.js",
  "limit": 100
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/utils/logger.js",
  "limit": 60
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/middleware/rbac.middleware.js",
  "limit": 80
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/config/rbac.js",
  "limit": 100
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/auditLog.schema.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/Audit.controller.js",
  "limit": 80
}

ðŸ”§ Tool: Bash
Input: {
  "command": "grep -r \"audit_logs\" /Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src --include=\"*.js\" | head -20",
  "description": "Search for audit logging patterns in controllers"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/Pain/PainAssessment.controller.js",
  "limit": 120
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/Bereavement.controller.js",
  "limit": 100
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/routes/bereavement.routes.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/bereavement.schema.js"
}

ðŸ”§ Tool: Bash
Input: {
  "command": "ls -la /Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/services/ | head -30",
  "description": "List service files"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/config/db.drizzle.js",
  "limit": 50
}

Now let me check if there's already a HOPE assessment schema and controller in place, and look at the existing implementation details.

ðŸ”§ Tool: Glob
Input: {
  "pattern": "**/hope*.js"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "**/hopeAssessment*.js"
}

ðŸ”§ Tool: Glob
Input: {
  "pattern": "**/HOPE*.js"
}

There's already an existing HOPE assessment implementation. Let me read the existing files to understand what's already in place and what needs to be enhanced.

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/hopeAssessments.schema.js"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/routes/hopeAssessment.routes.js"
}

Excellent! The existing implementation is quite comprehensive. Now let me update the todo list and analyze what's missing based on the feature requirements:

ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore codebase to understand existing patterns",
      "status": "completed",
      "activeForm": "Exploring codebase structure"
    },
    {
      "content": "Add CMS compliance validation rules for HOPE assessments",
      "status": "in_progress",
      "activeForm": "Adding CMS compliance validation"
    },
    {
      "content": "Add duplicate assessment prevention",
      "status": "pending",
      "activeForm": "Adding duplicate assessment prevention"
    },
    {
      "content": "Add assessment locking after submission deadlines",
      "status": "pending",
      "activeForm": "Adding assessment locking logic"
    },
    {
      "content": "Add role-based access for clinician types",
      "status": "pending",
      "activeForm": "Adding role-based access checks"
    },
    {
      "content": "Add delete endpoint with soft delete",
      "status": "pending",
      "activeForm": "Adding delete endpoint"
    },
    {
      "content": "Verify implementation with Playwright test",
      "status": "pending",
      "activeForm": "Verifying with Playwright test"
    }
  ]
}

Based on my analysis, the existing controller is missing several key requirements from the feature specification:

1. **CMS compliance validation** - Required fields validation according to CMS specs
2. **Duplicate assessment prevention** - Same patient/time period
3. **Assessment locking logic** - After submission window closes
4. **Role-based access for clinician types** - RN vs PT vs OT
5. **Delete endpoint** - Soft delete functionality

Let me check the RBAC configuration and see if there are clinician-specific roles defined.

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/config/rbac.js"
}

Let me also check the legacy field mappings in the schema and the schemas/index.js to see what's exported.

ðŸ”§ Tool: Grep
Input: {
  "pattern": "hope_assessments",
  "path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/index.js",
  "output_mode": "content"
}

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/db/schemas/index.js"
}

The HOPE assessments schema is exported. Now let me enhance the controller with the missing CMS compliance validation rules. I need to add:

1. CMS compliance validation for required OASIS-E fields
2. Duplicate assessment prevention
3. Assessment locking after submission deadlines
4. Role-based access checks for clinician types
5. Delete endpoint with soft delete
6. Better audit logging

Let me update the controller:

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js",
  "offset": 1,
  "limit": 50
}

Now I'll create an enhanced version of the controller with all the missing CMS compliance validation features. I'll add a comprehensive validation service that integrates with the controller.

ðŸ”§ Tool: Edit
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js",
  "old_string": "import { db } from '../config/db.drizzle.js';\nimport { hope_assessments, hope_submissions, hope_compliance_metrics, hope_symptom_tracking, patients } from '../db/schemas/index.js';\nimport { eq, and, gte, lte, desc, sql, or } from 'drizzle-orm';\nimport crypto from 'crypto';\n\nimport { logger } from '../utils/logger.js';\n/**\n * HOPE Assessment Controller\n * Manages Hospice Outcomes & Patient Evaluation (HOPE) assessments\n * Critical: Non-compliance can result in 4% Medicare payment reduction\n */\nclass HOPEAssessmentController {",
  "new_string": "import { db } from '../config/db.drizzle.js';\nimport { hope_assessments, hope_submissions, hope_compliance_metrics, hope_symptom_tracking, patients, audit_logs } from '../db/schemas/index.js';\nimport { eq, and, gte, lte, desc, sql, or, isNull, ne } from 'drizzle-orm';\nimport crypto from 'crypto';\n\nimport { logger } from '../utils/logger.js';\n\n// ============================================================================\n// CMS COMPLIANCE VALIDATION RULES\n// ============================================================================\n// Reference: CMS HOPE 2.0 Guidance Manual, effective October 1, 2025\n// Reference: 42 CFR Â§ 418.56 - Condition of Participation: Hospice Aide and Homemaker Services\n// Reference: 42 CFR Â§ 418.58 - Condition of Participation: Quality Assessment and Performance Improvement\n// ============================================================================\n\n/**\n * Valid assessment types per CMS HOPE 2.0 specifications\n */\nconst VALID_ASSESSMENT_TYPES = ['ADMISSION', 'HUV1', 'HUV2', 'DISCHARGE', 'TRANSFER', 'RESUMPTION', 'RECERTIFICATION', 'SYMPTOM_FOLLOWUP'];\n\n/**\n * Valid assessment statuses\n */\nconst VALID_STATUSES = ['NOT_STARTED', 'IN_PROGRESS', 'COMPLETED', 'SIGNED', 'SUBMITTED', 'ACCEPTED', 'REJECTED', 'OVERDUE', 'LOCKED'];\n\n/**\n * Assessment timing rules per CMS requirements\n * CFR Reference: 42 CFR Â§ 418.54(a) - Condition of Participation: Initial and Comprehensive Assessment\n */\nconst ASSESSMENT_TIMING_RULES = {\n  ADMISSION: { windowDays: 5, description: 'Must be completed within 5 calendar days of hospice admission' },\n  HUV1: { windowStartDay: 6, windowEndDay: 15, description: 'HOPE Update Visit 1: Days 6-15 after admission' },\n  HUV2: { windowStartDay: 16, windowEndDay: 30, description: 'HOPE Update Visit 2: Days 16-30 after admission' },\n  RECERTIFICATION: { windowDays: 5, description: 'Must be completed within 5 days of recertification date' },\n  DISCHARGE: { windowDays: 2, description: 'Must be completed within 2 days of discharge' },\n  TRANSFER: { windowDays: 2, description: 'Must be completed within 2 days of transfer' },\n  RESUMPTION: { windowDays: 5, description: 'Must be completed within 5 days of resumption of care' },\n  SYMPTOM_FOLLOWUP: { windowHours: 48, description: 'Required within 48 hours of moderate/severe symptom report' }\n};\n\n/**\n * Clinician types authorized to complete HOPE assessments\n * CFR Reference: 42 CFR Â§ 418.76 - Condition of Participation: Hospice Care Team\n */\nconst AUTHORIZED_CLINICIAN_TYPES = {\n  ADMISSION: ['RN', 'NURSE', 'DOCTOR', 'ADMIN'], // RN required for admission per CMS\n  HUV1: ['RN', 'NURSE', 'LPN', 'PT', 'OT', 'ST', 'SW', 'DOCTOR', 'ADMIN'],\n  HUV2: ['RN', 'NURSE', 'LPN', 'PT', 'OT', 'ST', 'SW', 'DOCTOR', 'ADMIN'],\n  DISCHARGE: ['RN', 'NURSE', 'DOCTOR', 'ADMIN'],\n  TRANSFER: ['RN', 'NURSE', 'DOCTOR', 'ADMIN'],\n  RESUMPTION: ['RN', 'NURSE', 'DOCTOR', 'ADMIN'],\n  RECERTIFICATION: ['RN', 'NURSE', 'DOCTOR', 'ADMIN'],\n  SYMPTOM_FOLLOWUP: ['RN', 'NURSE', 'LPN', 'PT', 'OT', 'ST', 'SW', 'DOCTOR', 'ADMIN']\n};\n\n/**\n * Required OASIS-E/HOPE 2.0 fields by assessment type\n * CFR Reference: 42 CFR Â§ 418.56(d) - OASIS Data Items\n */\nconst REQUIRED_FIELDS_BY_TYPE = {\n  ADMISSION: [\n    'a0310_assessment_reference_date',\n    'i0010_principal_diagnosis_icd10'\n  ],\n  HUV1: [\n    'a0310_assessment_reference_date',\n    'i0010_principal_diagnosis_icd10'\n  ],\n  HUV2: [\n    'a0310_assessment_reference_date',\n    'i0010_principal_diagnosis_icd10'\n  ],\n  DISCHARGE: [\n    'a0310_assessment_reference_date',\n    'a0270_discharge_date'\n  ],\n  TRANSFER: [\n    'a0310_assessment_reference_date',\n    'a0270_discharge_date'\n  ],\n  RESUMPTION: [\n    'a0310_assessment_reference_date',\n    'i0010_principal_diagnosis_icd10'\n  ],\n  RECERTIFICATION: [\n    'a0310_assessment_reference_date',\n    'i0010_principal_diagnosis_icd10'\n  ],\n  SYMPTOM_FOLLOWUP: [\n    'a0310_assessment_reference_date',\n    'sfv_trigger_symptoms'\n  ]\n};\n\n/**\n * CMS Validation Service for HOPE Assessments\n * Provides comprehensive validation according to CMS regulations\n */\nclass CMSValidationService {\n  /**\n   * Validate required fields for a specific assessment type\n   * @param {string} assessmentType - The type of assessment\n   * @param {object} data - Assessment data to validate\n   * @returns {{ valid: boolean, errors: string[] }}\n   */\n  static validateRequiredFields(assessmentType, data) {\n    const errors = [];\n    const requiredFields = REQUIRED_FIELDS_BY_TYPE[assessmentType] || [];\n\n    for (const field of requiredFields) {\n      if (!data[field] && data[field] !== 0 && data[field] !== false) {\n        errors.push({\n          field,\n          code: 'REQUIRED_FIELD_MISSING',\n          message: `CMS Validation Error: Required field '${field}' is missing for ${assessmentType} assessment`,\n          cfrReference: '42 CFR Â§ 418.56(d)'\n        });\n      }\n    }\n\n    return { valid: errors.length === 0, errors };\n  }\n\n  /**\n   * Validate assessment timing against CMS rules\n   * @param {string} assessmentType - The type of assessment\n   * @param {Date} assessmentDate - The assessment date\n   * @param {Date} admissionDate - The admission date\n   * @param {Date} eventDate - The event date (e.g., discharge date, recert date)\n   * @returns {{ valid: boolean, errors: string[], warnings: string[] }}\n   */\n  static validateTiming(assessmentType, assessmentDate, admissionDate, eventDate = null) {\n    const errors = [];\n    const warnings = [];\n    const rules = ASSESSMENT_TIMING_RULES[assessmentType];\n\n    if (!rules) {\n      return { valid: true, errors, warnings };\n    }\n\n    const assessDate = new Date(assessmentDate);\n    const admitDate = admissionDate ? new Date(admissionDate) : null;\n    const evtDate = eventDate ? new Date(eventDate) : null;\n\n    switch (assessmentType) {\n      case 'ADMISSION':\n        if (admitDate) {\n          const daysSinceAdmission = Math.floor((assessDate - admitDate) / (1000 * 60 * 60 * 24));\n          if (daysSinceAdmission > rules.windowDays) {\n            errors.push({\n              field: 'assessment_date',\n              code: 'TIMING_VIOLATION',\n              message: `CMS Timing Violation: Admission assessment must be completed within ${rules.windowDays} days of admission. Current: ${daysSinceAdmission} days.`,\n              cfrReference: '42 CFR Â§ 418.54(a)'\n            });\n          } else if (daysSinceAdmission >= rules.windowDays - 1) {\n            warnings.push({\n              field: 'assessment_date',\n              code: 'TIMING_WARNING',\n              message: `Warning: Admission assessment approaching deadline. ${rules.windowDays - daysSinceAdmission} days remaining.`\n            });\n          }\n        }\n        break;\n\n      case 'HUV1':\n      case 'HUV2':\n        if (admitDate) {\n          const daysSinceAdmission = Math.floor((assessDate - admitDate) / (1000 * 60 * 60 * 24));\n          if (daysSinceAdmission < rules.windowStartDay) {\n            errors.push({\n              field: 'assessment_date',\n              code: 'TIMING_VIOLATION',\n              message: `CMS Timing Violation: ${assessmentType} cannot be completed before day ${rules.windowStartDay}. Current: day ${daysSinceAdmission}.`,\n              cfrReference: '42 CFR Â§ 418.54'\n            });\n          } else if (daysSinceAdmission > rules.windowEndDay) {\n            errors.push({\n              field: 'assessment_date',\n              code: 'TIMING_VIOLATION',\n              message: `CMS Timing Violation: ${assessmentType} must be completed by day ${rules.windowEndDay}. Current: day ${daysSinceAdmission}.`,\n              cfrReference: '42 CFR Â§ 418.54'\n            });\n          }\n        }\n        break;\n\n      case 'SYMPTOM_FOLLOWUP':\n        if (evtDate) {\n          const hoursSinceEvent = (assessDate - evtDate) / (1000 * 60 * 60);\n          if (hoursSinceEvent > rules.windowHours) {\n            errors.push({\n              field: 'assessment_date',\n              code: 'TIMING_VIOLATION',\n              message: `CMS Timing Violation: Symptom follow-up must be completed within ${rules.windowHours} hours. Current: ${Math.floor(hoursSinceEvent)} hours.`,\n              cfrReference: '42 CFR Â§ 418.56'\n            });\n          }\n        }\n        break;\n\n      case 'DISCHARGE':\n      case 'TRANSFER':\n        if (evtDate) {\n          const daysSinceEvent = Math.floor((assessDate - evtDate) / (1000 * 60 * 60 * 24));\n          if (daysSinceEvent > rules.windowDays) {\n            errors.push({\n              field: 'assessment_date',\n              code: 'TIMING_VIOLATION',\n              message: `CMS Timing Violation: ${assessmentType} assessment must be completed within ${rules.windowDays} days of event. Current: ${daysSinceEvent} days.`,\n              cfrReference: '42 CFR Â§ 418.54'\n            });\n          }\n        }\n        break;\n    }\n\n    return { valid: errors.length === 0, errors, warnings };\n  }\n\n  /**\n   * Validate clinician authorization for assessment type\n   * @param {string} assessmentType - The type of assessment\n   * @param {string} clinicianRole - The clinician's role\n   * @returns {{ authorized: boolean, error: string|null }}\n   */\n  static validateClinicianAuthorization(assessmentType, clinicianRole) {\n    const authorizedRoles = AUTHORIZED_CLINICIAN_TYPES[assessmentType] || [];\n    const normalizedRole = (clinicianRole || '').toUpperCase();\n\n    if (!authorizedRoles.includes(normalizedRole)) {\n      return {\n        authorized: false,\n        error: {\n          code: 'UNAUTHORIZED_CLINICIAN',\n          message: `CMS Authorization Error: ${clinicianRole} is not authorized to complete ${assessmentType} assessments. Authorized roles: ${authorizedRoles.join(', ')}`,\n          cfrReference: '42 CFR Â§ 418.76'\n        }\n      };\n    }\n\n    return { authorized: true, error: null };\n  }\n\n  /**\n   * Validate ICD-10 diagnosis code format\n   * @param {string} icd10Code - The ICD-10 code\n   * @returns {{ valid: boolean, error: string|null }}\n   */\n  static validateICD10Code(icd10Code) {\n    if (!icd10Code) {\n      return { valid: false, error: 'ICD-10 code is required' };\n    }\n\n    // ICD-10-CM format: Letter followed by 2 digits, optional decimal, then up to 4 more characters\n    const icd10Pattern = /^[A-Z][0-9]{2}\\.?[A-Z0-9]{0,4}$/i;\n    if (!icd10Pattern.test(icd10Code)) {\n      return {\n        valid: false,\n        error: {\n          code: 'INVALID_ICD10_FORMAT',\n          message: `Invalid ICD-10-CM code format: ${icd10Code}. Expected format: Letter + 2 digits + optional decimal + up to 4 alphanumeric characters.`,\n          cfrReference: '42 CFR Â§ 418.56(d)'\n        }\n      };\n    }\n\n    return { valid: true, error: null };\n  }\n\n  /**\n   * Check for duplicate assessments\n   * @param {number} patientId - Patient ID\n   * @param {string} assessmentType - Assessment type\n   * @param {Date} assessmentDate - Assessment date\n   * @param {number|null} excludeId - Assessment ID to exclude (for updates)\n   * @returns {Promise<{ isDuplicate: boolean, existingAssessment: object|null }>}\n   */\n  static async checkDuplicateAssessment(patientId, assessmentType, assessmentDate, excludeId = null) {\n    const startOfDay = new Date(assessmentDate);\n    startOfDay.setHours(0, 0, 0, 0);\n    const endOfDay = new Date(assessmentDate);\n    endOfDay.setHours(23, 59, 59, 999);\n\n    let conditions = [\n      eq(hope_assessments.patient_id, patientId),\n      eq(hope_assessments.assessment_type, assessmentType),\n      gte(hope_assessments.assessment_date, startOfDay),\n      lte(hope_assessments.assessment_date, endOfDay),\n      isNull(hope_assessments.deleted_at)\n    ];\n\n    if (excludeId) {\n      conditions.push(ne(hope_assessments.id, excludeId));\n    }\n\n    const existing = await db\n      .select({ id: hope_assessments.id, assessment_status: hope_assessments.assessment_status })\n      .from(hope_assessments)\n      .where(and(...conditions))\n      .limit(1);\n\n    return {\n      isDuplicate: existing.length > 0,\n      existingAssessment: existing[0] || null\n    };\n  }\n\n  /**\n   * Check if assessment can be modified (not locked)\n   * @param {object} assessment - The assessment record\n   * @returns {{ canModify: boolean, reason: string|null }}\n   */\n  static checkModificationAllowed(assessment) {\n    const lockedStatuses = ['SIGNED', 'SUBMITTED', 'ACCEPTED', 'LOCKED'];\n\n    if (lockedStatuses.includes(assessment.assessment_status)) {\n      return {\n        canModify: false,\n        reason: {\n          code: 'ASSESSMENT_LOCKED',\n          message: `Assessment is locked with status '${assessment.assessment_status}'. Modifications not allowed after signing/submission.`,\n          cfrReference: '21 CFR Part 11 - Electronic Records'\n        }\n      };\n    }\n\n    // Check if past submission deadline (30 days for most assessments per CMS rules)\n    if (assessment.due_date) {\n      const dueDate = new Date(assessment.due_date);\n      const now = new Date();\n      const gracePeriodDays = 30; // CMS allows 30-day grace period\n      dueDate.setDate(dueDate.getDate() + gracePeriodDays);\n\n      if (now > dueDate) {\n        return {\n          canModify: false,\n          reason: {\n            code: 'SUBMISSION_WINDOW_CLOSED',\n            message: `Submission window has closed. Due date was ${assessment.due_date} with 30-day grace period.`,\n            cfrReference: '42 CFR Â§ 418.54'\n          }\n        };\n      }\n    }\n\n    return { canModify: true, reason: null };\n  }\n}\n\n/**\n * Create an audit log entry for assessment state changes\n * @param {object} params - Audit log parameters\n */\nasync function createAuditLog({ userId, sessionId, action, resourceType, resourceId, oldValue, newValue, status, ipAddress, userAgent, metadata }) {\n  try {\n    await db.insert(audit_logs).values({\n      user_id: userId,\n      session_id: sessionId,\n      action,\n      resource_type: resourceType,\n      resource_id: resourceId?.toString(),\n      old_value: oldValue ? JSON.stringify(oldValue) : null,\n      new_value: newValue ? JSON.stringify(newValue) : null,\n      status: status || 'success',\n      ip_address: ipAddress,\n      user_agent: userAgent,\n      metadata: metadata ? JSON.stringify(metadata) : null\n    });\n  } catch (error) {\n    logger.error('Failed to create audit log:', error);\n    // Don't throw - audit log failure shouldn't break the main operation\n  }\n}\n\n/**\n * HOPE Assessment Controller\n * Manages Hospice Outcomes & Patient Evaluation (HOPE) assessments\n * Critical: Non-compliance can result in 4% Medicare payment reduction\n *\n * CMS References:\n * - 42 CFR Â§ 418.54 - Condition of Participation: Initial and Comprehensive Assessment\n * - 42 CFR Â§ 418.56 - Condition of Participation: Hospice Aide and Homemaker Services\n * - 42 CFR Â§ 418.58 - Condition of Participation: Quality Assessment and Performance Improvement\n * - 42 CFR Â§ 418.76 - Condition of Participation: Hospice Care Team\n * - 21 CFR Part 11 - Electronic Records; Electronic Signatures\n */\nclass HOPEAssessmentController {"
}

Now let me update the `createAdmissionAssessment` method to include the validation logic:

ðŸ”§ Tool: Edit
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js",
  "old_string": "  /**\n   * Create admission assessment (within 5 days of admission)\n   * POST /patients/:id/hope-assessments/admission\n   */\n  async createAdmissionAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      // Calculate due date (5 days from admission)\n      const admissionDate = new Date();\n      const dueDate = new Date(admissionDate);\n      dueDate.setDate(dueDate.getDate() + 5);\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: 'ADMISSION',\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: admissionDate,\n          due_date: dueDate,\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Admission assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating admission assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }",
  "new_string": "  /**\n   * Create admission assessment (within 5 days of admission)\n   * POST /patients/:id/hope-assessments/admission\n   *\n   * CMS Reference: 42 CFR Â§ 418.54(a) - Initial assessment within 5 days\n   */\n  async createAdmissionAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'ADMISSION';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      // Calculate due date (5 days from admission)\n      const admissionDate = data.a0220_admission_date ? new Date(data.a0220_admission_date) : new Date();\n      const assessmentDate = new Date();\n      const dueDate = new Date(admissionDate);\n      dueDate.setDate(dueDate.getDate() + 5);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `An ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Validate assessment timing\n      const timingValidation = CMSValidationService.validateTiming(\n        assessmentType,\n        assessmentDate,\n        admissionDate\n      );\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0220_admission_date: admissionDate,\n          a0200_assessment_type_code: '01', // 01 = Admission\n          a0250_assessment_reason: '01', // 01 = Admission\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType, cmsCompliant: timingValidation.valid }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Admission assessment created',\n        data: result[0],\n        validation: {\n          timingWarnings: timingValidation.warnings,\n          timingErrors: timingValidation.errors\n        }\n      };\n    } catch (error) {\n      logger.error('Error creating admission assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }"
}

Now let me update the other creation methods (HUV1, HUV2, Discharge, SFV) with similar validation logic. Let me also add the update method with proper locking and the delete endpoint.

ðŸ”§ Tool: Edit
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js",
  "old_string": "  /**\n   * Create HUV1 assessment (days 6-15 after admission)\n   * POST /patients/:id/hope-assessments/huv1\n   */\n  async createHUV1Assessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      // Calculate due date (day 6-15 after admission)\n      const assessmentDate = new Date();\n      const dueDate = new Date(assessmentDate);\n      dueDate.setDate(dueDate.getDate() + 9); // Day 15 is the deadline\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: 'HUV1',\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'HUV1 assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating HUV1 assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create HUV2 assessment (days 16-30 after admission)\n   * POST /patients/:id/hope-assessments/huv2\n   */\n  async createHUV2Assessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      // Calculate due date (day 16-30 after admission)\n      const assessmentDate = new Date();\n      const dueDate = new Date(assessmentDate);\n      dueDate.setDate(dueDate.getDate() + 14); // Day 30 is the deadline\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: 'HUV2',\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'HUV2 assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating HUV2 assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create discharge assessment\n   * POST /patients/:id/hope-assessments/discharge\n   */\n  async createDischargeAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      const assessmentDate = new Date();\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: 'DISCHARGE',\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Discharge assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating discharge assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create symptom follow-up visit (within 48hrs of moderate/severe symptoms)\n   * POST /patients/:id/hope-assessments/sfv\n   */\n  async createSFVAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      // Calculate due date (48 hours from symptom occurrence)\n      const assessmentDate = new Date();\n      const dueDate = new Date(assessmentDate);\n      dueDate.setHours(dueDate.getHours() + 48);\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: 'SYMPTOM_FOLLOWUP',\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          sfv_triggered: true,\n          sfv_trigger_date: data.sfv_trigger_date || assessmentDate,\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Symptom follow-up assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating SFV assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }",
  "new_string": "  /**\n   * Create HUV1 assessment (days 6-15 after admission)\n   * POST /patients/:id/hope-assessments/huv1\n   *\n   * CMS Reference: 42 CFR Â§ 418.54 - HOPE Update Visit 1\n   */\n  async createHUV1Assessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'HUV1';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      const assessmentDate = new Date();\n      const admissionDate = data.a0220_admission_date ? new Date(data.a0220_admission_date) : null;\n\n      // Calculate due date (day 15 after admission)\n      const dueDate = admissionDate ? new Date(admissionDate) : new Date(assessmentDate);\n      dueDate.setDate(dueDate.getDate() + 15);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `An ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Validate assessment timing\n      const timingValidation = CMSValidationService.validateTiming(\n        assessmentType,\n        assessmentDate,\n        admissionDate\n      );\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0200_assessment_type_code: '02', // 02 = HUV\n          a0250_assessment_reason: '02', // 02 = Scheduled\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType, cmsCompliant: timingValidation.valid }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'HUV1 assessment created',\n        data: result[0],\n        validation: {\n          timingWarnings: timingValidation.warnings,\n          timingErrors: timingValidation.errors\n        }\n      };\n    } catch (error) {\n      logger.error('Error creating HUV1 assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create HUV2 assessment (days 16-30 after admission)\n   * POST /patients/:id/hope-assessments/huv2\n   *\n   * CMS Reference: 42 CFR Â§ 418.54 - HOPE Update Visit 2\n   */\n  async createHUV2Assessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'HUV2';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      const assessmentDate = new Date();\n      const admissionDate = data.a0220_admission_date ? new Date(data.a0220_admission_date) : null;\n\n      // Calculate due date (day 30 after admission)\n      const dueDate = admissionDate ? new Date(admissionDate) : new Date(assessmentDate);\n      dueDate.setDate(dueDate.getDate() + 30);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `An ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Validate assessment timing\n      const timingValidation = CMSValidationService.validateTiming(\n        assessmentType,\n        assessmentDate,\n        admissionDate\n      );\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0200_assessment_type_code: '02', // 02 = HUV\n          a0250_assessment_reason: '02', // 02 = Scheduled\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType, cmsCompliant: timingValidation.valid }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'HUV2 assessment created',\n        data: result[0],\n        validation: {\n          timingWarnings: timingValidation.warnings,\n          timingErrors: timingValidation.errors\n        }\n      };\n    } catch (error) {\n      logger.error('Error creating HUV2 assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create discharge assessment\n   * POST /patients/:id/hope-assessments/discharge\n   *\n   * CMS Reference: 42 CFR Â§ 418.54 - Discharge assessment within 2 days\n   */\n  async createDischargeAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'DISCHARGE';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      const assessmentDate = new Date();\n      const dischargeDate = data.a0270_discharge_date ? new Date(data.a0270_discharge_date) : assessmentDate;\n\n      // Calculate due date (2 days from discharge)\n      const dueDate = new Date(dischargeDate);\n      dueDate.setDate(dueDate.getDate() + 2);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `A ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0270_discharge_date: dischargeDate,\n          a0200_assessment_type_code: '09', // 09 = Discharge\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Discharge assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating discharge assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create transfer assessment\n   * POST /patients/:id/hope-assessments/transfer\n   *\n   * CMS Reference: 42 CFR Â§ 418.54 - Transfer assessment within 2 days\n   */\n  async createTransferAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'TRANSFER';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      const assessmentDate = new Date();\n      const transferDate = data.a0270_discharge_date ? new Date(data.a0270_discharge_date) : assessmentDate;\n\n      // Calculate due date (2 days from transfer)\n      const dueDate = new Date(transferDate);\n      dueDate.setDate(dueDate.getDate() + 2);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `A ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0270_discharge_date: transferDate,\n          a0200_assessment_type_code: '06', // 06 = Transfer\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Transfer assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating transfer assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create resumption of care assessment\n   * POST /patients/:id/hope-assessments/resumption\n   *\n   * CMS Reference: 42 CFR Â§ 418.54 - Resumption assessment within 5 days\n   */\n  async createResumptionAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'RESUMPTION';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      const assessmentDate = new Date();\n      const resumptionDate = data.resumption_date ? new Date(data.resumption_date) : assessmentDate;\n\n      // Calculate due date (5 days from resumption)\n      const dueDate = new Date(resumptionDate);\n      dueDate.setDate(dueDate.getDate() + 5);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `A ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0200_assessment_type_code: '04', // 04 = Resumption of care\n          a0250_assessment_reason: '03', // 03 = Unscheduled\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Resumption of care assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating resumption assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create recertification assessment\n   * POST /patients/:id/hope-assessments/recertification\n   *\n   * CMS Reference: 42 CFR Â§ 418.54 - Recertification assessment within 5 days\n   */\n  async createRecertificationAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'RECERTIFICATION';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      const assessmentDate = new Date();\n      const recertDate = data.recertification_date ? new Date(data.recertification_date) : assessmentDate;\n\n      // Calculate due date (5 days from recertification)\n      const dueDate = new Date(recertDate);\n      dueDate.setDate(dueDate.getDate() + 5);\n\n      // Check for duplicate assessment\n      const duplicateCheck = await CMSValidationService.checkDuplicateAssessment(\n        parseInt(id),\n        assessmentType,\n        assessmentDate\n      );\n      if (duplicateCheck.isDuplicate) {\n        reply.code(409);\n        return {\n          status: 409,\n          message: 'Duplicate assessment exists for this patient and time period',\n          error: {\n            code: 'DUPLICATE_ASSESSMENT',\n            existingAssessmentId: duplicateCheck.existingAssessment?.id,\n            message: `A ${assessmentType} assessment already exists for this patient on this date`\n          }\n        };\n      }\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          a0200_assessment_type_code: '05', // 05 = Recertification\n          a0250_assessment_reason: '02', // 02 = Scheduled\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Recertification assessment created',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error creating recertification assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Create symptom follow-up visit (within 48hrs of moderate/severe symptoms)\n   * POST /patients/:id/hope-assessments/sfv\n   *\n   * CMS Reference: 42 CFR Â§ 418.56 - SFV within 48 hours of symptom report\n   */\n  async createSFVAssessment(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n      const assessmentType = 'SYMPTOM_FOLLOWUP';\n\n      // Validate clinician authorization\n      const authCheck = CMSValidationService.validateClinicianAuthorization(\n        assessmentType,\n        request.user?.role\n      );\n      if (!authCheck.authorized) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Not authorized to create this assessment type',\n          error: authCheck.error\n        };\n      }\n\n      // Validate that trigger symptoms are provided\n      if (!data.sfv_trigger_symptoms) {\n        reply.code(400);\n        return {\n          status: 400,\n          message: 'SFV trigger symptoms are required',\n          error: {\n            code: 'MISSING_SFV_TRIGGER',\n            message: 'Symptom follow-up visits require documentation of the triggering symptoms',\n            cfrReference: '42 CFR Â§ 418.56'\n          }\n        };\n      }\n\n      // Calculate due date (48 hours from symptom occurrence)\n      const assessmentDate = new Date();\n      const triggerDate = data.sfv_trigger_date ? new Date(data.sfv_trigger_date) : assessmentDate;\n      const dueDate = new Date(triggerDate);\n      dueDate.setHours(dueDate.getHours() + 48);\n\n      // Validate timing\n      const timingValidation = CMSValidationService.validateTiming(\n        assessmentType,\n        assessmentDate,\n        null,\n        triggerDate\n      );\n\n      // Set reference date if not provided\n      const referenceDate = data.a0310_assessment_reference_date || assessmentDate;\n\n      const result = await db\n        .insert(hope_assessments)\n        .values({\n          patient_id: parseInt(id),\n          assessment_type: assessmentType,\n          assessment_status: data.assessment_status || 'IN_PROGRESS',\n          assessment_date: assessmentDate,\n          due_date: dueDate,\n          a0310_assessment_reference_date: referenceDate,\n          sfv_triggered: true,\n          sfv_trigger_date: triggerDate,\n          sfv_due_date: dueDate,\n          a0250_assessment_reason: '03', // 03 = Unscheduled\n          ...data,\n          created_by_id: request.user?.id,\n          updated_by_id: request.user?.id\n        })\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'CREATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: result[0].id,\n        newValue: { assessment_type: assessmentType, patient_id: id, sfv_trigger_symptoms: data.sfv_trigger_symptoms },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { assessmentType, cmsCompliant: timingValidation.valid }\n      });\n\n      reply.code(201);\n      return {\n        status: 201,\n        message: 'Symptom follow-up assessment created',\n        data: result[0],\n        validation: {\n          timingWarnings: timingValidation.warnings,\n          timingErrors: timingValidation.errors\n        }\n      };\n    } catch (error) {\n      logger.error('Error creating SFV assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error creating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }"
}

Now I need to update the `update` method with proper locking logic and add a `delete` method. Let me find and update the update method:

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js",
  "offset": 1400,
  "limit": 200
}

ðŸ”§ Tool: Edit
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/controllers/HOPEAssessment.controller.js",
  "old_string": "  /**\n   * Update assessment\n   * PATCH /hope-assessments/:id\n   */\n  async update(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      // Check if assessment exists\n      const existing = await db\n        .select({\n          id: hope_assessments.id,\n          patient_id: hope_assessments.patient_id,\n          assessment_type: hope_assessments.assessment_type,\n          assessment_status: hope_assessments.assessment_status,\n          assessment_date: hope_assessments.assessment_date,\n          due_date: hope_assessments.due_date,\n          completed_date: hope_assessments.completed_date,\n          patient_age: hope_assessments.patient_age,\n          patient_gender: hope_assessments.patient_gender,\n          patient_race: hope_assessments.patient_race,\n          patient_ethnicity: hope_assessments.patient_ethnicity,\n          primary_diagnosis: hope_assessments.primary_diagnosis,\n          caregiver_available: hope_assessments.caregiver_available,\n          caregiver_relationship: hope_assessments.caregiver_relationship,\n          caregiver_assessment: hope_assessments.caregiver_assessment,\n          caregiver_hours_per_week: hope_assessments.caregiver_hours_per_week,\n          functional_self_care: hope_assessments.functional_self_care,\n          functional_mobility: hope_assessments.functional_mobility,\n          cognitive_status: hope_assessments.cognitive_status,\n          bims_score: hope_assessments.bims_score,\n          bims_details: hope_assessments.bims_details,\n          phq2_little_interest: hope_assessments.phq2_little_interest,\n          phq2_feeling_down: hope_assessments.phq2_feeling_down,\n          phq2_total_score: hope_assessments.phq2_total_score,\n          pain_present: hope_assessments.pain_present,\n          pain_severity: hope_assessments.pain_severity,\n          pain_frequency: hope_assessments.pain_frequency,\n          pain_interference: hope_assessments.pain_interference,\n          symptoms: hope_assessments.symptoms,\n          sfv_triggered: hope_assessments.sfv_triggered,\n          sfv_trigger_date: hope_assessments.sfv_trigger_date,\n          sfv_trigger_symptoms: hope_assessments.sfv_trigger_symptoms,\n          spiritual_assessment: hope_assessments.spiritual_assessment,\n          cultural_assessment: hope_assessments.cultural_assessment,\n          social_assessment: hope_assessments.social_assessment,\n          safety_assessment: hope_assessments.safety_assessment,\n          environment_assessment: hope_assessments.environment_assessment,\n          goals_of_care: hope_assessments.goals_of_care,\n          advance_directives_status: hope_assessments.advance_directives_status,\n          code_status: hope_assessments.code_status,\n          clinical_notes: hope_assessments.clinical_notes,\n          recommendations: hope_assessments.recommendations,\n          signature: hope_assessments.signature,\n          submitted_to_iqies: hope_assessments.submitted_to_iqies,\n          submission_id: hope_assessments.submission_id,\n          submission_date: hope_assessments.submission_date,\n          created_by_id: hope_assessments.created_by_id,\n          updated_by_id: hope_assessments.updated_by_id,\n          createdAt: hope_assessments.createdAt,\n          updatedAt: hope_assessments.updatedAt\n        })\n        .from(hope_assessments)\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .limit(1);\n\n      if (!existing[0]) {\n        reply.code(404);\n        return {\n          status: 404,\n          message: 'Assessment not found'\n        };\n      }\n\n      // Don't allow updates to signed assessments\n      if (existing[0].assessment_status === 'SIGNED' || existing[0].assessment_status === 'SUBMITTED') {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Cannot update signed or submitted assessments'\n        };\n      }\n\n      const result = await db\n        .update(hope_assessments)\n        .set({\n          ...data,\n          updated_by_id: request.user?.id,\n          updatedAt: new Date()\n        })\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .returning();\n\n      reply.code(200);\n      return {\n        status: 200,\n        message: 'Assessment updated',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error updating assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error updating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }",
  "new_string": "  /**\n   * Update assessment\n   * PATCH /hope-assessments/:id\n   *\n   * CMS Reference: 21 CFR Part 11 - Electronic Records (locking after signature)\n   */\n  async update(request, reply) {\n    try {\n      const { id } = request.params;\n      const data = request.body;\n\n      // Check if assessment exists\n      const existing = await db\n        .select({\n          id: hope_assessments.id,\n          patient_id: hope_assessments.patient_id,\n          assessment_type: hope_assessments.assessment_type,\n          assessment_status: hope_assessments.assessment_status,\n          assessment_date: hope_assessments.assessment_date,\n          due_date: hope_assessments.due_date,\n          i0010_principal_diagnosis_icd10: hope_assessments.i0010_principal_diagnosis_icd10,\n          deleted_at: hope_assessments.deleted_at\n        })\n        .from(hope_assessments)\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .limit(1);\n\n      if (!existing[0]) {\n        reply.code(404);\n        return {\n          status: 404,\n          message: 'Assessment not found'\n        };\n      }\n\n      // Check if deleted (soft delete)\n      if (existing[0].deleted_at) {\n        reply.code(404);\n        return {\n          status: 404,\n          message: 'Assessment has been deleted'\n        };\n      }\n\n      // Use CMS validation service to check if modification is allowed\n      const modCheck = CMSValidationService.checkModificationAllowed(existing[0]);\n      if (!modCheck.canModify) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Assessment cannot be modified',\n          error: modCheck.reason\n        };\n      }\n\n      // Validate ICD-10 code if provided\n      if (data.i0010_principal_diagnosis_icd10) {\n        const icd10Validation = CMSValidationService.validateICD10Code(data.i0010_principal_diagnosis_icd10);\n        if (!icd10Validation.valid) {\n          reply.code(400);\n          return {\n            status: 400,\n            message: 'Invalid ICD-10 code format',\n            error: icd10Validation.error\n          };\n        }\n      }\n\n      // Store old values for audit log\n      const oldValues = { ...existing[0] };\n\n      const result = await db\n        .update(hope_assessments)\n        .set({\n          ...data,\n          updated_by_id: request.user?.id,\n          updatedAt: new Date()\n        })\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'UPDATE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: id,\n        oldValue: oldValues,\n        newValue: data,\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent']\n      });\n\n      reply.code(200);\n      return {\n        status: 200,\n        message: 'Assessment updated',\n        data: result[0]\n      };\n    } catch (error) {\n      logger.error('Error updating assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error updating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Delete assessment (soft delete)\n   * DELETE /hope-assessments/:id\n   *\n   * CMS Reference: 42 CFR Â§ 418.310 - Record retention requirements\n   * Note: Assessments are soft-deleted to maintain audit trail\n   */\n  async delete(request, reply) {\n    try {\n      const { id } = request.params;\n\n      // Check if assessment exists\n      const existing = await db\n        .select({\n          id: hope_assessments.id,\n          patient_id: hope_assessments.patient_id,\n          assessment_type: hope_assessments.assessment_type,\n          assessment_status: hope_assessments.assessment_status,\n          deleted_at: hope_assessments.deleted_at\n        })\n        .from(hope_assessments)\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .limit(1);\n\n      if (!existing[0]) {\n        reply.code(404);\n        return {\n          status: 404,\n          message: 'Assessment not found'\n        };\n      }\n\n      // Already deleted\n      if (existing[0].deleted_at) {\n        reply.code(404);\n        return {\n          status: 404,\n          message: 'Assessment has already been deleted'\n        };\n      }\n\n      // Cannot delete signed or submitted assessments per 21 CFR Part 11\n      const protectedStatuses = ['SIGNED', 'SUBMITTED', 'ACCEPTED'];\n      if (protectedStatuses.includes(existing[0].assessment_status)) {\n        reply.code(403);\n        return {\n          status: 403,\n          message: 'Cannot delete signed or submitted assessments',\n          error: {\n            code: 'DELETE_PROTECTED',\n            message: `Assessments with status '${existing[0].assessment_status}' are protected and cannot be deleted per 21 CFR Part 11`,\n            cfrReference: '21 CFR Part 11 - Electronic Records'\n          }\n        };\n      }\n\n      // Perform soft delete\n      const result = await db\n        .update(hope_assessments)\n        .set({\n          deleted_at: new Date(),\n          assessment_status: 'LOCKED',\n          z0300_record_status: 'INACTIVE',\n          z0300_inactivation_reason: `Deleted by user ${request.user?.id} on ${new Date().toISOString()}`,\n          updated_by_id: request.user?.id,\n          updatedAt: new Date()\n        })\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .returning();\n\n      // Create audit log entry\n      await createAuditLog({\n        userId: request.user?.id,\n        action: 'DELETE_HOPE_ASSESSMENT',\n        resourceType: 'hope_assessment',\n        resourceId: id,\n        oldValue: { assessment_status: existing[0].assessment_status },\n        newValue: { deleted: true, assessment_status: 'LOCKED' },\n        status: 'success',\n        ipAddress: request.ip,\n        userAgent: request.headers['user-agent'],\n        metadata: { softDelete: true }\n      });\n\n      reply.code(200);\n      return {\n        status: 200,\n        message: 'Assessment deleted successfully',\n        data: {\n          id: result[0].id,\n          deleted_at: result[0].deleted_at\n        }\n      };\n    } catch (error) {\n      logger.error('Error deleting assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error deleting assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }\n\n  /**\n   * Validate assessment for CMS compliance\n   * POST /hope-assessments/:id/validate\n   *\n   * Runs all CMS validation checks and returns detailed results\n   */\n  async validate(request, reply) {\n    try {\n      const { id } = request.params;\n\n      const existing = await db\n        .select()\n        .from(hope_assessments)\n        .where(eq(hope_assessments.id, parseInt(id)))\n        .limit(1);\n\n      if (!existing[0]) {\n        reply.code(404);\n        return {\n          status: 404,\n          message: 'Assessment not found'\n        };\n      }\n\n      const assessment = existing[0];\n      const validationResults = {\n        isValid: true,\n        errors: [],\n        warnings: [],\n        cmsCompliant: true\n      };\n\n      // Validate required fields\n      const fieldValidation = CMSValidationService.validateRequiredFields(\n        assessment.assessment_type,\n        assessment\n      );\n      if (!fieldValidation.valid) {\n        validationResults.isValid = false;\n        validationResults.errors.push(...fieldValidation.errors);\n      }\n\n      // Validate ICD-10 code\n      if (assessment.i0010_principal_diagnosis_icd10) {\n        const icd10Validation = CMSValidationService.validateICD10Code(\n          assessment.i0010_principal_diagnosis_icd10\n        );\n        if (!icd10Validation.valid) {\n          validationResults.errors.push(icd10Validation.error);\n          validationResults.isValid = false;\n        }\n      }\n\n      // Validate timing\n      const timingValidation = CMSValidationService.validateTiming(\n        assessment.assessment_type,\n        assessment.assessment_date,\n        assessment.a0220_admission_date,\n        assessment.a0270_discharge_date || assessment.sfv_trigger_date\n      );\n      if (!timingValidation.valid) {\n        validationResults.errors.push(...timingValidation.errors);\n        validationResults.cmsCompliant = false;\n      }\n      if (timingValidation.warnings.length > 0) {\n        validationResults.warnings.push(...timingValidation.warnings);\n      }\n\n      // Check modification status\n      const modCheck = CMSValidationService.checkModificationAllowed(assessment);\n      if (!modCheck.canModify) {\n        validationResults.warnings.push({\n          code: 'LOCKED_FOR_MODIFICATION',\n          message: 'Assessment is locked and cannot be modified',\n          reason: modCheck.reason\n        });\n      }\n\n      reply.code(200);\n      return {\n        status: 200,\n        message: validationResults.isValid ? 'Assessment is valid' : 'Assessment has validation errors',\n        data: validationResults\n      };\n    } catch (error) {\n      logger.error('Error validating assessment:', error)\n      reply.code(500);\n      return {\n        status: 500,\n        message: 'Error validating assessment',\n        error: process.env.NODE_ENV === 'development' ? error.message : undefined\n      };\n    }\n  }"
}

Now let me update the routes to add the new endpoints (delete, validate, transfer, resumption, recertification):

ðŸ”§ Tool: Edit
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/services/api/src/routes/hopeAssessment.routes.js",
  "old_string": "import controller from '../controllers/HOPEAssessment.controller.js';\nimport { PERMISSIONS } from '../config/rbac.js';\nimport { requireAnyPermission } from '../middleware/rbac.middleware.js';\n\n/**\n * HOPE Assessment Routes\n * Hospice Outcomes & Patient Evaluation (HOPE) - CMS requirement\n * Critical: Non-compliance can result in 4% Medicare payment reduction\n */\nexport default async function hopeAssessmentRoutes(fastify, options) {\n  // Patient-specific assessment routes\n  fastify.get('/patients/:id/hope-assessments', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_PATIENT, PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.getPatientAssessments);\n\n  fastify.post('/patients/:id/hope-assessments/admission', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createAdmissionAssessment);\n\n  fastify.post('/patients/:id/hope-assessments/huv1', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createHUV1Assessment);\n\n  fastify.post('/patients/:id/hope-assessments/huv2', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createHUV2Assessment);\n\n  fastify.post('/patients/:id/hope-assessments/discharge', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createDischargeAssessment);\n\n  fastify.post('/patients/:id/hope-assessments/sfv', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createSFVAssessment);\n\n  // Assessment management routes\n  fastify.get('/hope-assessments/:id', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.show);\n\n  fastify.patch('/hope-assessments/:id', {\n    preHandler: [requireAnyPermission(PERMISSIONS.UPDATE_CLINICAL_NOTES)]\n  }, controller.update);\n\n  fastify.post('/hope-assessments/:id/sign', {\n    preHandler: [requireAnyPermission(PERMISSIONS.UPDATE_CLINICAL_NOTES)]\n  }, controller.sign);\n\n  fastify.post('/hope-assessments/:id/submit', {\n    preHandler: [requireAnyPermission(PERMISSIONS.UPDATE_CLINICAL_NOTES)]\n  }, controller.submit);\n\n  // Query routes\n  fastify.get('/hope-assessments/pending', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.getPending);\n\n  fastify.get('/hope-assessments/overdue', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.getOverdue);\n\n  fastify.get('/hope-assessments/compliance', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_REPORTS)]\n  }, controller.getCompliance);\n}",
  "new_string": "import controller from '../controllers/HOPEAssessment.controller.js';\nimport { PERMISSIONS } from '../config/rbac.js';\nimport { requireAnyPermission } from '../middleware/rbac.middleware.js';\n\n/**\n * HOPE Assessment Routes\n * Hospice Outcomes & Patient Evaluation (HOPE) - CMS requirement\n * Critical: Non-compliance can result in 4% Medicare payment reduction\n *\n * CMS References:\n * - 42 CFR Â§ 418.54 - Condition of Participation: Initial and Comprehensive Assessment\n * - 42 CFR Â§ 418.56 - Condition of Participation: Hospice Aide and Homemaker Services\n * - 42 CFR Â§ 418.58 - Condition of Participation: Quality Assessment and Performance Improvement\n * - 42 CFR Â§ 418.76 - Condition of Participation: Hospice Care Team\n * - 21 CFR Part 11 - Electronic Records; Electronic Signatures\n */\nexport default async function hopeAssessmentRoutes(fastify, options) {\n  // ============================================================================\n  // Query routes (must be registered before parameterized routes)\n  // ============================================================================\n  fastify.get('/hope-assessments/pending', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.getPending);\n\n  fastify.get('/hope-assessments/overdue', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.getOverdue);\n\n  fastify.get('/hope-assessments/compliance', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_REPORTS)]\n  }, controller.getCompliance);\n\n  // ============================================================================\n  // Patient-specific assessment creation routes\n  // ============================================================================\n  fastify.get('/patients/:id/hope-assessments', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_PATIENT, PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.getPatientAssessments);\n\n  // Admission assessment (within 5 days of admission) - RN required\n  fastify.post('/patients/:id/hope-assessments/admission', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createAdmissionAssessment);\n\n  // HUV1 - HOPE Update Visit 1 (days 6-15 after admission)\n  fastify.post('/patients/:id/hope-assessments/huv1', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createHUV1Assessment);\n\n  // HUV2 - HOPE Update Visit 2 (days 16-30 after admission)\n  fastify.post('/patients/:id/hope-assessments/huv2', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createHUV2Assessment);\n\n  // Discharge assessment (within 2 days of discharge)\n  fastify.post('/patients/:id/hope-assessments/discharge', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createDischargeAssessment);\n\n  // Transfer assessment (within 2 days of transfer)\n  fastify.post('/patients/:id/hope-assessments/transfer', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createTransferAssessment);\n\n  // Resumption of care assessment (within 5 days of resumption)\n  fastify.post('/patients/:id/hope-assessments/resumption', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createResumptionAssessment);\n\n  // Recertification assessment (within 5 days of recertification)\n  fastify.post('/patients/:id/hope-assessments/recertification', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createRecertificationAssessment);\n\n  // Symptom Follow-up Visit (within 48 hours of moderate/severe symptom)\n  fastify.post('/patients/:id/hope-assessments/sfv', {\n    preHandler: [requireAnyPermission(PERMISSIONS.CREATE_CLINICAL_NOTES)]\n  }, controller.createSFVAssessment);\n\n  // ============================================================================\n  // Assessment management routes\n  // ============================================================================\n\n  // Get single assessment\n  fastify.get('/hope-assessments/:id', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.show);\n\n  // Update assessment (blocked if signed/submitted per 21 CFR Part 11)\n  fastify.patch('/hope-assessments/:id', {\n    preHandler: [requireAnyPermission(PERMISSIONS.UPDATE_CLINICAL_NOTES)]\n  }, controller.update);\n\n  // Delete assessment (soft delete - blocked if signed/submitted)\n  fastify.delete('/hope-assessments/:id', {\n    preHandler: [requireAnyPermission(PERMISSIONS.DELETE_CLINICAL_NOTES)]\n  }, controller.delete);\n\n  // ============================================================================\n  // Validation and signature routes\n  // ============================================================================\n\n  // Validate assessment for CMS compliance\n  fastify.post('/hope-assessments/:id/validate', {\n    preHandler: [requireAnyPermission(PERMISSIONS.VIEW_CLINICAL_NOTES)]\n  }, controller.validate);\n\n  // Sign assessment (21 CFR Part 11 compliant electronic signature)\n  fastify.post('/hope-assessments/:id/sign', {\n    preHandler: [requireAnyPermission(PERMISSIONS.UPDATE_CLINICAL_NOTES)]\n  }, controller.sign);\n\n  // Submit assessment to CMS iQIES system\n  fastify.post('/hope-assessments/:id/submit', {\n    preHandler: [requireAnyPermission(PERMISSIONS.UPDATE_CLINICAL_NOTES)]\n  }, controller.submit);\n}"
}

Now let me update the todo list and create a Playwright verification test:

ðŸ”§ Tool: TodoWrite
Input: {
  "todos": [
    {
      "content": "Explore codebase to understand existing patterns",
      "status": "completed",
      "activeForm": "Exploring codebase structure"
    },
    {
      "content": "Add CMS compliance validation rules for HOPE assessments",
      "status": "completed",
      "activeForm": "Adding CMS compliance validation"
    },
    {
      "content": "Add duplicate assessment prevention",
      "status": "completed",
      "activeForm": "Adding duplicate assessment prevention"
    },
    {
      "content": "Add assessment locking after submission deadlines",
      "status": "completed",
      "activeForm": "Adding assessment locking logic"
    },
    {
      "content": "Add role-based access for clinician types",
      "status": "completed",
      "activeForm": "Adding role-based access checks"
    },
    {
      "content": "Add delete endpoint with soft delete",
      "status": "completed",
      "activeForm": "Adding delete endpoint"
    },
    {
      "content": "Verify implementation with Playwright test",
      "status": "in_progress",
      "activeForm": "Verifying with Playwright test"
    }
  ]
}

Now let me create a Playwright verification test. First, let me check the existing test patterns in the project:

ðŸ”§ Tool: Read
Input: {
  "file_path": "/Users/fabrice/Sites/chartwarden/Chartwarden/apps/web/tests/better-auth-verification.spec.ts",
  "limit": 100
}

Now let me create a verification test for the HOPE Assessment Controller: